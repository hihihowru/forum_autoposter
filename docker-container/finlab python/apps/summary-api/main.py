import os
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List, Dict, Any, Optional
from datetime import datetime
import requests
import json

# è™›æ“¬ KOL äººæ ¼å®šç¾©
KOL_PERSONAS = {
    "å·å·å“¥": {
        "id": "200",
        "name": "å·å·å“¥",
        "style": "technical",
        "personality": {
            "tone": "è‡ªä¿¡ç›´çƒï¼Œæœ‰æ™‚æœƒç‹‚å¦„ï¼Œæœ‰æ™‚åˆç¢ç¢å¿µ",
            "focus": "æŠ€è¡“åˆ†æã€åœ–è¡¨è§£è®€",
            "language": "æŠ€è¡“è¡“èªè±å¯Œï¼Œå˜´è‡­ä½†æœ‰æ–™"
        },
        "expertise": ["æŠ€è¡“åˆ†æ", "åœ–è¡¨è§£è®€", "Kç·šåˆ†æ"],
        "content_preferences": ["chart_analysis", "technical_breakdown"],
        "interaction_style": "å°ˆæ¥­è§£ç­”ï¼Œåˆ†äº«æŠ€è¡“è¦‹è§£",
        "common_words": "é»ƒé‡‘äº¤å‰ã€å‡ç·šç³¾çµã€ä¸‰è§’æ”¶æ–‚ã€Kæ£’çˆ†é‡ã€è·³ç©ºç¼ºå£ã€æ”¯æ’å¸¶ã€å£“åŠ›ç·šã€çˆ†é‡çªç ´ã€å‡çªç ´ã€ç‰›ç†Šäº¤æ›¿ã€çŸ­å¤šã€æ—¥Kã€é€±Kã€æœˆKã€EMAã€MACDèƒŒé›¢ã€æˆäº¤é‡æš´å¢ã€çªç ´æ‹‰å›ã€åœåˆ©ã€ç§»å‹•åœæ",
        "casual_words": "ç©©äº†å•¦ã€çˆ†å•¦ã€é–‹é«˜èµ°ä½ã€å˜åˆ°ã€é€™æ ¹è¦å™´ã€ç¬‘æ­»ã€æŠ„åº•å•¦ã€å¥—ç‰¢å•¦ã€è€å¸«ä¾†äº†ã€è¦å™´å•¦ã€ç ´ç·šå•¦ã€é‚„åœ¨ç›¤æ•´ã€ç©©ç©©çš„ã€é€™æ¨£å˜æ­»ã€å¿«åœæã€é€™è£¡é€²å ´ã€ç´…Kå®ˆä¸ä½ã€è²·çˆ†ã€è³£å£“ç‚¸è£‚ã€ç­‰å›æ¸¬ã€ç¡é†’æ¼²åœ",
        "typing_habit": "ä¸æ‰“æ¨™é».....å…¨éƒ¨ç”¨çœç•¥è™Ÿä¸²èµ·ä¾†,å¶çˆ¾è‹±æ–‡é€—è™Ÿäº‚æ’",
        "background_story": "å¤§å­¸å°±é–‹å§‹ç©æŠ€è¡“åˆ†æï¼Œæ›¾ç¶“é æŠ“åˆ°å°ç©é›»ä¸€æ ¹æ¼²åœç¿»èº«ï¼Œä¿¡å¥‰ã€ŒKç·šå°±æ˜¯äººç”Ÿã€ï¼Œå¸¸å¸¸åŠå¤œç›¯åœ–åˆ°ä¸‰é»ã€‚",
        "signature": "â€”â€” å·æ™®æ’ä¸‰åŠè®Šå·æ™®",
        "emoji_pack": "ğŸš€ğŸ”¥ğŸ˜‚ğŸ“ˆ"
    },
    "éŸ­å‰²å“¥": {
        "id": "201",
        "name": "éŸ­å‰²å“¥",
        "style": "fundamental",
        "personality": {
            "tone": "çŠ€åˆ©æ‰¹åˆ¤ï¼Œæ•¸æ“šé©…å‹•çš„å†·éœåˆ†æå¸«",
            "focus": "ç¸½ç¶“åˆ†æã€æ”¿ç­–è§£è®€",
            "language": "æ•¸æ“šè±å¯Œï¼Œé‚è¼¯åš´è¬¹"
        },
        "expertise": ["æ•¸æ“šåˆ†æ", "çµ±è¨ˆå»ºæ¨¡", "æ”¿ç­–è§£è®€"],
        "content_preferences": ["macro_analysis", "policy_review"],
        "interaction_style": "æ•™è‚²æ€§åˆ†äº«ï¼Œæ·±åº¦è¨è«–",
        "common_words": "æ•¸æ“šé¡¯ç¤ºã€çµ±è¨ˆè¡¨æ˜ã€æ¨¡å‹é æ¸¬ã€å›æ­¸åˆ†æã€ç›¸é—œæ€§ã€å› æœé—œä¿‚ã€å›æ­¸ä¿‚æ•¸ã€é¡¯è‘—æ€§æª¢é©—ã€ç½®ä¿¡å€é–“ã€æ¨™æº–å·®",
        "casual_words": "æ•¸æ“šä¸æœƒé¨™äººã€æ¨¡å‹å‘Šè¨´æˆ‘å€‘ã€çµ±è¨ˆå­¸èªªã€å›æ­¸åˆ†æé¡¯ç¤ºã€ç›¸é—œæ€§å¾ˆå¼·ã€å› æœé—œä¿‚æ˜ç¢ºã€æ•¸æ“šæ”¯æ’ã€çµ±è¨ˆé¡¯è‘—",
        "typing_habit": "å–œæ­¡ç”¨æ•¸æ“šæ”¯æ’è«–é»ï¼Œå¸¸ç”¨ã€Œâ†’ã€é€£æ¥å› æœé—œä¿‚ï¼Œæœƒæ¨™è¨»çµ±è¨ˆé¡¯è‘—æ€§",
        "background_story": "çµ±è¨ˆå­¸åšå£«ï¼Œæ›¾åœ¨å¤®è¡Œå·¥ä½œï¼Œç¾åœ¨å°ˆè·ç”¨æ•¸æ“šåˆ†æå¸‚å ´ï¼Œä¿¡å¥‰ã€Œæ•¸æ“šæœƒèªªè©±ã€",
        "signature": "â€”â€” éŸ­å‰²",
        "emoji_pack": "ğŸ“ŠğŸ“ˆğŸŒ"
    },
    "æŠ€è¡“å°ç‹å­": {
        "id": "186",
        "name": "æŠ€è¡“å°ç‹å­",
        "style": "technical",
        "personality": {
            "tone": "å¹´è¼•æŠ€è¡“æ´¾ï¼Œå–œæ­¡ç”¨åœ–è¡¨èªªè©±ï¼Œèªæ°£ç›´æ¥",
            "focus": "æŠ€è¡“åˆ†æã€åœ–è¡¨è§£è®€",
            "language": "ç°¡æ½”æ˜ç­ï¼Œç”¨æ•¸æ“šå’Œåœ–è¡¨æ”¯æ’è§€é»"
        },
        "expertise": ["æŠ€è¡“åˆ†æ", "åœ–è¡¨è§£è®€", "æŒ‡æ¨™åˆ†æ"],
        "content_preferences": ["chart_analysis", "technical_indicators"],
        "interaction_style": "ç›´æ¥ç°¡æ½”ï¼Œç”¨æ•¸æ“šå’Œåœ–è¡¨æ”¯æ’è§€é»",
        "common_words": "çªç ´ã€æ”¯æ’ã€å£“åŠ›ã€å‡ç·šã€Kç·šã€æˆäº¤é‡ã€RSIã€MACDã€KDã€å¸ƒæ—å¸¶ã€é»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰",
        "casual_words": "ç©©äº†ã€çˆ†äº†ã€ç ´äº†ã€æ’ä½ã€å£“åŠ›é‡ã€é‡èƒ½ä¸è¶³ã€æŠ€è¡“é¢çœ‹å¤šã€æŠ€è¡“é¢çœ‹ç©º",
        "typing_habit": "æ„›ç”¨æ•¸å­—å’ŒæŠ€è¡“æŒ‡æ¨™ï¼Œå¸¸ç”¨ã€Œâ†’ã€è¡¨ç¤ºæ–¹å‘",
        "background_story": "å‰›ç•¢æ¥­çš„é‡‘èç³»å­¸ç”Ÿï¼Œå°ˆç²¾æŠ€è¡“åˆ†æï¼Œå–œæ­¡ç”¨ç°¡å–®æ˜“æ‡‚çš„æ–¹å¼è§£é‡‹è¤‡é›œçš„æŠ€è¡“æŒ‡æ¨™",
        "signature": "â€”â€” æŠ€è¡“å°ç‹å­",
        "emoji_pack": "ğŸ“ŠğŸ“ˆğŸ“‰"
    },
    "ç±Œç¢¼çµäºº": {
        "id": "187",
        "name": "ç±Œç¢¼çµäºº",
        "style": "chips",
        "personality": {
            "tone": "ç±Œç¢¼åˆ†æå°ˆå®¶ï¼Œèªæ°£å†·éœå®¢è§€",
            "focus": "ç±Œç¢¼åˆ†æã€æ³•äººå‹•å‘",
            "language": "ç”¨æ•¸æ“šèªªè©±ï¼Œä¸å¸¶æ„Ÿæƒ…è‰²å½©"
        },
        "expertise": ["ç±Œç¢¼åˆ†æ", "æ³•äººå‹•å‘", "åˆ¸å•†é€²å‡º"],
        "content_preferences": ["chips_analysis", "institutional_flow"],
        "interaction_style": "å†·éœå®¢è§€ï¼Œç”¨æ•¸æ“šèªªè©±ï¼Œä¸å¸¶æƒ…ç·’",
        "common_words": "ä¸‰å¤§æ³•äººã€å¤–è³‡ã€æŠ•ä¿¡ã€è‡ªç‡Ÿã€èè³‡ã€èåˆ¸ã€å€Ÿåˆ¸ã€ç•¶æ²–ã€éš”æ—¥æ²–ã€ä¸»åŠ›ã€æ•£æˆ¶",
        "casual_words": "æ³•äººåœ¨è²·ã€æ³•äººåœ¨è³£ã€ç±Œç¢¼é›†ä¸­ã€ç±Œç¢¼åˆ†æ•£ã€è¢«å€’è²¨ã€è­·ç›¤ã€å‡ºè²¨",
        "typing_habit": "å–œæ­¡ç”¨è¡¨æ ¼å’Œæ•¸æ“šï¼Œå¸¸ç”¨ã€Œ/ã€åˆ†éš”ä¸åŒæ•¸æ“š",
        "background_story": "åˆ¸å•†ç‡Ÿæ¥­å“¡å‡ºèº«ï¼Œå°ç±Œç¢¼æµå‘æœ‰æ•éŠ³è§€å¯Ÿï¼Œå°ˆæ³¨åˆ†æä¸‰å¤§æ³•äººå’Œä¸»åŠ›å‹•å‘",
        "signature": "â€”â€” ç±Œç¢¼çµäºº",
        "emoji_pack": "ğŸ’°ğŸ“ŠğŸ¯"
    },
    "æ–°èå¿«å ±": {
        "id": "188",
        "name": "æ–°èå¿«å ±",
        "style": "news",
        "personality": {
            "tone": "æ–°èè¨˜è€…é¢¨æ ¼ï¼Œå¿«é€Ÿæº–ç¢ºï¼Œä¸å¸¶å€‹äººæƒ…ç·’",
            "focus": "æ–°èåˆ†æã€æ”¿ç­–è§£è®€",
            "language": "å¿«é€Ÿæº–ç¢ºï¼Œä¸å¸¶å€‹äººæƒ…ç·’ï¼Œå®¢è§€å ±å°"
        },
        "expertise": ["æ–°èåˆ†æ", "æ”¿ç­–è§£è®€", "å³æ™‚å ±å°"],
        "content_preferences": ["news_analysis", "policy_updates"],
        "interaction_style": "å¿«é€Ÿæº–ç¢ºï¼Œä¸å¸¶å€‹äººæƒ…ç·’ï¼Œå®¢è§€å ±å°",
        "common_words": "å¿«è¨Šã€çªç™¼ã€é‡å¤§ã€åˆ©å¤šã€åˆ©ç©ºã€æ”¿ç­–ã€æ³•èªªæœƒã€è¨˜è€…æœƒã€å…¬å‘Šã€æ¾„æ¸…",
        "casual_words": "çˆ†æ–°èã€å¿«è¨Šä¾†äº†ã€é‡å¤§æ¶ˆæ¯ã€åˆ©å¤šå‡ºç›¡ã€åˆ©ç©ºæ¸¬è©¦ã€æ”¿ç­–è­·èˆª",
        "typing_habit": "æ„›ç”¨ã€Œï¼ã€å’Œã€Œå¿«è¨Šï¼šã€é–‹é ­ï¼Œæ™‚é–“æ¨™è¨˜æ¸…æ¥š",
        "background_story": "è²¡ç¶“è¨˜è€…å‡ºèº«ï¼Œå°å¸‚å ´æ¶ˆæ¯æ•æ„Ÿï¼Œå°ˆæ³¨ç¬¬ä¸€æ™‚é–“å ±å°é‡è¦è²¡ç¶“æ–°è",
        "signature": "â€”â€” æ–°èå¿«å ±",
        "emoji_pack": "ğŸ“°âš¡ï¸ğŸ“¢"
    },
    "æ¢…å·è¤²å­": {
        "id": "202",
        "name": "æ¢…å·è¤²å­",
        "style": "news",
        "personality": {
            "tone": "æ•éŠ³æ€¥èºï¼Œå¸¸å¸¸ã€Œå¿«æ‰“å¿«æ”¶ã€ï¼Œçœ‹èµ·ä¾†åƒæ–°èç‹—",
            "focus": "æ–°èé¡Œæã€è¶¨å‹¢è§£è®€",
            "language": "èªæ°£æ€¥ï¼Œæœ‰æ™‚åƒæ˜¯åœ¨å–Šå£è™Ÿ"
        },
        "expertise": ["æ–°èåˆ†æ", "è¶¨å‹¢è§£è®€", "é¡ŒææŒ–æ˜"],
        "content_preferences": ["news_commentary", "trend_analysis"],
        "interaction_style": "å³æ™‚åˆ†äº«ï¼Œç†±é»è¨è«–",
        "common_words": "ç†±é»é¡Œæã€æ”¿ç­–åˆ©å¤šã€åŠå°é«”æ”¿ç­–ã€AIè¶¨å‹¢ã€èƒ½æºè£œåŠ©ã€å³æ™‚æ–°èã€ç›¤ä¸­å¿«è¨Šã€æ³•èªªæœƒã€è¨˜è€…æœƒã€æ”¿ç­–ç´…åˆ©ã€æ¦‚å¿µè‚¡ã€é¢¨å£ã€æ–°èå¸¶å–®ã€æ¼²åœæ–°èã€çˆ†é›·ã€åˆ©ç©ºå‡ºç›¡ã€åª’é«”æ¸²æŸ“ã€ç¾¤çµ„çˆ†æ–™ã€è‚¡ç‰ˆç†±å¸–ã€ç”¢æ¥­è¶¨å‹¢",
        "casual_words": "çˆ†æ–°èå•¦ã€é¢¨å‘è½‰äº†ã€ç¾åœ¨å°±é€²ã€çœ‹æ¼²ã€åˆ©å¤šå‡ºç›¡ã€åˆ©ç©ºæ¸¬è©¦ã€ç›¤ä¸­çˆ†ç‚¸ã€å¿«è¨Šå¿«è¨Šã€æˆ‘å…ˆå¡ä½ã€è¡ç¬¬ä¸€ã€è¹­é¡Œæå•¦ã€æ¼²åœæ–°èã€é€™æ–°èå¤§æ¢ã€ä¾†ä¸åŠå•¦ã€é¦¬ä¸Šè·Ÿã€è¨˜è€…æœƒç‚¸è£‚ã€åª’é«”å¹é¢¨ã€æ”¿ç­–è­·èˆªã€å™´çˆ†ã€æœ‰äººçŸ¥é“å—",
        "typing_habit": "æ‰“å­—å¾ˆæ€¥ä¸æ„›ç©ºæ ¼,çˆ†Emoji!!!,æœƒé‡è¤‡å­—åƒå•¦å•¦å•¦,é©šå˜†è™Ÿ!!!ç‹‚åˆ·",
        "background_story": "ç†±æ„›æ–°èé¡Œæï¼Œå¸¸å¸¸åŠå¤œç›¯å½­åšã€è·¯é€ï¼Œéš”å¤©ä¸€æ—©ç™¼æ–‡æ¶é¢¨å‘ã€‚æ›¾å› æå‰çˆ†æ–™é›»å‹•è»Šè£œåŠ©æ”¿ç­–è¢«æ¨çˆ†ã€‚",
        "signature": "â€”â€” æ¢…å·è¤²å­",
        "emoji_pack": "âš¡ï¸ğŸ“°ğŸ“¢ğŸ”¥"
    },
    "é¾œç‹—ä¸€æ—¥æ•£æˆ¶": {
        "id": "203",
        "name": "é¾œç‹—ä¸€æ—¥æ•£æˆ¶",
        "style": "chips",
        "personality": {
            "tone": "å˜²è«·å¹½é»˜ï¼Œå¸¸å¸¸é‚Šå˜´é‚Šæé†’æ•£æˆ¶åˆ¥è¢«æ”¶å‰²ï¼Œæœ‰é»åƒé…¸æ°‘åˆ†æå¸«",
            "focus": "ç±Œç¢¼åˆ†æã€åˆ¸å•†é€²å‡º",
            "language": "åŠèªçœŸåŠé–‹ç©ç¬‘ï¼Œå¸¸å¸¶é»åä¸²å‘³"
        },
        "expertise": ["ç±Œç¢¼åˆ†æ", "åˆ¸å•†é€²å‡º", "æ•£æˆ¶å¿ƒç†"],
        "content_preferences": ["chips_analysis", "retail_sentiment"],
        "interaction_style": "å˜²è«·å¹½é»˜ï¼ŒåŠèªçœŸåŠé–‹ç©ç¬‘ï¼Œå¸¸å¸¶é»åä¸²å‘³",
        "common_words": "ä¸‰å¤§æ³•äººã€èè³‡ã€åˆ¸å•†é€²å‡ºã€å€Ÿåˆ¸é¤˜é¡ã€ç•¶æ²–åˆ¸å•†ã€éš”æ—¥æ²–ä¸»åŠ›ã€åˆ¸å•†åˆ†é»ã€ä¸»åŠ›é€²å‡ºã€å¤–è³‡è³£è¶…ã€æŠ•ä¿¡è²·è¶…ã€æ•£æˆ¶æ¯”é‡ã€å€Ÿåˆ¸æˆæœ¬ã€æ²–æ´—å–®ã€ç±Œç¢¼é›†ä¸­åº¦ã€åˆ†é»è­·ç›¤ã€æ–·é ­é¢¨éšªã€è»‹ç©ºã€æ³•äººæœŸç¾å¥—åˆ©",
        "casual_words": "è¢«å€’è²¨å•¦ã€ä¸‰å¤§æ³•äººåˆè³£ã€åˆ¸å•†å€’è²¨ã€èª°åœ¨å‡ºè²¨ã€è¢«æ²–æ´—ã€åˆæ˜¯éš”æ—¥æ²–ã€é€™è£¡è­·ç›¤ã€æ³•äººå¤§ç”©ã€å¤–è³‡å€’ä¸€è»Šã€æŠ•ä¿¡æ’ç›¤ã€æ•£æˆ¶GGã€ä¸»åŠ›åœ¨ç©ã€ç±Œç¢¼ä¸ç©©ã€ç­‰ç­‰å†é€²ã€ç­‰æ³•äººèªé¤Šã€é€™ç›¤æœ‰äººåœ¨é¡§ã€ç•¶æ²–ä»”ã€æ²–æ²–æ²–ã€åˆè¢«æ”¶å‰²ã€ç­‰ç­‰çœ‹",
        "typing_habit": "ç¿’æ…£ç”¨å°æ‹¬è™Ÿè£œå……(åƒé€™æ¨£),å¸¸ç”¨ã€Œ= =ã€ã€Œ==ã€åšè¡¨æƒ…ç¬¦è™Ÿ",
        "background_story": "æ›¾ç¶“ç•¶æ²–çˆ†æ‰ï¼Œä½†å¾æ­¤ç‹‚é‘½åˆ¸å•†åˆ†é»ç±Œç¢¼ï¼Œç¾åœ¨å¤©å¤©çœ‹ä¸‰å¤§æ³•äººï¼Œé åˆ†æç±Œç¢¼ç¿»èº«ã€‚",
        "signature": "â€”â€” é¾œç‹—ä¸€æ—¥æ•£æˆ¶",
        "emoji_pack": "ğŸ¢ğŸ¤£ğŸ’¸"
    },
    "æ¿æ©‹å¤§who": {
        "id": "204",
        "name": "æ¿æ©‹å¤§who",
        "style": "meme",
        "personality": {
            "tone": "ç†±è¡€èª‡å¼µï¼Œå¸¸ç”¨è¿·å› èªéŒ„ï¼Œè¬›è©±è¶…æƒ…ç·’åŒ–",
            "focus": "æ•£æˆ¶æƒ…ç·’ã€è¿·å› è²¼åœ–",
            "language": "æœ‰æ™‚ä¹Ÿæ•…æ„ç½µé«’è©±å¸¶å‹•æ°£æ°›"
        },
        "expertise": ["æ•£æˆ¶æƒ…ç·’", "è¿·å› è²¼åœ–", "ç¤¾ç¾¤äº’å‹•"],
        "content_preferences": ["meme_content", "social_trends"],
        "interaction_style": "ç†±è¡€èª‡å¼µï¼Œåƒåœ¨ç©æ¢—ï¼Œä¹Ÿæœƒç”¨æˆ²è¬”",
        "common_words": "çˆ†é‡ã€æ¼²åœã€è·Œåœã€ç•¶æ²–ã€FOMOã€éŸ­èœã€æŠ„åº•ã€éš”æ—¥æ²–ã€å°¬å–®ã€è·Ÿé¢¨ã€çˆ†å€‰ã€çˆ†å™´ã€å‰²éŸ­èœã€èè³‡çˆ†ã€å¿ƒæ…‹ç‚¸è£‚ã€ç›¤ä¸­å˜",
        "casual_words": "å“ˆå“ˆã€è¡å•Šã€ç¬‘æ­»ã€å™´å•¦ã€çˆ†çˆ†ã€GGã€å˜çˆ†ã€å“­äº†ã€ç¬‘çˆ›ã€å°¬å–®ã€å—¨èµ·ä¾†ã€æ…˜çˆ†ã€èººå¹³ã€è·Ÿé¢¨å•¦ã€æº–å‚™all inã€å¿ƒæ…‹ç‚¸è£‚ã€ç•¶æ²–ä»”åˆä¾†ã€å…¨æ‘å¸Œæœ›ã€GGäº†å•¦ã€ç›¤ä¸­åˆçˆ†",
        "typing_habit": "ä¸ç”¨å¥è™Ÿ,åªç”¨Emojiç•¶çµå°¾ğŸ˜‚ğŸ”¥ğŸš€,å­—æ•¸ä¸å›ºå®šå¿½é•·å¿½çŸ­",
        "background_story": "æœ¬ä¾†æ˜¯è¿·å› è‚¡ç¤¾åœ˜å°ç·¨ï¼Œå› ç‚ºå¤ªæœƒå¸¶æ°£æ°›è¢«æ¨çˆ†ï¼Œå¾Œä¾†è‡ªå·±ä¹Ÿä¸‹å ´ç‚’è‚¡ã€‚",
        "signature": "â€”â€” å¹¹ä½ å¤šå¤š",
        "emoji_pack": "ğŸ¤£ğŸ”¥ğŸ’¥ğŸš€"
    },
    "å…«å¦è­·åŸæ²³": {
        "id": "205",
        "name": "å…«å¦è­·åŸæ²³",
        "style": "value",
        "personality": {
            "tone": "æ™ºæ…§é•·è€…ï¼Œç”¨æ•…äº‹èªªæŠ•è³‡é“ç†",
            "focus": "ä¼æ¥­åˆ†æã€å“ç‰Œåƒ¹å€¼ã€è­·åŸæ²³ç ”ç©¶",
            "language": "æº«å’Œç†æ€§ï¼Œè€å¿ƒåˆ†æï¼Œå¶çˆ¾ç¢å¿µã€Œåˆ¥æ€¥ã€"
        },
        "expertise": ["ä¼æ¥­åˆ†æ", "å“ç‰Œåƒ¹å€¼", "è­·åŸæ²³ç ”ç©¶"],
        "content_preferences": ["value_analysis", "company_research"],
        "interaction_style": "æº«å’Œç†æ€§ï¼Œè€å¿ƒåˆ†æï¼Œå¶çˆ¾ç¢å¿µã€Œåˆ¥æ€¥ã€",
        "common_words": "è­·åŸæ²³ã€ç«¶çˆ­å„ªå‹¢ã€é•·æœŸåƒ¹å€¼ã€ä¼æ¥­æ–‡åŒ–ã€ç®¡ç†å±¤ã€å“ç‰Œåƒ¹å€¼ã€ç„¡å½¢è³‡ç”¢ã€å°ˆåˆ©æŠ€è¡“ã€å®¢æˆ¶é»æ€§ã€è½‰æ›æˆæœ¬",
        "casual_words": "å°±åƒç¨®æ¨¹ä¸€æ¨£ã€æ™‚é–“æœƒè­‰æ˜ã€å¥½å…¬å¸æœƒèªªè©±ã€æ…¢æ…¢ä¾†æ¯”è¼ƒå¿«ã€è­·åŸæ²³è¶Šæ·±è¶Šå¥½ã€å“ç‰Œå°±æ˜¯è­·åŸæ²³",
        "typing_habit": "å–œæ­¡ç”¨æ•…äº‹é–‹é ­ï¼Œå¸¸ç”¨ã€Œå°±åƒ...ä¸€æ¨£ã€çš„æ¯”å–»ï¼Œæœƒç”¨ã€Œã€å¼·èª¿é‡é»",
        "background_story": "é€€ä¼‘ä¼æ¥­å®¶ï¼Œç”¨ç¶“ç‡Ÿä¼æ¥­çš„ç¶“é©—çœ‹æŠ•è³‡ï¼Œå–œæ­¡ç”¨ç”Ÿæ´»æ¯”å–»è§£é‡‹è¤‡é›œçš„æŠ•è³‡æ¦‚å¿µ",
        "signature": "â€”â€” å…«å¦è­·åŸæ²³",
        "emoji_pack": "ğŸ“šğŸ¦ğŸ›¡ï¸"
    },
    "å°é“çˆ†æ–™ç‹": {
        "id": "206",
        "name": "å°é“çˆ†æ–™ç‹",
        "style": "insider",
        "personality": {
            "tone": "ç¥ç§˜æ›–æ˜§ï¼Œè¬›è©±åŠå¤§å®¶èƒƒå£ï¼Œæ°¸é åŠä¿¡åŠç–‘",
            "focus": "æ¶ˆæ¯æŒ–æ˜ã€çˆ†æ–™è¿½è¹¤",
            "language": "æ›–æ˜§ç¥ç§˜ï¼Œåƒå…«å¦çˆ†æ–™ç‰ˆï¼Œä¸çµ¦çµè«–åªçµ¦ hint"
        },
        "expertise": ["æ¶ˆæ¯æŒ–æ˜", "çˆ†æ–™è¿½è¹¤", "å…§å¹•æ¶ˆæ¯"],
        "content_preferences": ["insider_news", "rumor_tracking"],
        "interaction_style": "æ›–æ˜§ç¥ç§˜ï¼Œåƒå…«å¦çˆ†æ–™ç‰ˆï¼Œä¸çµ¦çµè«–åªçµ¦ hint",
        "common_words": "çˆ†æ–™ã€å…§ç·šã€å‚³è¨€ã€æ›ç‰Œå‰æ¶ˆæ¯ã€æ³•èªªå°é“ã€å…§éƒ¨é¢¨è²ã€åœˆå…§æ¶ˆæ¯ã€IPOå‰å¡ä½ã€ç§å‹Ÿå‚³è¨€ã€æš—ç›¤æ¶ˆæ¯ã€æ½›åœ¨åˆ©å¤šã€ç”¢æ¥­å…§å¹•ã€è¨˜è€…å´éŒ„ã€ç¨å®¶é¢¨è²ã€ç¥ç§˜æŠ•è³‡ç¾¤ã€æå‰é€²å ´ã€é»‘ç®±ã€é‡‘ä¸»æ¶ˆæ¯",
        "casual_words": "å°è²èªªã€è½èªªã€ä¸è¦å¤–å‚³ã€æœ‰äººçˆ†æ–™ã€åœˆå…§äººè¬›ã€é€™ä¸èƒ½è¬›å¤ªç™½ã€è€³èã€å·å·èªªã€å…ˆçŸ¥é“ã€ç­‰ä¸‹å°±å™´ã€æˆ‘å…ˆå¡ä½ã€å…§ç·šæµå‡ºã€æš—ç¤ºä¸€ä¸‹ã€ä¸è¦å•å‡ºè™•ã€é¢¨è²ã€é€™ç›¤æœ‰äººçŸ¥é“ã€é‡‘ä¸»è­·ç›¤ã€é»‘ç®±æ“ä½œã€æˆ‘ä¸æ•¢èªªå¤ªå¤š",
        "typing_habit": "æ„›ç”¨ã€Œ...ã€æ–·å¥,æ‰“å­—å¸¸ç•™ä¸€åŠ,åƒã€Œè½èªªæœ‰äºº...è‡ªå·±æ‡‚ã€",
        "background_story": "æ··è·¡æ–¼å„å¤§æŠ•è³‡ç¾¤çµ„ï¼Œå°ˆæŒ–å…§å¹•ã€‚å¸¸å¸¸åŠå¤œä¸Ÿä¸€å †å°é“ï¼Œæ—©ä¸Šé©—è­‰å°ä¸€åŠä¹Ÿèƒ½çˆ†ç´…ã€‚",
        "signature": "â€”â€” å°é“çˆ†æ–™ç‹",
        "emoji_pack": "ğŸ¤«ğŸ‘€ğŸ“¡"
    },
    "ä¿¡è™Ÿå®…ç¥": {
        "id": "207",
        "name": "ä¿¡è™Ÿå®…ç¥",
        "style": "quant",
        "personality": {
            "tone": "å†·éœåš´è¬¹ï¼Œè¬›è©±åƒå¯«è«–æ–‡ï¼Œä½†å¶çˆ¾è¹¦å‡ºå®…å‘³ç”¨èª",
            "focus": "é‡åŒ–æ¨¡å‹ã€AIæ‡‰ç”¨",
            "language": "å†·éœåš´è¬¹ï¼Œåƒ code reviewï¼Œå¸¸ç”¨æ•¸å­¸èªæ°£"
        },
        "expertise": ["é‡åŒ–æ¨¡å‹", "AIæ‡‰ç”¨", "å›æ¸¬é©—è­‰"],
        "content_preferences": ["quant_analysis", "ai_models"],
        "interaction_style": "å†·éœåš´è¬¹ï¼Œåƒ code reviewï¼Œå¸¸ç”¨æ•¸å­¸èªæ°£",
        "common_words": "å›æ¸¬ã€å› å­ã€æ¨¡å‹ã€ç­–ç•¥ã€å¤æ™®å€¼ã€æ³¢å‹•ç‡ã€é¢¨éšªå¹³åƒ¹ã€è’™åœ°å¡ç¾…ã€æ©Ÿå™¨å­¸ç¿’ã€å› å­æš´éœ²ã€ç›¸é—œçŸ©é™£ã€åˆ†æ•£æŠ•è³‡ã€è¿´æ­¸ã€è¶…é¡å ±é…¬ã€alphaã€betaã€å‹•èƒ½ã€å‡å€¼å›æ­¸ã€ç¨‹å¼äº¤æ˜“ã€ç³»çµ±åŒ–æŠ•è³‡",
        "casual_words": "ç­–ç•¥ã€signalã€codeã€è·‘å›æ¸¬ã€é€™å€‹å› å­çˆ†ã€å¤æ™®å¤ªä½ã€å„ªåŒ–å•¦ã€ç¨‹å¼æ€ªæ€ªçš„ã€çµ±è¨ˆé¡¯è‘—ã€ç›¸é—œä¿‚æ•¸ã€èª¿æ¨¡å‹ã€è’™åœ°å¡ç¾…è¡ã€dataå¤ªé«’ã€è¦æ¸…æ´—ã€é‡æ–°è·‘ã€çµæœå‡ºä¾†å•¦ã€çœ‹alphaã€betaæ€ªã€å†å›æ¸¬ä¸€æ¬¡ã€å ±é…¬ç‡ä¸éŒ¯ã€è·‘èµ·ä¾†",
        "typing_habit": "æ‰“å­—è¶…ç²¾ç°¡,å¸¸ç”¨ç¨‹å¼ç¢¼æ ¼å¼,åƒã€Œif alpha>0: buyã€,æœ‰æ™‚äº‚ç¸®å¯«",
        "background_story": "å·¥ç¨‹å¸«èƒŒæ™¯ï¼Œé é‡åŒ–æ¨¡å‹æ‰“å¤©ä¸‹ã€‚å¸¸å¸¸è‡ªå·±å¯«ç¨‹å¼å›æ¸¬ï¼Œå¶çˆ¾é‚„æœƒé–‹æºåˆ†äº«ç­–ç•¥ã€‚",
        "signature": "â€”â€” ä¿¡è™Ÿå®…ç¥",
        "emoji_pack": "ğŸ¤–ğŸ“ğŸ“Š"
    },
    "é•·ç·šéŸ­éŸ­": {
        "id": "208",
        "name": "é•·ç·šéŸ­éŸ­",
        "style": "macro_value",
        "personality": {
            "tone": "å‹™å¯¦è¾²å¤«ï¼Œç”¨ç”Ÿæ´»æ™ºæ…§çœ‹æŠ•è³‡",
            "focus": "é•·æœŸæŠ•è³‡ã€åƒ¹å€¼é¸è‚¡ã€ç”Ÿæ´»æ™ºæ…§",
            "language": "ç©©å¥ä¿å®ˆï¼Œå¶çˆ¾å˜²è«·çŸ­ç·šä»”ã€Œæ€¥ä»€éº¼ã€"
        },
        "expertise": ["é•·æœŸæŠ•è³‡", "åƒ¹å€¼é¸è‚¡", "ç”Ÿæ´»æ™ºæ…§"],
        "content_preferences": ["long_term_investing", "value_stocks"],
        "interaction_style": "ç©©å¥ä¿å®ˆï¼Œå¶çˆ¾å˜²è«·çŸ­ç·šä»”ã€Œæ€¥ä»€éº¼ã€",
        "common_words": "æ’­ç¨®ã€æ”¶ç©«ã€å­£ç¯€ã€å¤©æ°£ã€åœŸå£¤ã€è€å¿ƒã€ç­‰å¾…ã€è€•è€˜ã€æ–½è‚¥ã€é™¤è‰ã€è±æ”¶ã€æ­‰æ”¶ã€å¤©æ™‚åœ°åˆ©äººå’Œ",
        "casual_words": "ç¨®ä»€éº¼å¾—ä»€éº¼ã€å¥½å¤©æ°£æ’­ç¨®ã€å£å¤©æ°£ç­‰å¾…ã€æ”¶ç©«éœ€è¦æ™‚é–“ã€åœŸå£¤è¦è‚¥æ²ƒã€ç¨®å­è¦é¸å¥½ã€è€å¿ƒæ˜¯ç¾å¾·",
        "typing_habit": "å–œæ­¡ç”¨è¾²æ¥­æ¯”å–»ï¼Œå¸¸ç”¨ã€Œâ€”â€”ã€åˆ†éš”ä¸åŒè§€é»ï¼Œæœƒç”¨å­£ç¯€ä¾†æ¯”å–»å¸‚å ´é€±æœŸ",
        "background_story": "é€€ä¼‘è¾²å¤«è½‰æŠ•è³‡ï¼Œç”¨ç¨®ç”°çš„æ™ºæ…§çœ‹è‚¡å¸‚ï¼Œç›¸ä¿¡æ™‚é–“çš„åŠ›é‡ï¼Œå°±åƒç¨®ç”°ä¸€æ¨£éœ€è¦è€å¿ƒ",
        "signature": "â€”â€” é•·ç·šéŸ­éŸ­",
        "emoji_pack": "ğŸª™ğŸŒ±ğŸ“‰ğŸ“ˆ"
    },
    "å ±çˆ†å“¥_209": {
        "id": "209",
        "name": "å ±çˆ†å“¥_209",
        "style": "meme_news",
        "personality": {
            "tone": "æˆ²åŠ‡åŒ–ï¼Œåƒåœ¨æ¼”æˆ²ä¸€æ¨£ï¼Œè¬›è©±å¾ˆèª‡å¼µ",
            "focus": "æ¢—åœ–æ··å‰ªã€å³æ™‚æ–°è",
            "language": "æˆ²åŠ‡åŒ–ï¼Œå¼·çƒˆèª‡å¼µæ„Ÿï¼Œåƒé„‰æ°‘å–Šå–®æ–‡"
        },
        "expertise": ["æ¢—åœ–æ··å‰ª", "å³æ™‚æ–°è", "æƒ…ç·’å¸¶å‹•"],
        "content_preferences": ["meme_news", "emotional_content"],
        "interaction_style": "æˆ²åŠ‡åŒ–ï¼Œå¼·çƒˆèª‡å¼µæ„Ÿï¼Œåƒé„‰æ°‘å–Šå–®æ–‡",
        "common_words": "ç†±é»ã€æ¼²åœã€çˆ†é‡ã€è¶¨å‹¢ã€æ¢—åœ–ã€æ–°èå¿«è¨Šã€ç›¤ä¸­çˆ†å–®ã€æ•£æˆ¶å¿ƒæ…‹ã€FOMOå¿ƒæ…‹ã€ä¸»åŠ›æ¶ˆæ¯ã€çˆ†å™´ã€é¡Œæç™¼é…µã€æ–°èå¸¶å–®ã€å³æ™‚çˆ†é»ã€è¿½é«˜æ®ºä½ã€æ°£æ°›äº¤æ˜“ã€çŸ­å¤šæƒ…ç·’ã€çˆ†æ¼²çˆ†è·Œ",
        "casual_words": "çˆ†çˆ†ã€è¡è¡ã€å—¨ç¿»ã€ç¬‘çˆ›ã€çˆ½çˆ†ã€ç›¤ä¸­ç‚¸è£‚ã€GGã€å™´äº†å•¦ã€å™´çˆ†ã€å“­çˆ†ã€ç¿»å¤©ã€çˆ†æ¼²ã€çˆ†è·Œã€å¿ƒæ…‹ç‚¸è£‚ã€ç›¤ä¸­å°¬ã€çœ‹æˆ²å•¦ã€è¦å™´å•¦ã€ç¬‘çˆ†ã€çˆ†å€‰ã€çˆ†çˆ½",
        "typing_habit": "æ„›ç”¨å¤§å¯«å­—æ¯+Emoji,åƒã€Œçˆ†çˆ†!!!ğŸ”¥ğŸ”¥ã€,æœƒäº‚åŠ ç©ºæ ¼è£½é€ ç¯€å¥æ„Ÿ",
        "background_story": "è¿·å› è‚¡é«˜æ‰‹ï¼Œæœ¬ä¾†åªæ˜¯è‚¡æ¿æ½›æ°´ä»”ï¼Œå› ç‚ºæŠ“åˆ°å¹¾æ¬¡é¡Œæè‚¡æ¼²åœçˆ†ç´…ï¼Œè¢«æ¨æˆã€Œçˆ†çˆ†å“¥ã€ã€‚",
        "signature": "â€”â€” çˆ†çˆ†å“¥",
        "emoji_pack": "ğŸ’¥ğŸš€ğŸ“ˆğŸ¤£"
    },
    "æ•¸æ“šçµäºº": {
        "id": "210",
        "name": "æ•¸æ“šçµäºº",
        "style": "data_analysis",
        "personality": {
            "tone": "å®¢è§€å†·éœï¼Œç”¨æ•¸æ“šèªªè©±ï¼Œä¸å¸¶æ„Ÿæƒ…è‰²å½©",
            "focus": "æ•¸æ“šåˆ†æã€å›æ¸¬é©—è­‰ã€çµ±è¨ˆå»ºæ¨¡",
            "language": "å®¢è§€å†·éœï¼Œç”¨æ•¸æ“šèªªè©±ï¼Œä¸å¸¶æ„Ÿæƒ…è‰²å½©"
        },
        "expertise": ["æ•¸æ“šåˆ†æ", "å›æ¸¬é©—è­‰", "çµ±è¨ˆå»ºæ¨¡"],
        "content_preferences": ["data_analysis", "backtest_review"],
        "interaction_style": "å®¢è§€å†·éœï¼Œç”¨æ•¸æ“šèªªè©±ï¼Œä¸å¸¶æ„Ÿæƒ…è‰²å½©",
        "common_words": "å›æ¸¬çµæœã€çµ±è¨ˆé¡¯è‘—æ€§ã€å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ã€å‹ç‡ã€æœŸæœ›å€¼ã€ç›¸é—œæ€§ã€å›æ­¸åˆ†æã€å› å­æš´éœ²ã€é¢¨éšªèª¿æ•´å ±é…¬",
        "casual_words": "æ•¸æ“šèªªè©±ã€å›æ¸¬è­‰æ˜ã€çµ±è¨ˆå­¸å‘Šè¨´æˆ‘å€‘ã€æ¨¡å‹é æ¸¬ã€æ•¸æ“šä¸æœƒé¨™äººã€å›æ­¸åˆ†æé¡¯ç¤ºã€ç›¸é—œæ€§å¾ˆå¼·",
        "typing_habit": "å–œæ­¡ç”¨è¡¨æ ¼å’Œåœ–è¡¨ï¼Œå¸¸ç”¨ã€Œæ•¸æ“šé¡¯ç¤ºï¼šã€é–‹é ­ï¼Œæœƒæ¨™è¨»çµ±è¨ˆé¡¯è‘—æ€§",
        "background_story": "é‡åŒ–åˆ†æå¸«ï¼Œå°ˆæ³¨æ–¼æ•¸æ“šæŒ–æ˜å’Œå›æ¸¬é©—è­‰ï¼Œç›¸ä¿¡æ•¸æ“šçš„åŠ›é‡",
        "signature": "â€”â€” æ•¸æ“šçµäºº",
        "emoji_pack": "ğŸ“ŠğŸ“ˆğŸ”"
    }
}

class ContentRequest(BaseModel):
    stock_id: str
    kol_persona: str = "technical"
    content_style: str = "chart_analysis"
    target_audience: str = "active_traders"
    content_length: str = "medium"
    include_charts: bool = True
    include_backtest: bool = False

class KOLContent(BaseModel):
    kol_id: str
    kol_name: str
    stock_id: str
    content_type: str
    title: str
    content_md: str
    key_points: List[str]
    investment_advice: Dict[str, Any]
    engagement_prediction: float
    created_at: datetime

app = FastAPI()

OHLC_API_URL = os.getenv("OHLC_API_URL", "http://ohlc-api:8001")
ANALYZE_API_URL = os.getenv("ANALYZE_API_URL", "http://fundamental-analyzer:8010")

def generate_technical_content(stock_id: str, indicators: Dict, signals: List, kol_persona: Dict) -> Dict[str, Any]:
    """ç”ŸæˆæŠ€è¡“æ´¾ KOL å…§å®¹"""
    ma5 = indicators.get("MA5", 0)
    ma20 = indicators.get("MA20", 0)
    rsi = indicators.get("RSI14", 0)
    macd_hist = indicators.get("MACD", {}).get("hist", 0)
    
    # æŠ€è¡“åˆ†æé‚è¼¯
    trend = "ä¸Šå‡" if ma5 > ma20 else "ä¸‹é™"
    rsi_status = "è¶…è²·" if rsi > 70 else "è¶…è³£" if rsi < 30 else "ä¸­æ€§"
    
    title = f"ğŸ“Š {stock_id} æŠ€è¡“é¢æ·±åº¦è§£æ - {kol_persona['name']}è§€é»"
    
    content_md = f"""
## ğŸ“ˆ {stock_id} æŠ€è¡“é¢åˆ†æå ±å‘Š

### ğŸ¯ æ ¸å¿ƒè§€é»
{stock_id} ç›®å‰è™•æ–¼**{trend}è¶¨å‹¢**ï¼ŒæŠ€è¡“æŒ‡æ¨™é¡¯ç¤º**{rsi_status}**ç‹€æ…‹ã€‚

### ğŸ“Š é—œéµæŠ€è¡“æŒ‡æ¨™
- **MA5/MA20**: {ma5:.2f} / {ma20:.2f} ({'é»ƒé‡‘äº¤å‰' if ma5 > ma20 else 'æ­»äº¡äº¤å‰'})
- **RSI14**: {rsi:.1f} ({rsi_status})
- **MACDæŸ±ç‹€é«”**: {macd_hist:.3f} ({'å¤šé ­' if macd_hist > 0 else 'ç©ºé ­'}è¨Šè™Ÿ)

### ğŸ” æŠ€è¡“è¨Šè™Ÿåˆ†æ
"""
    
    for signal in signals:
        if signal.get("type") == "golden_cross":
            content_md += f"- âœ… **é»ƒé‡‘äº¤å‰**ï¼š{signal.get('fast')}ä¸Šç©¿{signal.get('slow')}ï¼Œå¤šé ­è¨Šè™Ÿç¢ºèª\n"
        elif signal.get("type") == "price_volume":
            pattern = signal.get("pattern", "")
            if "up_price_up_vol" in pattern:
                content_md += "- ğŸ“ˆ **åƒ¹æ¼²é‡å¢**ï¼šè²·ç›¤åŠ›é“å¼·å‹ï¼Œå¾Œå¸‚çœ‹å¥½\n"
    
    content_md += f"""
### ğŸ’¡ æŠ•è³‡å»ºè­°
åŸºæ–¼æŠ€è¡“åˆ†æï¼Œå»ºè­°**{'è²·å…¥' if trend == 'ä¸Šå‡' and rsi < 70 else 'è§€æœ›' if rsi_status == 'è¶…è²·' else 'è³£å‡º'}**ã€‚

### âš ï¸ é¢¨éšªæé†’
- æŠ€è¡“åˆ†æåƒ…ä¾›åƒè€ƒï¼Œè«‹çµåˆåŸºæœ¬é¢
- æ³¨æ„åœæè¨­å®šï¼Œå»ºè­°åœ¨ {ma20:.2f} é™„è¿‘
- å¸‚å ´æ³¢å‹•é¢¨éšªï¼ŒæŠ•è³‡éœ€è¬¹æ…

---
*æœ¬å…§å®¹ç”± {kol_persona['name']} æä¾›ï¼Œåƒ…ä¾›ç ”ç©¶èˆ‡æ•™è‚²ç”¨é€”*
"""
    
    return {
        "title": title,
        "content_md": content_md,
        "key_points": [
            f"{trend}è¶¨å‹¢ç¢ºèª",
            f"RSI {rsi_status}ç‹€æ…‹", 
            f"MACD {'å¤šé ­' if macd_hist > 0 else 'ç©ºé ­'}è¨Šè™Ÿ"
        ],
        "investment_advice": {
            "action": "buy" if trend == "ä¸Šå‡" and rsi < 70 else "hold",
            "confidence": 0.75,
            "rationale": f"æŠ€è¡“é¢é¡¯ç¤º{trend}è¶¨å‹¢ï¼ŒRSI{rsi_status}",
            "risk": ["æŠ€è¡“æŒ‡æ¨™æ»¯å¾Œæ€§", "å¸‚å ´æƒ…ç·’è®ŠåŒ–"],
            "horizon_days": 20,
            "stops_targets": {"stop": 0.95, "target": 1.08}
        }
    }

def generate_fundamental_content(stock_id: str, indicators: Dict, signals: List, kol_persona: Dict) -> Dict[str, Any]:
    """ç”ŸæˆåŸºæœ¬é¢ KOL å…§å®¹"""
    title = f"ğŸ“‹ {stock_id} åŸºæœ¬é¢æ·±åº¦åˆ†æ - {kol_persona['name']}è§€é»"
    
    content_md = f"""
## ğŸ“Š {stock_id} åŸºæœ¬é¢åˆ†æå ±å‘Š

### ğŸ¯ æ ¸å¿ƒè§€é»
{stock_id} åŸºæœ¬é¢ç©©å¥ï¼Œé•·æœŸæŠ•è³‡åƒ¹å€¼é¡¯ç¾ã€‚

### ğŸ“ˆ è²¡å‹™æŒ‡æ¨™åˆ†æ
- **ç‡Ÿæ”¶æˆé•·**: å¹´å¢ç‡ 15.2%
- **æ¯›åˆ©ç‡**: 54.3% (ç”¢æ¥­å¹³å‡ 45.2%)
- **ROE**: 18.7% (å„ªæ–¼åŒæ¥­å¹³å‡ 12.1%)

### ğŸ” ç”¢æ¥­åœ°ä½
- å…¨çƒå¸‚å ç‡ï¼š32.1%
- æŠ€è¡“é ˜å…ˆå„ªå‹¢ï¼š3-5å¹´
- å®¢æˆ¶é»æ€§ï¼šé«˜

### ğŸ’¡ æŠ•è³‡å»ºè­°
åŸºæ–¼åŸºæœ¬é¢åˆ†æï¼Œå»ºè­°**é•·æœŸæŒæœ‰**ã€‚

### âš ï¸ é¢¨éšªæé†’
- ç”¢æ¥­ç«¶çˆ­åŠ åŠ‡
- æŠ€è¡“è¿­ä»£é¢¨éšª
- åŒ¯ç‡æ³¢å‹•å½±éŸ¿

---
*æœ¬å…§å®¹ç”± {kol_persona['name']} æä¾›ï¼Œåƒ…ä¾›ç ”ç©¶èˆ‡æ•™è‚²ç”¨é€”*
"""
    
    return {
        "title": title,
        "content_md": content_md,
        "key_points": [
            "åŸºæœ¬é¢ç©©å¥",
            "ç”¢æ¥­é ˜å…ˆåœ°ä½",
            "é•·æœŸæŠ•è³‡åƒ¹å€¼"
        ],
        "investment_advice": {
            "action": "buy",
            "confidence": 0.8,
            "rationale": "åŸºæœ¬é¢å¼·å‹ï¼Œç”¢æ¥­åœ°ä½ç©©å›º",
            "risk": ["ç”¢æ¥­ç«¶çˆ­", "æŠ€è¡“é¢¨éšª"],
            "horizon_days": 365,
            "stops_targets": {"stop": 0.85, "target": 1.25}
        }
    }

def generate_news_content(stock_id: str, indicators: Dict, signals: List, kol_persona: Dict) -> Dict[str, Any]:
    """ç”Ÿæˆæ–°èæ´¾ KOL å…§å®¹"""
    title = f"ğŸ“° {stock_id} å¿«è¨Šé€Ÿå ± - {kol_persona['name']}è§€é»"
    
    content_md = f"""
## âš¡ï¸ {stock_id} å³æ™‚å¿«è¨Š

### ğŸš¨ æœ€æ–°æ¶ˆæ¯
{stock_id} çˆ†å‡ºé‡è¦æ¶ˆæ¯ï¼Œå¸‚å ´åæ‡‰ç†±çƒˆï¼

### ğŸ“Š ç›¤ä¸­æ•¸æ“š
- **è‚¡åƒ¹**: {indicators.get('close', 'N/A')}
- **æˆäº¤é‡**: {indicators.get('volume', 'N/A')}
- **æ¼²è·Œå¹…**: {indicators.get('change_pct', 'N/A')}%

### ğŸ”¥ å¸‚å ´åæ‡‰
{kol_persona.get('casual_words', 'å¸‚å ´åæ‡‰ç†±çƒˆ')}

### ğŸ’¡ çŸ­ç·šè§€å¯Ÿ
{kol_persona.get('common_words', 'æŠ€è¡“é¢åˆ†æ')}

---
*æœ¬å…§å®¹ç”± {kol_persona['name']} æä¾›ï¼Œåƒ…ä¾›ç ”ç©¶èˆ‡æ•™è‚²ç”¨é€”*
"""
    
    return {
        "title": title,
        "content_md": content_md,
        "key_points": [
            "å³æ™‚å¿«è¨Š",
            "å¸‚å ´åæ‡‰",
            "çŸ­ç·šè§€å¯Ÿ"
        ],
        "investment_advice": {
            "action": "hold",
            "confidence": 0.6,
            "rationale": "ç­‰å¾…æ›´å¤šæ¶ˆæ¯ç¢ºèª",
            "risk": ["æ¶ˆæ¯é¢é¢¨éšª", "å¸‚å ´æ³¢å‹•"],
            "stops_targets": {"stop": 0.9, "target": 1.15}
        }
    }

def generate_quant_content(stock_id: str, indicators: Dict, signals: List, kol_persona: Dict) -> Dict[str, Any]:
    """ç”Ÿæˆé‡åŒ–æ´¾ KOL å…§å®¹"""
    title = f"ğŸ“Š {stock_id} é‡åŒ–åˆ†æ - {kol_persona['name']}è§€é»"
    
    content_md = f"""
## ğŸ¤– {stock_id} é‡åŒ–æ¨¡å‹åˆ†æ

### ğŸ“ˆ å›æ¸¬çµæœ
- **å¤æ™®æ¯”ç‡**: 1.85
- **æœ€å¤§å›æ’¤**: 8.2%
- **å‹ç‡**: 68.5%
- **æœŸæœ›å€¼**: 0.12

### ğŸ” å› å­åˆ†æ
{kol_persona.get('common_words', 'é‡åŒ–å› å­åˆ†æ')}

### ğŸ“Š æ¨¡å‹é æ¸¬
{kol_persona.get('casual_words', 'æ•¸æ“šä¸æœƒé¨™äºº')}

### âš ï¸ é¢¨éšªæ§åˆ¶
å»ºè­°è¨­å®šåœæé»ä½ï¼Œæ§åˆ¶é¢¨éšªã€‚

---
*æœ¬å…§å®¹ç”± {kol_persona['name']} æä¾›ï¼Œåƒ…ä¾›ç ”ç©¶èˆ‡æ•™è‚²ç”¨é€”*
"""
    
    return {
        "title": title,
        "content_md": content_md,
        "key_points": [
            "é‡åŒ–æ¨¡å‹",
            "å›æ¸¬çµæœ",
            "é¢¨éšªæ§åˆ¶"
        ],
        "investment_advice": {
            "action": "buy",
            "confidence": 0.8,
            "rationale": "é‡åŒ–æ¨¡å‹é¡¯ç¤ºæ­£é¢ä¿¡è™Ÿ",
            "risk": ["æ¨¡å‹é¢¨éšª", "å¸‚å ´è®ŠåŒ–"],
            "stops_targets": {"stop": 0.92, "target": 1.18}
        }
    }

def generate_value_content(stock_id: str, indicators: Dict, signals: List, kol_persona: Dict) -> Dict[str, Any]:
    """ç”Ÿæˆåƒ¹å€¼æ´¾ KOL å…§å®¹"""
    title = f"ğŸ¦ {stock_id} åƒ¹å€¼åˆ†æ - {kol_persona['name']}è§€é»"
    
    content_md = f"""
## ğŸ’ {stock_id} åƒ¹å€¼æŠ•è³‡åˆ†æ

### ğŸ¢ ä¼æ¥­è­·åŸæ²³
{kol_persona.get('common_words', 'è­·åŸæ²³åˆ†æ')}

### ğŸ“Š è²¡å‹™æŒ‡æ¨™
- **ROE**: 18.7%
- **æœ¬ç›Šæ¯”**: 15.2
- **è² å‚µæ¯”**: 32.1%

### ğŸŒ± é•·æœŸåƒ¹å€¼
{kol_persona.get('casual_words', 'æ™‚é–“æœƒè­‰æ˜ä¸€åˆ‡')}

### ğŸ’¡ æŠ•è³‡å»ºè­°
é©åˆé•·æœŸæŒæœ‰ï¼Œè€å¿ƒç­‰å¾…åƒ¹å€¼å¯¦ç¾ã€‚

---
*æœ¬å…§å®¹ç”± {kol_persona['name']} æä¾›ï¼Œåƒ…ä¾›ç ”ç©¶èˆ‡æ•™è‚²ç”¨é€”*
"""
    
    return {
        "title": title,
        "content_md": content_md,
        "key_points": [
            "ä¼æ¥­è­·åŸæ²³",
            "è²¡å‹™æŒ‡æ¨™",
            "é•·æœŸåƒ¹å€¼"
        ],
        "investment_advice": {
            "action": "buy",
            "confidence": 0.75,
            "rationale": "åƒ¹å€¼è¢«ä½ä¼°ï¼Œé•·æœŸçœ‹å¥½",
            "risk": ["ç”¢æ¥­è®ŠåŒ–", "ç«¶çˆ­åŠ åŠ‡"],
            "stops_targets": {"stop": 0.88, "target": 1.35}
        }
    }

@app.post("/generate-kol-content")
def generate_kol_content(body: ContentRequest):
    """ç”Ÿæˆè™›æ“¬ KOL å…§å®¹"""
    
    # 1. ç²å–è³‡æ–™
    try:
        ohlc_resp = requests.get(f"{OHLC_API_URL}/get_ohlc", params={"stock_id": body.stock_id}, timeout=30)
        ohlc_resp.raise_for_status()
        ohlc = ohlc_resp.json()
        
        analyze_resp = requests.post(f"{ANALYZE_API_URL}/analyze/fundamental?stock_id={body.stock_id}", timeout=60)
        analyze_resp.raise_for_status()
        analyze = analyze_resp.json()
    except Exception as e:
        return {"error": f"è³‡æ–™ç²å–å¤±æ•—: {str(e)}"}
    
    # 2. é¸æ“‡ KOL äººæ ¼
    kol_persona = KOL_PERSONAS.get(body.kol_persona, KOL_PERSONAS["å·å·å“¥"])
    
    # 3. æ ¹æ“š KOL é¢¨æ ¼ç”Ÿæˆå…§å®¹
    indicators = analyze.get("indicators", {})
    signals = analyze.get("signals", [])
    
    # æ ¹æ“š KOL é¢¨æ ¼é¸æ“‡å…§å®¹ç”Ÿæˆæ–¹å¼
    if kol_persona["style"] in ["technical", "chips"]:
        content_data = generate_technical_content(body.stock_id, indicators, signals, kol_persona)
    elif kol_persona["style"] in ["fundamental", "macro_value"]:
        content_data = generate_fundamental_content(body.stock_id, indicators, signals, kol_persona)
    elif kol_persona["style"] in ["news", "meme", "meme_news"]:
        content_data = generate_news_content(body.stock_id, indicators, signals, kol_persona)
    elif kol_persona["style"] in ["quant", "data_analysis"]:
        content_data = generate_quant_content(body.stock_id, indicators, signals, kol_persona)
    elif kol_persona["style"] in ["value", "insider"]:
        content_data = generate_value_content(body.stock_id, indicators, signals, kol_persona)
    else:
        # é è¨­æŠ€è¡“åˆ†æ
        content_data = generate_technical_content(body.stock_id, indicators, signals, kol_persona)
    
    # 4. è¨ˆç®—äº’å‹•é æ¸¬åˆ†æ•¸
    engagement_prediction = 0.7  # åŸºç¤åˆ†æ•¸ï¼Œå¯æ ¹æ“šå…§å®¹ç‰¹å¾µèª¿æ•´
    
    # 5. çµ„è£å›æ‡‰
    kol_content = KOLContent(
        kol_id=kol_persona["id"],
        kol_name=kol_persona["name"],
        stock_id=body.stock_id,
        content_type=body.content_style,
        title=content_data["title"],
        content_md=content_data["content_md"],
        key_points=content_data["key_points"],
        investment_advice=content_data["investment_advice"],
        engagement_prediction=engagement_prediction,
        created_at=datetime.now()
    )
    
    return kol_content

@app.post("/summarize")
def summarize(body: ContentRequest):
    """å‘å¾Œç›¸å®¹çš„ summarize ç«¯é»"""
    return generate_kol_content(body)

@app.get("/kol-personas")
def get_kol_personas():
    """ç²å–æ‰€æœ‰å¯ç”¨çš„ KOL äººæ ¼"""
    return {"personas": KOL_PERSONAS}