# 自我學習機制實現

## 概述

本文檔詳細說明自我學習機制的完整實現，基於 `advanced_self_learning.py` 文件。該實現包含完整的數據結構、核心組件和學習流程。

## 核心數據結構

### InteractionData
```python
@dataclass
class InteractionData:
    """互動數據結構"""
    article_id: str
    kol_id: str
    kol_nickname: str
    likes: int
    comments: int
    shares: int
    emoji_total: int
    total_interactions: int
    engagement_rate: float
    post_timestamp: str
    content: str
    topic_id: str
    views: Optional[int] = None
    sentiment_score: Optional[float] = None
```

### LearningInsight
```python
@dataclass
class LearningInsight:
    """學習洞察"""
    insight_type: str
    priority: str  # 'low', 'medium', 'high', 'critical'
    description: str
    suggested_actions: List[str]
    confidence: float
    timestamp: datetime
    impact_score: float
    implementation_difficulty: str
```

### KOLStrategy
```python
@dataclass
class KOLStrategy:
    """KOL 策略"""
    kol_id: str
    content_type_weights: Dict[str, float]
    persona_adjustments: Dict[str, float]
    timing_preferences: Dict[str, Any]
    interaction_style: Dict[str, Any]
    last_updated: datetime
```

## 核心組件實現

### 1. 實時分析器 (RealTimeAnalyzer)

#### 主要功能
- 分析互動表現
- 計算綜合互動分數
- 分析表情情感
- 分析時間模式
- 分析內容特徵
- 計算病毒傳播潛力
- 計算品牌影響力

#### 關鍵方法
```python
def analyze_interaction_performance(self, interaction_data: InteractionData) -> Dict[str, Any]:
    """分析互動表現"""
    engagement_score = self._calculate_engagement_score(interaction_data)
    emoji_sentiment = self._analyze_emoji_sentiment(interaction_data)
    timing_analysis = self._analyze_timing_pattern(interaction_data)
    content_analysis = self._analyze_content_features(interaction_data)
    viral_potential = self._calculate_viral_potential(interaction_data)
    brand_impact = self._calculate_brand_impact(interaction_data)
    
    return {
        'engagement_score': engagement_score,
        'emoji_sentiment': emoji_sentiment,
        'timing_analysis': timing_analysis,
        'content_analysis': content_analysis,
        'viral_potential': viral_potential,
        'brand_impact': brand_impact
    }
```

### 2. 模式偵測器 (PatternDetector)

#### 主要功能
- 識別成功模式
- 識別失敗模式
- 分析受眾行為模式
- 檢測異常模式

#### 關鍵方法
```python
def detect_success_patterns(self, interaction_data: List[InteractionData]) -> List[Dict[str, Any]]:
    """識別成功模式"""
    patterns = []
    
    # 高互動模式
    high_engagement_patterns = self._find_high_engagement_patterns(interaction_data)
    patterns.extend(high_engagement_patterns)
    
    # 病毒傳播模式
    viral_patterns = self._find_viral_patterns(interaction_data)
    patterns.extend(viral_patterns)
    
    # 最佳時機模式
    timing_patterns = self._find_timing_patterns(interaction_data)
    patterns.extend(timing_patterns)
    
    return patterns
```

### 3. 風險評估器 (RiskAssessor)

#### 主要功能
- AI 偵測風險評估
- 互動失敗風險評估
- 時機風險評估
- 內容品質風險評估

#### 關鍵方法
```python
def assess_ai_detection_risk(self, content: str, interaction_data: InteractionData) -> Dict[str, Any]:
    """評估 AI 偵測風險"""
    risk_factors = {
        'content_length': self._assess_content_length_risk(content),
        'repetition_patterns': self._assess_repetition_risk(content),
        'sentiment_consistency': self._assess_sentiment_risk(interaction_data),
        'interaction_patterns': self._assess_interaction_pattern_risk(interaction_data)
    }
    
    overall_risk = sum(risk_factors.values()) / len(risk_factors)
    
    return {
        'overall_risk': overall_risk,
        'risk_factors': risk_factors,
        'risk_level': self._get_risk_level(overall_risk)
    }
```

### 4. 學習洞察生成器 (LearningInsightGenerator)

#### 主要功能
- 基於風險的洞察
- 基於模式的洞察
- 基於表現趨勢的洞察
- 優先級排序和實施難度評估

#### 關鍵方法
```python
def generate_insights(self, analysis_results: Dict[str, Any]) -> List[LearningInsight]:
    """生成學習洞察"""
    insights = []
    
    # 基於風險的洞察
    risk_insights = self._generate_risk_based_insights(analysis_results)
    insights.extend(risk_insights)
    
    # 基於模式的洞察
    pattern_insights = self._generate_pattern_based_insights(analysis_results)
    insights.extend(pattern_insights)
    
    # 基於表現趨勢的洞察
    trend_insights = self._generate_trend_based_insights(analysis_results)
    insights.extend(trend_insights)
    
    # 按優先級排序
    insights.sort(key=lambda x: self._get_priority_score(x.priority), reverse=True)
    
    return insights
```

### 5. 策略優化器 (StrategyOptimizer)

#### 主要功能
- KOL 策略動態更新
- 內容風格調整
- 時機偏好優化
- 個人化程度提升

#### 關鍵方法
```python
def optimize_kol_strategy(self, kol_id: str, insights: List[LearningInsight]) -> KOLStrategy:
    """優化 KOL 策略"""
    current_strategy = self._get_current_strategy(kol_id)
    
    # 根據洞察調整策略
    for insight in insights:
        if insight.priority in ['high', 'critical']:
            current_strategy = self._apply_insight_to_strategy(current_strategy, insight)
    
    # 更新時間戳
    current_strategy.last_updated = datetime.now()
    
    return current_strategy
```

## 學習流程

### 完整學習循環
```python
class SelfLearningSystem:
    def __init__(self):
        self.real_time_analyzer = RealTimeAnalyzer()
        self.pattern_detector = PatternDetector()
        self.risk_assessor = RiskAssessor()
        self.insight_generator = LearningInsightGenerator()
        self.strategy_optimizer = StrategyOptimizer()
    
    async def process_interaction_data(self, interaction_data: List[InteractionData]):
        """處理互動數據的完整流程"""
        # 1. 實時分析
        analysis_results = []
        for data in interaction_data:
            analysis = self.real_time_analyzer.analyze_interaction_performance(data)
            analysis_results.append(analysis)
        
        # 2. 模式偵測
        patterns = self.pattern_detector.detect_patterns(interaction_data)
        
        # 3. 風險評估
        risks = self.risk_assessor.assess_risks(interaction_data)
        
        # 4. 生成洞察
        insights = self.insight_generator.generate_insights({
            'analysis': analysis_results,
            'patterns': patterns,
            'risks': risks
        })
        
        # 5. 策略優化
        for kol_id in set(data.kol_id for data in interaction_data):
            kol_insights = [i for i in insights if i.kol_id == kol_id]
            optimized_strategy = self.strategy_optimizer.optimize_kol_strategy(kol_id, kol_insights)
            await self._update_kol_strategy(optimized_strategy)
        
        return {
            'insights': insights,
            'optimized_strategies': len(set(data.kol_id for data in interaction_data))
        }
```

## 實際測試結果

### 測試數據
- **KOL**: 龜狗一日散戶、板橋大who
- **數據來源**: 真實的 CMoney API 數據
- **分析時間範圍**: 7天

### 分析結果
- **龜狗一日散戶**: 整體分數 19.3/100，風險等級中等
- **板橋大who**: 整體分數 17.0/100，風險等級中等

### 生成的洞察
1. **高優先級**: 互動率偏低，建議增加個人化元素
2. **中等優先級**: 發文時機不佳，建議在高峰時段發文

## 技術特點

### 多維度分析
- 互動表現分析
- 時間模式分析
- 內容特徵分析
- 風險評估分析

### 智能優化
- 基於洞察的策略調整
- 動態 KOL 配置更新
- 實時風險預警

### 可擴展性
- 模組化設計
- 插件式架構
- 配置驅動

## 未來改進方向

1. **機器學習集成**: 引入 ML 模型進行預測
2. **A/B 測試**: 支持策略對比測試
3. **實時監控**: 增強實時監控能力
4. **API 擴展**: 提供更多 API 端點

