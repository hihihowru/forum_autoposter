# PostgreSQL Schema 設計

## 📊 資料庫概覽

### 資料庫配置
- **資料庫名稱**: `posting_management`
- **連接字串**: `postgresql://postgres:password@postgres-db:5432/posting_management`
- **ORM**: SQLAlchemy
- **遷移工具**: Alembic (建議)

## 🗃️ 資料表設計

### 1. 貼文記錄表 (post_records)

#### 表結構
```sql
CREATE TABLE post_records (
    -- 主鍵和時間戳
    post_id VARCHAR PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 會話和 KOL 資訊
    session_id INTEGER,
    kol_serial INTEGER NOT NULL,
    kol_nickname VARCHAR NOT NULL,
    kol_persona VARCHAR,
    
    -- 股票資訊
    stock_code VARCHAR NOT NULL,
    stock_name VARCHAR NOT NULL,
    
    -- 內容資訊
    title VARCHAR NOT NULL,
    content TEXT NOT NULL,
    content_md TEXT,
    
    -- 狀態管理
    status VARCHAR DEFAULT 'draft',
    reviewer_notes TEXT,
    approved_by VARCHAR,
    approved_at TIMESTAMP,
    scheduled_at TIMESTAMP,
    published_at TIMESTAMP,
    
    -- 平台資訊
    cmoney_post_id VARCHAR,
    cmoney_post_url VARCHAR,
    publish_error TEXT,
    
    -- 互動數據
    views INTEGER DEFAULT 0,
    likes INTEGER DEFAULT 0,
    comments INTEGER DEFAULT 0,
    shares INTEGER DEFAULT 0,
    
    -- 話題資訊
    topic_id VARCHAR,
    topic_title VARCHAR,
    
    -- 分析數據
    technical_analysis JSON,
    serper_data JSON,
    
    -- 品質評分
    quality_score FLOAT,
    ai_detection_score FLOAT,
    risk_level VARCHAR,
    
    -- 生成參數
    generation_params JSON,
    commodity_tags JSON
);
```

#### 欄位說明

| 欄位名稱 | 資料類型 | 是否必填 | 說明 | 範例 |
|---------|---------|---------|------|------|
| `post_id` | VARCHAR | ✅ | 貼文唯一識別碼 | `"fb1ed457-f0fc-47ce-86dd-f29056297ebf-202"` |
| `created_at` | TIMESTAMP | ✅ | 建立時間 | `2025-01-15 10:30:00` |
| `updated_at` | TIMESTAMP | ✅ | 最後更新時間 | `2025-01-15 11:45:00` |
| `session_id` | INTEGER | ❌ | 批次會話ID | `1` |
| `kol_serial` | INTEGER | ✅ | KOL序號 | `202` |
| `kol_nickname` | VARCHAR | ✅ | KOL暱稱 | `"梅川褲子"` |
| `kol_persona` | VARCHAR | ❌ | KOL人設 | `"新聞派"` |
| `stock_code` | VARCHAR | ✅ | 股票代號 | `"2330"` |
| `stock_name` | VARCHAR | ✅ | 股票名稱 | `"台積電"` |
| `title` | VARCHAR | ✅ | 貼文標題 | `"台積電盤後分析"` |
| `content` | TEXT | ✅ | 貼文內容 | `"台股開紅衝155點!科技股噴爆啦!!!"` |
| `content_md` | TEXT | ❌ | Markdown格式內容 | `"# 台積電分析\n\n..."` |
| `status` | VARCHAR | ✅ | 貼文狀態 | `"draft"`, `"published"`, `"failed"` |
| `reviewer_notes` | TEXT | ❌ | 審核備註 | `"內容品質良好"` |
| `approved_by` | VARCHAR | ❌ | 審核者 | `"admin"` |
| `approved_at` | TIMESTAMP | ❌ | 審核時間 | `2025-01-15 11:00:00` |
| `scheduled_at` | TIMESTAMP | ❌ | 預定發布時間 | `2025-01-15 12:00:00` |
| `published_at` | TIMESTAMP | ❌ | 實際發布時間 | `2025-01-15 12:05:00` |
| `cmoney_post_id` | VARCHAR | ❌ | CMoney平台貼文ID | `"173349543"` |
| `cmoney_post_url` | VARCHAR | ❌ | CMoney平台貼文URL | `"https://www.cmoney.tw/forum/article/173349543"` |
| `publish_error` | TEXT | ❌ | 發布錯誤訊息 | `"API調用失敗"` |
| `views` | INTEGER | ✅ | 瀏覽數 | `150` |
| `likes` | INTEGER | ✅ | 按讚數 | `25` |
| `comments` | INTEGER | ✅ | 留言數 | `8` |
| `shares` | INTEGER | ✅ | 分享數 | `3` |
| `topic_id` | VARCHAR | ❌ | 話題ID | `"fb1ed457-f0fc-47ce-86dd-f29056297ebf"` |
| `topic_title` | VARCHAR | ❌ | 話題標題 | `"台股開紅盤"` |
| `technical_analysis` | JSON | ❌ | 技術分析數據 | `{"rsi": 65, "macd": "bullish"}` |
| `serper_data` | JSON | ❌ | Serper搜尋結果 | `{"news": [...], "keywords": [...]}` |
| `quality_score` | FLOAT | ❌ | 內容品質評分 | `8.5` |
| `ai_detection_score` | FLOAT | ❌ | AI檢測評分 | `0.2` |
| `risk_level` | VARCHAR | ❌ | 風險等級 | `"low"`, `"medium"`, `"high"` |
| `generation_params` | JSON | ❌ | 生成參數 | `{"temperature": 0.8, "model": "gpt-4"}` |
| `commodity_tags` | JSON | ❌ | 商品標籤 | `[{"type": "stock", "key": "2330", "bullOrBear": 1}]` |

#### 索引設計
```sql
-- 主要查詢索引
CREATE INDEX idx_post_records_session_id ON post_records(session_id);
CREATE INDEX idx_post_records_kol_serial ON post_records(kol_serial);
CREATE INDEX idx_post_records_status ON post_records(status);
CREATE INDEX idx_post_records_created_at ON post_records(created_at);
CREATE INDEX idx_post_records_topic_id ON post_records(topic_id);

-- 複合索引
CREATE INDEX idx_post_records_kol_status ON post_records(kol_serial, status);
CREATE INDEX idx_post_records_session_status ON post_records(session_id, status);
```

### 2. KOL 管理表 (kol_management)

#### 表結構
```sql
CREATE TABLE kol_management (
    -- 主鍵和時間戳
    serial VARCHAR PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 基本資訊
    nickname VARCHAR NOT NULL,
    member_id VARCHAR NOT NULL UNIQUE,
    persona VARCHAR NOT NULL,
    status VARCHAR DEFAULT 'active',
    owner VARCHAR,
    
    -- 登入資訊
    email VARCHAR UNIQUE,
    password VARCHAR,
    whitelist BOOLEAN DEFAULT FALSE,
    
    -- 發文設定
    post_times VARCHAR,
    target_audience VARCHAR,
    interaction_threshold INTEGER DEFAULT 10,
    content_types JSON,
    
    -- 人設設定
    common_terms TEXT,
    colloquial_terms TEXT,
    tone_style VARCHAR,
    typing_habit TEXT,
    backstory TEXT,
    expertise VARCHAR,
    
    -- Prompt 設定
    prompt_persona TEXT,
    prompt_style TEXT,
    prompt_guardrails TEXT,
    prompt_skeleton TEXT,
    prompt_cta TEXT,
    prompt_hashtags TEXT,
    
    -- 模型設定
    model_id VARCHAR DEFAULT 'gpt-4',
    model_temp FLOAT DEFAULT 0.8,
    max_tokens INTEGER DEFAULT 500,
    
    -- 數據偏好
    excluded_data_sources TEXT,
    data_preference_note TEXT,
    
    -- 統計數據
    total_posts INTEGER DEFAULT 0,
    published_posts INTEGER DEFAULT 0,
    avg_interaction_rate FLOAT DEFAULT 0.0,
    best_performing_post VARCHAR,
    
    -- 其他
    notes TEXT,
    signature TEXT,
    emoji_pack VARCHAR
);
```

#### 欄位說明

| 欄位名稱 | 資料類型 | 是否必填 | 說明 | 範例 |
|---------|---------|---------|------|------|
| `serial` | VARCHAR | ✅ | KOL序號 | `"202"` |
| `created_at` | TIMESTAMP | ✅ | 建立時間 | `2025-01-15 10:30:00` |
| `updated_at` | TIMESTAMP | ✅ | 最後更新時間 | `2025-01-15 11:45:00` |
| `nickname` | VARCHAR | ✅ | KOL暱稱 | `"梅川褲子"` |
| `member_id` | VARCHAR | ✅ | 會員ID | `"9505548"` |
| `persona` | VARCHAR | ✅ | 人設類型 | `"新聞派"`, `"技術派"`, `"籌碼派"` |
| `status` | VARCHAR | ✅ | 狀態 | `"active"`, `"inactive"`, `"suspended"` |
| `owner` | VARCHAR | ❌ | 認領人 | `"admin"` |
| `email` | VARCHAR | ❌ | 電子郵件 | `"kol202@example.com"` |
| `password` | VARCHAR | ❌ | 密碼 | `"encrypted_password"` |
| `whitelist` | BOOLEAN | ✅ | 白名單狀態 | `true`, `false` |
| `post_times` | VARCHAR | ❌ | 發文時間 | `"09:00,15:00,21:00"` |
| `target_audience` | VARCHAR | ❌ | 目標受眾 | `"散戶投資人"` |
| `interaction_threshold` | INTEGER | ✅ | 互動閾值 | `10` |
| `content_types` | JSON | ❌ | 內容類型 | `["investment", "analysis", "news"]` |
| `common_terms` | TEXT | ❌ | 常用詞彙 | `"台股,投資,分析"` |
| `colloquial_terms` | TEXT | ❌ | 口語化用詞 | `"噴爆,飆漲,崩盤"` |
| `tone_style` | VARCHAR | ❌ | 語氣風格 | `"專業理性"`, `"輕鬆活潑"` |
| `typing_habit` | TEXT | ❌ | 打字習慣 | `"喜歡使用表情符號"` |
| `backstory` | TEXT | ❌ | 背景故事 | `"資深投資顧問"` |
| `expertise` | VARCHAR | ❌ | 專長領域 | `"科技股分析"` |
| `prompt_persona` | TEXT | ❌ | Prompt人設 | `"你是專業的台股分析師"` |
| `prompt_style` | TEXT | ❌ | Prompt風格 | `"使用專業術語"` |
| `prompt_guardrails` | TEXT | ❌ | Prompt限制 | `"避免投資建議"` |
| `prompt_skeleton` | TEXT | ❌ | Prompt骨架 | `"標題: {title}\n內容: {content}"` |
| `prompt_cta` | TEXT | ❌ | Prompt行動呼籲 | `"大家怎麼看？"` |
| `prompt_hashtags` | TEXT | ❌ | Prompt標籤 | `"#台股 #投資"` |
| `model_id` | VARCHAR | ✅ | 模型ID | `"gpt-4"` |
| `model_temp` | FLOAT | ✅ | 模型溫度 | `0.8` |
| `max_tokens` | INTEGER | ✅ | 最大Token數 | `500` |
| `excluded_data_sources` | TEXT | ❌ | 排除數據源 | `"technical_indicators,finlab_ohlc"` |
| `data_preference_note` | TEXT | ❌ | 數據偏好說明 | `"專注籌碼面分析"` |
| `total_posts` | INTEGER | ✅ | 總發文數 | `150` |
| `published_posts` | INTEGER | ✅ | 已發布數 | `120` |
| `avg_interaction_rate` | FLOAT | ✅ | 平均互動率 | `0.15` |
| `best_performing_post` | VARCHAR | ❌ | 最佳表現貼文ID | `"post_123"` |
| `notes` | TEXT | ❌ | 備註 | `"測試用KOL"` |
| `signature` | TEXT | ❌ | 簽名 | `"- 梅川褲子"` |
| `emoji_pack` | VARCHAR | ❌ | 表情符號包 | `"investment_emojis"` |

#### 索引設計
```sql
-- 主要查詢索引
CREATE INDEX idx_kol_management_member_id ON kol_management(member_id);
CREATE INDEX idx_kol_management_persona ON kol_management(persona);
CREATE INDEX idx_kol_management_status ON kol_management(status);
CREATE INDEX idx_kol_management_owner ON kol_management(owner);

-- 複合索引
CREATE INDEX idx_kol_management_persona_status ON kol_management(persona, status);
```

### 3. 互動數據表 (interaction_data)

#### 表結構
```sql
CREATE TABLE interaction_data (
    -- 主鍵和時間戳
    id SERIAL PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 關聯資訊
    post_id VARCHAR NOT NULL,
    member_id VARCHAR NOT NULL,
    
    -- 時間點
    collection_time TIMESTAMP NOT NULL,
    time_period VARCHAR NOT NULL, -- '1hr', '1day', '7days'
    
    -- 互動數據
    likes_count INTEGER DEFAULT 0,
    comments_count INTEGER DEFAULT 0,
    shares_count INTEGER DEFAULT 0,
    views_count INTEGER DEFAULT 0,
    
    -- 計算欄位
    total_interactions INTEGER GENERATED ALWAYS AS (likes_count + comments_count + shares_count) STORED,
    engagement_rate FLOAT,
    
    -- 狀態
    collection_status VARCHAR DEFAULT 'success',
    error_message TEXT,
    
    -- 外鍵約束
    FOREIGN KEY (post_id) REFERENCES post_records(post_id) ON DELETE CASCADE
);
```

#### 欄位說明

| 欄位名稱 | 資料類型 | 是否必填 | 說明 | 範例 |
|---------|---------|---------|------|------|
| `id` | SERIAL | ✅ | 自動遞增主鍵 | `1` |
| `created_at` | TIMESTAMP | ✅ | 建立時間 | `2025-01-15 10:30:00` |
| `updated_at` | TIMESTAMP | ✅ | 最後更新時間 | `2025-01-15 11:45:00` |
| `post_id` | VARCHAR | ✅ | 貼文ID | `"post_123"` |
| `member_id` | VARCHAR | ✅ | 會員ID | `"9505548"` |
| `collection_time` | TIMESTAMP | ✅ | 收集時間 | `2025-01-15 12:00:00` |
| `time_period` | VARCHAR | ✅ | 時間週期 | `"1hr"`, `"1day"`, `"7days"` |
| `likes_count` | INTEGER | ✅ | 按讚數 | `25` |
| `comments_count` | INTEGER | ✅ | 留言數 | `8` |
| `shares_count` | INTEGER | ✅ | 分享數 | `3` |
| `views_count` | INTEGER | ✅ | 瀏覽數 | `150` |
| `total_interactions` | INTEGER | ✅ | 總互動數(計算欄位) | `36` |
| `engagement_rate` | FLOAT | ❌ | 互動率 | `0.24` |
| `collection_status` | VARCHAR | ✅ | 收集狀態 | `"success"`, `"failed"` |
| `error_message` | TEXT | ❌ | 錯誤訊息 | `"API調用失敗"` |

#### 索引設計
```sql
-- 主要查詢索引
CREATE INDEX idx_interaction_data_post_id ON interaction_data(post_id);
CREATE INDEX idx_interaction_data_member_id ON interaction_data(member_id);
CREATE INDEX idx_interaction_data_time_period ON interaction_data(time_period);
CREATE INDEX idx_interaction_data_collection_time ON interaction_data(collection_time);

-- 複合索引
CREATE INDEX idx_interaction_data_post_time ON interaction_data(post_id, time_period);
CREATE INDEX idx_interaction_data_member_time ON interaction_data(member_id, time_period);
```

## 🔗 資料表關聯

### 關聯圖
```
post_records (1) -----> (N) interaction_data
     |
     | (kol_serial)
     |
     v
kol_management (1) -----> (N) post_records
```

### 外鍵約束
```sql
-- interaction_data 表的外鍵
ALTER TABLE interaction_data 
ADD CONSTRAINT fk_interaction_post_id 
FOREIGN KEY (post_id) REFERENCES post_records(post_id) ON DELETE CASCADE;

-- 可選：添加 KOL 關聯約束（如果 member_id 對應 kol_management.member_id）
-- ALTER TABLE post_records 
-- ADD CONSTRAINT fk_post_kol_member 
-- FOREIGN KEY (kol_serial) REFERENCES kol_management(serial);
```

## 📊 資料類型說明

### JSON 欄位結構

#### generation_params
```json
{
  "method": "gpt-4",
  "temperature": 0.8,
  "max_tokens": 500,
  "prompt_version": "v2.1",
  "data_sources": ["finlab_ohlc", "serper_news"],
  "technical_indicators": ["rsi", "macd"],
  "session_id": 1,
  "generation_time": "2025-01-15T10:30:00Z"
}
```

#### commodity_tags
```json
[
  {
    "type": "stock",
    "key": "2330",
    "bullOrBear": 1
  },
  {
    "type": "industry",
    "key": "semiconductor",
    "bullOrBear": 1
  }
]
```

#### technical_analysis
```json
{
  "rsi": 65.5,
  "macd": {
    "signal": "bullish",
    "value": 2.3
  },
  "kd": {
    "k": 75.2,
    "d": 68.1
  },
  "volume_ratio": 1.8,
  "price_change": 2.5
}
```

#### serper_data
```json
{
  "keywords": ["台積電", "半導體", "AI"],
  "news_results": [
    {
      "title": "台積電Q4財報亮眼",
      "snippet": "台積電第四季營收...",
      "url": "https://example.com/news1",
      "date": "2025-01-15"
    }
  ],
  "search_strategy": "trending_topic",
  "relevance_score": 0.85
}
```

## 🚀 資料庫初始化

### 建立資料庫
```sql
-- 建立資料庫
CREATE DATABASE posting_management;

-- 使用資料庫
\c posting_management;

-- 建立使用者（可選）
CREATE USER posting_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE posting_management TO posting_user;
```

### 環境變數設定
```bash
# .env 檔案
DATABASE_URL=postgresql://postgres:password@postgres-db:5432/posting_management
POSTGRES_HOST=postgres-db
POSTGRES_PORT=5432
POSTGRES_DB=posting_management
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password
```

## 📈 效能優化建議

### 1. 查詢優化
- 使用適當的索引
- 避免 SELECT * 查詢
- 使用 LIMIT 限制結果數量
- 定期執行 VACUUM 和 ANALYZE

### 2. 資料分割
```sql
-- 按時間分割 post_records 表
CREATE TABLE post_records_2025_01 PARTITION OF post_records
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 3. 快取策略
- 使用 Redis 快取熱門查詢
- 實作查詢結果快取
- 使用資料庫連線池

## 🔒 安全性考量

### 1. 資料加密
- 密碼欄位使用加密存儲
- 敏感資料使用 AES 加密
- 使用 SSL/TLS 連線

### 2. 存取控制
- 實作角色基礎存取控制 (RBAC)
- 使用最小權限原則
- 定期審計資料庫存取

### 3. 備份策略
- 每日自動備份
- 異地備份
- 定期還原測試

---

**文檔版本**: v1.0  
**最後更新**: 2025-01-15  
**審核狀態**: 待審核
