# 智能優化關鍵字系統 - 今日完成計劃

## 🚀 今日目標 (2025-01-15)

### 核心任務 (4小時完成)
1. **觸發器專用 Prompt 系統** (1.5小時)
2. **統一 Serper API 整合** (1.5小時)  
3. **智能關鍵字生成** (1小時)

## ⚡ 快速實施計劃

### 階段 1: 觸發器專用 Prompt 系統 (1.5小時)

#### 1.1 創建 Prompt 策略類 (30分鐘)
```python
# src/services/content/trigger_prompt_strategies.py
class TrendingTopicPromptStrategy:
    def get_system_prompt(self, kol_nickname: str, kol_persona: str) -> str:
        return f"""你是 {kol_nickname}，一個善於捕捉市場熱點的 {kol_persona} 分析師。
專注於話題討論和社群互動，強調話題的社會影響力和討論熱度。"""

    def get_user_prompt(self, topic_title: str, topic_keywords: str) -> str:
        return f"""請針對熱門話題「{topic_title}」生成一篇貼文。
關鍵字：{topic_keywords}
重點：話題的社會影響力、相關新聞、投資機會分析、風險提醒
語氣：輕鬆互動，善於引發討論"""

class LimitUpAfterHoursPromptStrategy:
    def get_system_prompt(self, kol_nickname: str, kol_persona: str) -> str:
        return f"""你是 {kol_nickname}，一個專業的 {kol_persona} 技術分析師。
專注於技術分析和籌碼面，強調漲停原因和後續走勢預測。"""

    def get_user_prompt(self, stock_name: str, stock_code: str) -> str:
        return f"""請針對 {stock_name}({stock_code}) 的盤後漲停生成一篇分析貼文。
重點：漲停原因分析、技術指標解讀、籌碼面分析、後續走勢預測
語氣：專業理性，數據導向"""
```

#### 1.2 整合到現有系統 (30分鐘)
```python
# 修改 src/services/content/content_generator.py
def _get_prompt_strategy(self, trigger_type: str):
    strategies = {
        'trending_topic': TrendingTopicPromptStrategy(),
        'limit_up_after_hours': LimitUpAfterHoursPromptStrategy(),
        'intraday_limit_up': IntradayLimitUpPromptStrategy(),
    }
    return strategies.get(trigger_type, DefaultPromptStrategy())
```

#### 1.3 測試驗證 (30分鐘)
- 測試不同觸發器的 Prompt 差異
- 驗證內容風格符合預期

### 階段 2: 統一 Serper API 整合 (1.5小時)

#### 2.1 創建統一客戶端 (45分鐘)
```python
# src/services/search/unified_serper_client.py
class UnifiedSerperClient:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://google.serper.dev/search"
    
    async def search_news(self, keywords: List[str], num_results: int = 10) -> List[Dict]:
        query = " ".join(keywords)
        # 統一的 API 調用邏輯
        # 錯誤處理和重試機制
        # 結果標準化處理
```

#### 2.2 智能關鍵字生成 (30分鐘)
```python
# src/services/search/keyword_generator.py
class IntelligentKeywordGenerator:
    def __init__(self, openai_client):
        self.openai_client = openai_client
    
    def generate_keywords(self, trigger_type: str, context: Dict) -> List[str]:
        prompt = f"""根據觸發器類型「{trigger_type}」和上下文，生成最優的搜尋關鍵字。
上下文：{context}
返回5-8個關鍵字，用逗號分隔。"""
        
        response = self.openai_client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7
        )
        
        keywords = response.choices[0].message.content.split(',')
        return [kw.strip() for kw in keywords]
```

#### 2.3 替換現有實現 (15分鐘)
- 替換所有 `SerperNewsClient` 實例
- 更新導入語句
- 測試 API 調用

### 階段 3: 智能關鍵字生成 (1小時)

#### 3.1 整合到內容生成流程 (30分鐘)
```python
# 修改 unified_flow_manager.py
async def execute_trending_topic_flow(self, request):
    # 1. 生成智能關鍵字
    keywords = await self.keyword_generator.generate_keywords(
        'trending_topic', 
        {'topic_title': request.topic_title}
    )
    
    # 2. 使用統一 Serper 客戶端搜尋
    news_data = await self.serper_client.search_news(keywords)
    
    # 3. 使用專用 Prompt 策略
    prompt_strategy = self.prompt_strategies.get('trending_topic')
    system_prompt = prompt_strategy.get_system_prompt(
        request.kol_nickname, 
        request.kol_persona
    )
```

#### 3.2 測試和優化 (30分鐘)
- 端到端測試
- 性能優化
- 錯誤處理完善

## 🎯 今日交付成果

### 1. 代碼文件
- `src/services/content/trigger_prompt_strategies.py` - 觸發器專用 Prompt 策略
- `src/services/search/unified_serper_client.py` - 統一 Serper API 客戶端
- `src/services/search/keyword_generator.py` - 智能關鍵字生成器
- 修改現有的 `content_generator.py` 和 `unified_flow_manager.py`

### 2. 功能驗證
- ✅ 熱門話題使用專用 Prompt（不再用漲停分析 Prompt）
- ✅ 盤後漲停使用技術分析 Prompt
- ✅ 統一的 Serper API 調用（消除重複代碼）
- ✅ 智能關鍵字生成（LLM 驅動）

### 3. 預期效果
- **代碼重複率**: 降低 90%
- **內容差異化**: 不同觸發器有明顯風格差異
- **搜尋相關性**: 提升 40%
- **維護效率**: 提升 70%

## ⚡ 快速實施步驟

### 步驟 1: 創建 Prompt 策略 (30分鐘)
```bash
# 1. 創建文件
touch src/services/content/trigger_prompt_strategies.py

# 2. 實現 3 個核心策略類
# - TrendingTopicPromptStrategy
# - LimitUpAfterHoursPromptStrategy  
# - IntradayLimitUpPromptStrategy

# 3. 測試 Prompt 差異
```

### 步驟 2: 統一 Serper API (45分鐘)
```bash
# 1. 創建統一客戶端
touch src/services/search/unified_serper_client.py

# 2. 實現關鍵字生成器
touch src/services/search/keyword_generator.py

# 3. 替換現有實現
# 搜索所有 SerperNewsClient 使用
grep -r "SerperNewsClient" src/
# 逐一替換為 UnifiedSerperClient
```

### 步驟 3: 整合測試 (45分鐘)
```bash
# 1. 修改現有流程
# 2. 端到端測試
# 3. 性能驗證
# 4. 錯誤處理
```

## 🔥 今日完成檢查清單

- [ ] **觸發器專用 Prompt 系統**
  - [ ] TrendingTopicPromptStrategy 實現
  - [ ] LimitUpAfterHoursPromptStrategy 實現
  - [ ] IntradayLimitUpPromptStrategy 實現
  - [ ] 整合到 content_generator.py
  - [ ] 測試 Prompt 差異效果

- [ ] **統一 Serper API 整合**
  - [ ] UnifiedSerperClient 實現
  - [ ] IntelligentKeywordGenerator 實現
  - [ ] 替換所有 SerperNewsClient 實例
  - [ ] 錯誤處理和重試機制
  - [ ] API 調用測試

- [ ] **智能關鍵字生成**
  - [ ] LLM 驅動關鍵字生成
  - [ ] 觸發器專用關鍵字策略
  - [ ] 整合到現有流程
  - [ ] 端到端測試

- [ ] **系統整合**
  - [ ] 修改 unified_flow_manager.py
  - [ ] 更新導入語句
  - [ ] 性能測試
  - [ ] 錯誤處理完善

## 💪 今日完成宣言

**目標**: 4小時內完成智能優化關鍵字系統核心功能
**結果**: 解決 Prompt 重複使用和 Serper API 分散問題
**效果**: 內容差異化 + 代碼統一化 + 維護效率提升

---

**文檔版本**: v1.0 (今日完成版)  
**創建時間**: 2025-01-15  
**完成目標**: 今日 18:00 前
