# æ™ºèƒ½å„ªåŒ–é—œéµå­—ç³»çµ± - ä»Šæ—¥å®Œæˆè¨ˆåŠƒ

## ğŸš€ ä»Šæ—¥ç›®æ¨™ (2025-01-15)

### æ ¸å¿ƒä»»å‹™ (4å°æ™‚å®Œæˆ)
1. **è§¸ç™¼å™¨å°ˆç”¨ Prompt ç³»çµ±** (1.5å°æ™‚)
2. **çµ±ä¸€ Serper API æ•´åˆ** (1.5å°æ™‚)  
3. **æ™ºèƒ½é—œéµå­—ç”Ÿæˆ** (1å°æ™‚)

## âš¡ å¿«é€Ÿå¯¦æ–½è¨ˆåŠƒ

### éšæ®µ 1: è§¸ç™¼å™¨å°ˆç”¨ Prompt ç³»çµ± (1.5å°æ™‚)

#### 1.1 å‰µå»º Prompt ç­–ç•¥é¡ (30åˆ†é˜)
```python
# src/services/content/trigger_prompt_strategies.py
class TrendingTopicPromptStrategy:
    def get_system_prompt(self, kol_nickname: str, kol_persona: str) -> str:
        return f"""ä½ æ˜¯ {kol_nickname}ï¼Œä¸€å€‹å–„æ–¼æ•æ‰å¸‚å ´ç†±é»çš„ {kol_persona} åˆ†æå¸«ã€‚
å°ˆæ³¨æ–¼è©±é¡Œè¨è«–å’Œç¤¾ç¾¤äº’å‹•ï¼Œå¼·èª¿è©±é¡Œçš„ç¤¾æœƒå½±éŸ¿åŠ›å’Œè¨è«–ç†±åº¦ã€‚"""

    def get_user_prompt(self, topic_title: str, topic_keywords: str) -> str:
        return f"""è«‹é‡å°ç†±é–€è©±é¡Œã€Œ{topic_title}ã€ç”Ÿæˆä¸€ç¯‡è²¼æ–‡ã€‚
é—œéµå­—ï¼š{topic_keywords}
é‡é»ï¼šè©±é¡Œçš„ç¤¾æœƒå½±éŸ¿åŠ›ã€ç›¸é—œæ–°èã€æŠ•è³‡æ©Ÿæœƒåˆ†æã€é¢¨éšªæé†’
èªæ°£ï¼šè¼•é¬†äº’å‹•ï¼Œå–„æ–¼å¼•ç™¼è¨è«–"""

class LimitUpAfterHoursPromptStrategy:
    def get_system_prompt(self, kol_nickname: str, kol_persona: str) -> str:
        return f"""ä½ æ˜¯ {kol_nickname}ï¼Œä¸€å€‹å°ˆæ¥­çš„ {kol_persona} æŠ€è¡“åˆ†æå¸«ã€‚
å°ˆæ³¨æ–¼æŠ€è¡“åˆ†æå’Œç±Œç¢¼é¢ï¼Œå¼·èª¿æ¼²åœåŸå› å’Œå¾ŒçºŒèµ°å‹¢é æ¸¬ã€‚"""

    def get_user_prompt(self, stock_name: str, stock_code: str) -> str:
        return f"""è«‹é‡å° {stock_name}({stock_code}) çš„ç›¤å¾Œæ¼²åœç”Ÿæˆä¸€ç¯‡åˆ†æè²¼æ–‡ã€‚
é‡é»ï¼šæ¼²åœåŸå› åˆ†æã€æŠ€è¡“æŒ‡æ¨™è§£è®€ã€ç±Œç¢¼é¢åˆ†æã€å¾ŒçºŒèµ°å‹¢é æ¸¬
èªæ°£ï¼šå°ˆæ¥­ç†æ€§ï¼Œæ•¸æ“šå°å‘"""
```

#### 1.2 æ•´åˆåˆ°ç¾æœ‰ç³»çµ± (30åˆ†é˜)
```python
# ä¿®æ”¹ src/services/content/content_generator.py
def _get_prompt_strategy(self, trigger_type: str):
    strategies = {
        'trending_topic': TrendingTopicPromptStrategy(),
        'limit_up_after_hours': LimitUpAfterHoursPromptStrategy(),
        'intraday_limit_up': IntradayLimitUpPromptStrategy(),
    }
    return strategies.get(trigger_type, DefaultPromptStrategy())
```

#### 1.3 æ¸¬è©¦é©—è­‰ (30åˆ†é˜)
- æ¸¬è©¦ä¸åŒè§¸ç™¼å™¨çš„ Prompt å·®ç•°
- é©—è­‰å…§å®¹é¢¨æ ¼ç¬¦åˆé æœŸ

### éšæ®µ 2: çµ±ä¸€ Serper API æ•´åˆ (1.5å°æ™‚)

#### 2.1 å‰µå»ºçµ±ä¸€å®¢æˆ¶ç«¯ (45åˆ†é˜)
```python
# src/services/search/unified_serper_client.py
class UnifiedSerperClient:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://google.serper.dev/search"
    
    async def search_news(self, keywords: List[str], num_results: int = 10) -> List[Dict]:
        query = " ".join(keywords)
        # çµ±ä¸€çš„ API èª¿ç”¨é‚è¼¯
        # éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶
        # çµæœæ¨™æº–åŒ–è™•ç†
```

#### 2.2 æ™ºèƒ½é—œéµå­—ç”Ÿæˆ (30åˆ†é˜)
```python
# src/services/search/keyword_generator.py
class IntelligentKeywordGenerator:
    def __init__(self, openai_client):
        self.openai_client = openai_client
    
    def generate_keywords(self, trigger_type: str, context: Dict) -> List[str]:
        prompt = f"""æ ¹æ“šè§¸ç™¼å™¨é¡å‹ã€Œ{trigger_type}ã€å’Œä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆæœ€å„ªçš„æœå°‹é—œéµå­—ã€‚
ä¸Šä¸‹æ–‡ï¼š{context}
è¿”å›5-8å€‹é—œéµå­—ï¼Œç”¨é€—è™Ÿåˆ†éš”ã€‚"""
        
        response = self.openai_client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7
        )
        
        keywords = response.choices[0].message.content.split(',')
        return [kw.strip() for kw in keywords]
```

#### 2.3 æ›¿æ›ç¾æœ‰å¯¦ç¾ (15åˆ†é˜)
- æ›¿æ›æ‰€æœ‰ `SerperNewsClient` å¯¦ä¾‹
- æ›´æ–°å°å…¥èªå¥
- æ¸¬è©¦ API èª¿ç”¨

### éšæ®µ 3: æ™ºèƒ½é—œéµå­—ç”Ÿæˆ (1å°æ™‚)

#### 3.1 æ•´åˆåˆ°å…§å®¹ç”Ÿæˆæµç¨‹ (30åˆ†é˜)
```python
# ä¿®æ”¹ unified_flow_manager.py
async def execute_trending_topic_flow(self, request):
    # 1. ç”Ÿæˆæ™ºèƒ½é—œéµå­—
    keywords = await self.keyword_generator.generate_keywords(
        'trending_topic', 
        {'topic_title': request.topic_title}
    )
    
    # 2. ä½¿ç”¨çµ±ä¸€ Serper å®¢æˆ¶ç«¯æœå°‹
    news_data = await self.serper_client.search_news(keywords)
    
    # 3. ä½¿ç”¨å°ˆç”¨ Prompt ç­–ç•¥
    prompt_strategy = self.prompt_strategies.get('trending_topic')
    system_prompt = prompt_strategy.get_system_prompt(
        request.kol_nickname, 
        request.kol_persona
    )
```

#### 3.2 æ¸¬è©¦å’Œå„ªåŒ– (30åˆ†é˜)
- ç«¯åˆ°ç«¯æ¸¬è©¦
- æ€§èƒ½å„ªåŒ–
- éŒ¯èª¤è™•ç†å®Œå–„

## ğŸ¯ ä»Šæ—¥äº¤ä»˜æˆæœ

### 1. ä»£ç¢¼æ–‡ä»¶
- `src/services/content/trigger_prompt_strategies.py` - è§¸ç™¼å™¨å°ˆç”¨ Prompt ç­–ç•¥
- `src/services/search/unified_serper_client.py` - çµ±ä¸€ Serper API å®¢æˆ¶ç«¯
- `src/services/search/keyword_generator.py` - æ™ºèƒ½é—œéµå­—ç”Ÿæˆå™¨
- ä¿®æ”¹ç¾æœ‰çš„ `content_generator.py` å’Œ `unified_flow_manager.py`

### 2. åŠŸèƒ½é©—è­‰
- âœ… ç†±é–€è©±é¡Œä½¿ç”¨å°ˆç”¨ Promptï¼ˆä¸å†ç”¨æ¼²åœåˆ†æ Promptï¼‰
- âœ… ç›¤å¾Œæ¼²åœä½¿ç”¨æŠ€è¡“åˆ†æ Prompt
- âœ… çµ±ä¸€çš„ Serper API èª¿ç”¨ï¼ˆæ¶ˆé™¤é‡è¤‡ä»£ç¢¼ï¼‰
- âœ… æ™ºèƒ½é—œéµå­—ç”Ÿæˆï¼ˆLLM é©…å‹•ï¼‰

### 3. é æœŸæ•ˆæœ
- **ä»£ç¢¼é‡è¤‡ç‡**: é™ä½ 90%
- **å…§å®¹å·®ç•°åŒ–**: ä¸åŒè§¸ç™¼å™¨æœ‰æ˜é¡¯é¢¨æ ¼å·®ç•°
- **æœå°‹ç›¸é—œæ€§**: æå‡ 40%
- **ç¶­è­·æ•ˆç‡**: æå‡ 70%

## âš¡ å¿«é€Ÿå¯¦æ–½æ­¥é©Ÿ

### æ­¥é©Ÿ 1: å‰µå»º Prompt ç­–ç•¥ (30åˆ†é˜)
```bash
# 1. å‰µå»ºæ–‡ä»¶
touch src/services/content/trigger_prompt_strategies.py

# 2. å¯¦ç¾ 3 å€‹æ ¸å¿ƒç­–ç•¥é¡
# - TrendingTopicPromptStrategy
# - LimitUpAfterHoursPromptStrategy  
# - IntradayLimitUpPromptStrategy

# 3. æ¸¬è©¦ Prompt å·®ç•°
```

### æ­¥é©Ÿ 2: çµ±ä¸€ Serper API (45åˆ†é˜)
```bash
# 1. å‰µå»ºçµ±ä¸€å®¢æˆ¶ç«¯
touch src/services/search/unified_serper_client.py

# 2. å¯¦ç¾é—œéµå­—ç”Ÿæˆå™¨
touch src/services/search/keyword_generator.py

# 3. æ›¿æ›ç¾æœ‰å¯¦ç¾
# æœç´¢æ‰€æœ‰ SerperNewsClient ä½¿ç”¨
grep -r "SerperNewsClient" src/
# é€ä¸€æ›¿æ›ç‚º UnifiedSerperClient
```

### æ­¥é©Ÿ 3: æ•´åˆæ¸¬è©¦ (45åˆ†é˜)
```bash
# 1. ä¿®æ”¹ç¾æœ‰æµç¨‹
# 2. ç«¯åˆ°ç«¯æ¸¬è©¦
# 3. æ€§èƒ½é©—è­‰
# 4. éŒ¯èª¤è™•ç†
```

## ğŸ”¥ ä»Šæ—¥å®Œæˆæª¢æŸ¥æ¸…å–®

- [ ] **è§¸ç™¼å™¨å°ˆç”¨ Prompt ç³»çµ±**
  - [ ] TrendingTopicPromptStrategy å¯¦ç¾
  - [ ] LimitUpAfterHoursPromptStrategy å¯¦ç¾
  - [ ] IntradayLimitUpPromptStrategy å¯¦ç¾
  - [ ] æ•´åˆåˆ° content_generator.py
  - [ ] æ¸¬è©¦ Prompt å·®ç•°æ•ˆæœ

- [ ] **çµ±ä¸€ Serper API æ•´åˆ**
  - [ ] UnifiedSerperClient å¯¦ç¾
  - [ ] IntelligentKeywordGenerator å¯¦ç¾
  - [ ] æ›¿æ›æ‰€æœ‰ SerperNewsClient å¯¦ä¾‹
  - [ ] éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶
  - [ ] API èª¿ç”¨æ¸¬è©¦

- [ ] **æ™ºèƒ½é—œéµå­—ç”Ÿæˆ**
  - [ ] LLM é©…å‹•é—œéµå­—ç”Ÿæˆ
  - [ ] è§¸ç™¼å™¨å°ˆç”¨é—œéµå­—ç­–ç•¥
  - [ ] æ•´åˆåˆ°ç¾æœ‰æµç¨‹
  - [ ] ç«¯åˆ°ç«¯æ¸¬è©¦

- [ ] **ç³»çµ±æ•´åˆ**
  - [ ] ä¿®æ”¹ unified_flow_manager.py
  - [ ] æ›´æ–°å°å…¥èªå¥
  - [ ] æ€§èƒ½æ¸¬è©¦
  - [ ] éŒ¯èª¤è™•ç†å®Œå–„

## ğŸ’ª ä»Šæ—¥å®Œæˆå®£è¨€

**ç›®æ¨™**: 4å°æ™‚å…§å®Œæˆæ™ºèƒ½å„ªåŒ–é—œéµå­—ç³»çµ±æ ¸å¿ƒåŠŸèƒ½
**çµæœ**: è§£æ±º Prompt é‡è¤‡ä½¿ç”¨å’Œ Serper API åˆ†æ•£å•é¡Œ
**æ•ˆæœ**: å…§å®¹å·®ç•°åŒ– + ä»£ç¢¼çµ±ä¸€åŒ– + ç¶­è­·æ•ˆç‡æå‡

---

**æ–‡æª”ç‰ˆæœ¬**: v1.0 (ä»Šæ—¥å®Œæˆç‰ˆ)  
**å‰µå»ºæ™‚é–“**: 2025-01-15  
**å®Œæˆç›®æ¨™**: ä»Šæ—¥ 18:00 å‰
