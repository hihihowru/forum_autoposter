# è§¸ç™¼å™¨ç³»çµ±èˆ‡æ•¸æ“šæ•´åˆæ¶æ§‹å®Œæ•´ç›¤é»

## ğŸ¯ è§¸ç™¼å™¨ç³»çµ±ç¾ç‹€åˆ†æ

### âœ… **å·²å¯¦ç¾çš„è§¸ç™¼å™¨**

| è§¸ç™¼å™¨ | ç‹€æ…‹ | å¯¦ç¾ç¨‹åº¦ | å‚™è¨» |
|--------|------|----------|------|
| **AFTER_HOURS_LIMIT_UP** | âœ… å®Œå…¨å¯¦ç¾ | 100% | ç›¤å¾Œæ¼²åœè‚¡å›é¡§ï¼ŒåŒ…å«é«˜é‡/ä½é‡åˆ†é¡ |
| **INTRADAY_SURGE_STOCKS** | âœ… å®Œå…¨å¯¦ç¾ | 100% | ç›¤ä¸­æ€¥æ¼²è‚¡ï¼Œ17æ”¯è‚¡ç¥¨è™•ç† |
| **TRENDING_TOPICS** | âŒ åƒ…æ¡†æ¶ | 10% | åªæœ‰ç©ºæ®¼å¯¦ç¾ï¼Œç„¡å¯¦éš›é‚è¼¯ |
| **LIMIT_UP_STOCKS** | âŒ åƒ…æ¡†æ¶ | 10% | åªæœ‰ç©ºæ®¼å¯¦ç¾ï¼Œç„¡å¯¦éš›é‚è¼¯ |
| **HOT_STOCKS** | âŒ åƒ…æ¡†æ¶ | 10% | åªæœ‰ç©ºæ®¼å¯¦ç¾ï¼Œç„¡å¯¦éš›é‚è¼¯ |
| **INDUSTRY_ANALYSIS** | âŒ åƒ…æ¡†æ¶ | 10% | åªæœ‰ç©ºæ®¼å¯¦ç¾ï¼Œç„¡å¯¦éš›é‚è¼¯ |
| **MONTHLY_REVENUE** | âŒ åƒ…æ¡†æ¶ | 10% | åªæœ‰ç©ºæ®¼å¯¦ç¾ï¼Œç„¡å¯¦éš›é‚è¼¯ |
| **HIGH_VOLUME** | âŒ åƒ…æ¡†æ¶ | 10% | åªæœ‰ç©ºæ®¼å¯¦ç¾ï¼Œç„¡å¯¦éš›é‚è¼¯ |
| **NEWS_SUMMARY** | âŒ åƒ…æ¡†æ¶ | 10% | åªæœ‰ç©ºæ®¼å¯¦ç¾ï¼Œç„¡å¯¦éš›é‚è¼¯ |

### ğŸš¨ **å•é¡Œåˆ†æ**

**å¯¦éš›å¯ç”¨è§¸ç™¼å™¨ï¼šåƒ…2å€‹**
- ç›¤å¾Œæ¼²åœè‚¡å›é¡§ (AFTER_HOURS_LIMIT_UP)
- ç›¤ä¸­æ€¥æ¼²è‚¡ (INTRADAY_SURGE_STOCKS)

**å…¶ä»–7å€‹è§¸ç™¼å™¨ï¼šåƒ…æœ‰æ¡†æ¶ï¼Œç„¡å¯¦éš›å¯¦ç¾**

## ğŸ“¡ Finlab API æ•¸æ“šæ•´åˆæ¶æ§‹

### ğŸ”„ **Raw Data â†’ å¯è§£é‡‹å±¤ å®Œæ•´æµç¨‹**

```mermaid
graph TD
    A[Finlab API Raw Data] --> B[æ•¸æ“šæå–å±¤]
    B --> C[æ•¸æ“šé©—è­‰å±¤]
    C --> D[æ•¸æ“šè½‰æ›å±¤]
    D --> E[å¯è§£é‡‹å±¤]
    
    subgraph "Raw Data Sources"
        A1[price:é–‹ç›¤åƒ¹]
        A2[price:æœ€é«˜åƒ¹]
        A3[price:æœ€ä½åƒ¹]
        A4[price:æ”¶ç›¤åƒ¹]
        A5[price:æˆäº¤è‚¡æ•¸]
        A6[price:æˆäº¤é‡‘é¡]
        A7[financial_statement:ç‡Ÿæ¥­æ”¶å…¥æ·¨é¡]
        A8[financial_statement:æ¯è‚¡ç›ˆé¤˜]
        A9[financial_statement:æ¯›åˆ©ç‡]
        A10[monthly_revenue:æœˆç‡Ÿæ”¶]
    end
    
    subgraph "å¯è§£é‡‹å±¤çµ„ä»¶"
        E1[æŠ€è¡“é¢åƒ¹å€¼æå–å™¨]
        E2[è²¡å ±åˆ†æå™¨]
        E3[æœˆç‡Ÿæ”¶åˆ†æå™¨]
        E4[é‡åƒ¹é—œä¿‚åˆ†æå™¨]
        E5[è¶¨å‹¢è­˜åˆ¥å™¨]
    end
```

### ğŸ“Š **æ•¸æ“šæºè©³ç´°æ˜ å°„**

#### 1. **è‚¡åƒ¹ OHLC æ•¸æ“š**
```python
# Raw Data
price:é–‹ç›¤åƒ¹ â†’ open_price
price:æœ€é«˜åƒ¹ â†’ high_price  
price:æœ€ä½åƒ¹ â†’ low_price
price:æ”¶ç›¤åƒ¹ â†’ close_price
price:æˆäº¤è‚¡æ•¸ â†’ volume_shares
price:æˆäº¤é‡‘é¡ â†’ volume_amount

# å¯è§£é‡‹å±¤è™•ç†
â†“
æŠ€è¡“é¢åƒ¹å€¼æå–å™¨ (TechnicalValueExtractor)
- è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ (MACD, KD, RSI, å¸ƒæ—é€šé“)
- è­˜åˆ¥æ”¯æ’å£“åŠ›ä½
- åˆ†æè¶¨å‹¢æ–¹å‘
- è¨ˆç®—æ³¢å‹•ç‡
- é‡åƒ¹é—œä¿‚åˆ†æ
```

#### 2. **è²¡å ±æ•¸æ“š**
```python
# Raw Data
financial_statement:ç‡Ÿæ¥­æ”¶å…¥æ·¨é¡ â†’ revenue
financial_statement:æ¯è‚¡ç›ˆé¤˜ â†’ eps
financial_statement:æ¯›åˆ©ç‡ â†’ gross_margin
financial_statement:è³‡ç”¢ç¸½é¡ â†’ total_assets
financial_statement:è² å‚µç¸½é¡ â†’ total_liabilities

# å¯è§£é‡‹å±¤è™•ç†
â†“
è²¡å ±åˆ†æå™¨ (FinancialAnalyzer)
- ç‡Ÿæ”¶æˆé•·ç‡åˆ†æ
- ç²åˆ©èƒ½åŠ›è©•ä¼°
- è²¡å‹™çµæ§‹åˆ†æ
- åŒæ¥­æ¯”è¼ƒåˆ†æ
- è²¡å‹™å¥åº·åº¦è©•åˆ†
```

#### 3. **æœˆç‡Ÿæ”¶æ•¸æ“š**
```python
# Raw Data
monthly_revenue:æœˆç‡Ÿæ”¶ â†’ monthly_revenue

# å¯è§£é‡‹å±¤è™•ç†
â†“
æœˆç‡Ÿæ”¶åˆ†æå™¨ (MonthlyRevenueAnalyzer)
- æœˆç‡Ÿæ”¶æˆé•·ç‡è¨ˆç®—
- å­£ç¯€æ€§åˆ†æ
- è¶¨å‹¢è­˜åˆ¥
- é æœŸvså¯¦éš›æ¯”è¼ƒ
- ç‡Ÿæ”¶å“è³ªè©•ä¼°
```

## ğŸ—ï¸ **å®Œæ•´æ•¸æ“šæ•´åˆæ¶æ§‹è¨­è¨ˆ**

### 1. **æ•¸æ“šæå–å±¤ (Data Extraction Layer)**

```python
class FinlabDataExtractor:
    """Finlabæ•¸æ“šæå–å™¨"""
    
    async def extract_ohlc_data(self, stock_id: str) -> OHLCData:
        """æå–OHLCæ•¸æ“š"""
        return {
            'open': fdata.get('price:é–‹ç›¤åƒ¹')[stock_id],
            'high': fdata.get('price:æœ€é«˜åƒ¹')[stock_id],
            'low': fdata.get('price:æœ€ä½åƒ¹')[stock_id],
            'close': fdata.get('price:æ”¶ç›¤åƒ¹')[stock_id],
            'volume_shares': fdata.get('price:æˆäº¤è‚¡æ•¸')[stock_id],
            'volume_amount': fdata.get('price:æˆäº¤é‡‘é¡')[stock_id]
        }
    
    async def extract_financial_data(self, stock_id: str) -> FinancialData:
        """æå–è²¡å ±æ•¸æ“š"""
        return {
            'revenue': fdata.get('financial_statement:ç‡Ÿæ¥­æ”¶å…¥æ·¨é¡')[stock_id],
            'eps': fdata.get('financial_statement:æ¯è‚¡ç›ˆé¤˜')[stock_id],
            'gross_margin': fdata.get('financial_statement:æ¯›åˆ©ç‡')[stock_id],
            'total_assets': fdata.get('financial_statement:è³‡ç”¢ç¸½é¡')[stock_id],
            'total_liabilities': fdata.get('financial_statement:è² å‚µç¸½é¡')[stock_id]
        }
    
    async def extract_monthly_revenue(self, stock_id: str) -> MonthlyRevenueData:
        """æå–æœˆç‡Ÿæ”¶æ•¸æ“š"""
        return fdata.get('monthly_revenue:æœˆç‡Ÿæ”¶')[stock_id]
```

### 2. **æŠ€è¡“é¢åƒ¹å€¼æå–å™¨ (å·²å¯¦ç¾ä¸¦å„ªåŒ–)**

**ç¾æœ‰å¯¦ç¾ï¼š**
- âœ… `EnhancedTechnicalAnalyzer` - å¢å¼·ç‰ˆæŠ€è¡“åˆ†æå™¨
- âœ… `TechnicalAnalyzer` - åŸºç¤æŠ€è¡“åˆ†æå™¨
- âœ… `OHLCCacheManager` - OHLCæ•¸æ“šç·©å­˜ç®¡ç†

**é—œéµæ”¹é€² (åŸºæ–¼ä¹‹å‰Feedback)ï¼š**

#### A. **è©•åˆ†æ¨™æº–å„ªåŒ–**
```python
# èª¿æ•´å‰ï¼šé–€æª»éé«˜ï¼Œé›£ä»¥è§¸ç™¼ä¿¡è™Ÿ
if deviation > 5:  # 5%é–€æª»å¤ªé«˜
    score = 2

# èª¿æ•´å¾Œï¼šæ›´å¯¬é¬†çš„æ¨™æº–
if deviation > 3:  # é™ä½è‡³3%
    score = 2
elif deviation > 1:  # é™ä½è‡³1%
    score = 1.5
else:
    score = 1  # æé«˜å¾®å¹…çªç ´åˆ†æ•¸
```

#### B. **ä¿¡å¿ƒåº¦é–€æª»é™ä½**
```python
# èª¿æ•´å‰ï¼šä¿¡å¿ƒåº¦é–€æª»éé«˜
if indicator.confidence >= 60:  # 60%é–€æª»å¤ªé«˜

# èª¿æ•´å¾Œï¼šé™ä½é–€æª»
if indicator.confidence >= 15:  # é™ä½è‡³15%
```

#### C. **è©•åˆ†æ©Ÿåˆ¶æ”¹é€²**
```python
# æ¬Šé‡åˆ†é…å„ªåŒ–
weights = {
    "moving_averages": 0.25,    # å‡ç·š 25%
    "macd": 0.20,              # MACD 20%
    "kd": 0.15,                # KD 15%
    "rsi": 0.15,               # RSI 15%
    "bollinger_bands": 0.15,   # å¸ƒæ—é€šé“ 15%
    "volume": 0.10,            # æˆäº¤é‡ 10%
    "volatility": 0.05          # æ³¢å‹•ç‡ 5%
}

# è©•åˆ†è½‰æ›ï¼š-5åˆ°+5 â†’ 0åˆ°10åˆ†åˆ¶
raw_score = total_weighted_score / total_weight
overall_score = raw_score + 5  # è½‰ç‚º0åˆ°10åˆ†åˆ¶
```

**æ”¯æ´çš„æŠ€è¡“æŒ‡æ¨™ï¼š**
- âœ… ç§»å‹•å¹³å‡ç·š (5/10/20/60/120/240æ—¥)
- âœ… MACD (12/26/9)
- âœ… KDæŒ‡æ¨™ (9/3/3)
- âœ… RSI (14æ—¥)
- âœ… å¸ƒæ—é€šé“ (20æ—¥, 2å€æ¨™æº–å·®)
- âœ… æˆäº¤é‡åˆ†æ
- âœ… æ³¢å‹•ç‡åˆ†æ

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
# ä½¿ç”¨å¢å¼·ç‰ˆæŠ€è¡“åˆ†æå™¨
analyzer = EnhancedTechnicalAnalyzer()
analysis = await analyzer.get_enhanced_stock_analysis("2330", "å°ç©é›»")

# ç²å–çµæœ
print(f"ç¶œåˆè©•åˆ†: {analysis.overall_score}/10")
print(f"ä¿¡å¿ƒåº¦: {analysis.confidence_score}%")
print(f"æœ‰æ•ˆæŒ‡æ¨™: {analysis.effective_indicators}")
print(f"æ‘˜è¦: {analysis.summary}")
```
    
    def _analyze_trend(self, ohlc_data: OHLCData) -> TrendAnalysis:
        """åˆ†æè¶¨å‹¢"""
        return {
            'short_term_trend': self._determine_short_term_trend(ohlc_data),
            'medium_term_trend': self._determine_medium_term_trend(ohlc_data),
            'long_term_trend': self._determine_long_term_trend(ohlc_data),
            'trend_strength': self._calculate_trend_strength(ohlc_data),
            'trend_duration': self._calculate_trend_duration(ohlc_data)
        }
```

### 3. **è²¡å ±åˆ†æå™¨ (Financial Analyzer)**

```python
class FinancialAnalyzer:
    """è²¡å ±åˆ†æå™¨"""
    
    async def analyze_financial_data(self, financial_data: FinancialData) -> FinancialAnalysis:
        """åˆ†æè²¡å ±æ•¸æ“š"""
        
        # ç‡Ÿæ”¶åˆ†æ
        revenue_analysis = self._analyze_revenue(financial_data.revenue)
        
        # ç²åˆ©åˆ†æ
        profitability_analysis = self._analyze_profitability(financial_data)
        
        # è²¡å‹™çµæ§‹åˆ†æ
        structure_analysis = self._analyze_financial_structure(financial_data)
        
        # æˆé•·æ€§åˆ†æ
        growth_analysis = self._analyze_growth(financial_data)
        
        return FinancialAnalysis(
            revenue_analysis=revenue_analysis,
            profitability_analysis=profitability_analysis,
            structure_analysis=structure_analysis,
            growth_analysis=growth_analysis,
            financial_score=self._calculate_financial_score(financial_data),
            investment_grade=self._determine_investment_grade(financial_data)
        )
    
    def _analyze_revenue(self, revenue_data: pd.Series) -> RevenueAnalysis:
        """ç‡Ÿæ”¶åˆ†æ"""
        return {
            'revenue_growth_rate': self._calculate_revenue_growth_rate(revenue_data),
            'revenue_volatility': self._calculate_revenue_volatility(revenue_data),
            'revenue_trend': self._determine_revenue_trend(revenue_data),
            'revenue_quality': self._assess_revenue_quality(revenue_data)
        }
```

### 4. **æœˆç‡Ÿæ”¶åˆ†æå™¨ (Monthly Revenue Analyzer)**

```python
class MonthlyRevenueAnalyzer:
    """æœˆç‡Ÿæ”¶åˆ†æå™¨"""
    
    async def analyze_monthly_revenue(self, monthly_revenue_data: MonthlyRevenueData) -> MonthlyRevenueAnalysis:
        """åˆ†ææœˆç‡Ÿæ”¶æ•¸æ“š"""
        
        # æˆé•·ç‡åˆ†æ
        growth_analysis = self._analyze_growth_rate(monthly_revenue_data)
        
        # å­£ç¯€æ€§åˆ†æ
        seasonal_analysis = self._analyze_seasonality(monthly_revenue_data)
        
        # è¶¨å‹¢åˆ†æ
        trend_analysis = self._analyze_revenue_trend(monthly_revenue_data)
        
        # é æœŸvså¯¦éš›
        expectation_analysis = self._compare_with_expectations(monthly_revenue_data)
        
        return MonthlyRevenueAnalysis(
            growth_analysis=growth_analysis,
            seasonal_analysis=seasonal_analysis,
            trend_analysis=trend_analysis,
            expectation_analysis=expectation_analysis,
            revenue_score=self._calculate_revenue_score(monthly_revenue_data),
            surprise_factor=self._calculate_surprise_factor(monthly_revenue_data)
        )
```

### 5. **çµ±ä¸€æ•¸æ“šæ•´åˆå™¨ (Unified Data Integrator)**

```python
class UnifiedDataIntegrator:
    """çµ±ä¸€æ•¸æ“šæ•´åˆå™¨"""
    
    def __init__(self):
        self.data_extractor = FinlabDataExtractor()
        self.technical_extractor = TechnicalValueExtractor()
        self.financial_analyzer = FinancialAnalyzer()
        self.revenue_analyzer = MonthlyRevenueAnalyzer()
    
    async def integrate_stock_data(self, stock_id: str) -> IntegratedStockData:
        """æ•´åˆè‚¡ç¥¨æ•¸æ“š"""
        
        # 1. æå–åŸå§‹æ•¸æ“š
        ohlc_data = await self.data_extractor.extract_ohlc_data(stock_id)
        financial_data = await self.data_extractor.extract_financial_data(stock_id)
        monthly_revenue_data = await self.data_extractor.extract_monthly_revenue(stock_id)
        
        # 2. è½‰æ›ç‚ºå¯è§£é‡‹å±¤
        technical_value = await self.technical_extractor.extract_technical_value(ohlc_data)
        financial_analysis = await self.financial_analyzer.analyze_financial_data(financial_data)
        revenue_analysis = await self.revenue_analyzer.analyze_monthly_revenue(monthly_revenue_data)
        
        # 3. æ•´åˆåˆ†æçµæœ
        integrated_analysis = self._integrate_analysis_results(
            technical_value, financial_analysis, revenue_analysis
        )
        
        return IntegratedStockData(
            stock_id=stock_id,
            raw_data={
                'ohlc': ohlc_data,
                'financial': financial_data,
                'monthly_revenue': monthly_revenue_data
            },
            interpreted_data={
                'technical': technical_value,
                'financial': financial_analysis,
                'revenue': revenue_analysis
            },
            integrated_analysis=integrated_analysis,
            overall_score=self._calculate_overall_score(integrated_analysis),
            data_quality_score=self._assess_data_quality(ohlc_data, financial_data, monthly_revenue_data)
        )
```

## ğŸ¯ **è§¸ç™¼å™¨å¯¦ç¾å„ªå…ˆç´š**

### éšæ®µä¸€ï¼šæ ¸å¿ƒè§¸ç™¼å™¨ (ç«‹å³å¯¦ç¾)
1. **TRENDING_TOPICS** - ç†±é–€è©±é¡Œè§¸ç™¼å™¨
2. **LIMIT_UP_STOCKS** - æ¼²åœè‚¡è§¸ç™¼å™¨
3. **HOT_STOCKS** - ç†±é–€è‚¡è§¸ç™¼å™¨

### éšæ®µäºŒï¼šåˆ†æè§¸ç™¼å™¨ (2-3é€±)
4. **INDUSTRY_ANALYSIS** - ç”¢æ¥­åˆ†æè§¸ç™¼å™¨
5. **HIGH_VOLUME** - é«˜æˆäº¤é‡è§¸ç™¼å™¨

### éšæ®µä¸‰ï¼šè²¡å ±è§¸ç™¼å™¨ (3-4é€±)
6. **MONTHLY_REVENUE** - æœˆç‡Ÿæ”¶å…¬å‘Šè§¸ç™¼å™¨
7. **NEWS_SUMMARY** - æ–°èç¸½çµè§¸ç™¼å™¨

## ğŸ“‹ **å¯¦æ–½å»ºè­°**

### 1. **ç«‹å³è¡Œå‹•**
- å¯¦ç¾ç¼ºå¤±çš„7å€‹è§¸ç™¼å™¨æ¡†æ¶
- å®Œå–„Finlabæ•¸æ“šæ•´åˆæ¶æ§‹
- å»ºç«‹çµ±ä¸€çš„æ•¸æ“šå¯è§£é‡‹å±¤

### 2. **çŸ­æœŸç›®æ¨™**
- å®ŒæˆæŠ€è¡“é¢åƒ¹å€¼æå–å™¨
- å¯¦ç¾è²¡å ±åˆ†æå™¨
- å»ºç«‹æœˆç‡Ÿæ”¶åˆ†æå™¨

### 3. **ä¸­æœŸç›®æ¨™**
- æ•´åˆæ‰€æœ‰æ•¸æ“šæº
- å»ºç«‹çµ±ä¸€çš„æ•¸æ“šæ•´åˆå™¨
- å¯¦ç¾æ™ºèƒ½æ•¸æ“šèª¿åº¦

### 4. **é•·æœŸç›®æ¨™**
- å»ºç«‹æŒçºŒå­¸ç¿’æ©Ÿåˆ¶
- å„ªåŒ–æ•¸æ“šå“è³ªæ§åˆ¶
- å¯¦ç¾é æ¸¬æ€§åˆ†æ

## ğŸ‰ **ç¸½çµ**

**ç•¶å‰ç‹€æ³ï¼š**
- âœ… 2å€‹è§¸ç™¼å™¨å®Œå…¨å¯¦ç¾
- âŒ 7å€‹è§¸ç™¼å™¨åƒ…æœ‰æ¡†æ¶
- âœ… Finlab APIæ•´åˆéƒ¨åˆ†å¯¦ç¾
- âŒ æ•¸æ“šå¯è§£é‡‹å±¤ä¸å®Œæ•´

**æ ¸å¿ƒå•é¡Œï¼š**
- è§¸ç™¼å™¨å¯¦ç¾ä¸å®Œæ•´
- æ•¸æ“šæ•´åˆæ¶æ§‹ç¼ºä¹çµ±ä¸€æ€§
- å¯è§£é‡‹å±¤çµ„ä»¶åˆ†æ•£ä¸”ä¸å®Œæ•´

**è§£æ±ºæ–¹æ¡ˆï¼š**
- å„ªå…ˆå¯¦ç¾æ ¸å¿ƒè§¸ç™¼å™¨
- å»ºç«‹çµ±ä¸€çš„æ•¸æ“šæ•´åˆæ¶æ§‹
- å®Œå–„æŠ€è¡“é¢ã€è²¡å ±ã€æœˆç‡Ÿæ”¶åˆ†æå™¨
- å¯¦ç¾çµ±ä¸€çš„æ•¸æ“šå¯è§£é‡‹å±¤
