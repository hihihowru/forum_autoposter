# 1.2 系統架構與AI流程

## 系統架構概覽

### 1. 高層架構圖&#x20;

```mermaid
graph TB
    subgraph "觸發器層 (Trigger Layer)"
        A[熱門話題觸發器] --> D[話題分類器]
        B[漲停股觸發器] --> D
        C1[熱門股觸發器] --> D
        C2[產業類股漲跌總評觸發器] --> D
        C3[台指期盤後分析觸發器] --> D
        C4[月營收公告觸發器] --> D
        C5[高成交量股票觸發器] --> D
        C6[外部新聞連結總結觸發器] --> D
    end
    
    subgraph "AI 核心引擎 (Core Engine)"
        D --> E[KOL 配對器]
        E --> F[數據調度器]
        F --> G[內容生成引擎]
        G --> H[品質檢查器]
    end
    
    subgraph "數據層 (Data Layer)"
        I[CMoney API] --> F
        J[Finlab API] --> F
        K[Serper API] --> F
        L[Google Sheets] --> E
    end
    
    subgraph "發布層 (Publishing Layer)"
        H --> M[發布引擎]
        M --> N[CMoney 平台]
        M --> O[Google Sheets 記錄]
    end
    
    subgraph "運營層 (Operations Layer)"
        P[儀表板] --> Q[監控系統]
        R[互動分析] --> Q
    end
```

### 2. 詳細架構圖

```mermaid
graph TD
    subgraph "觸發器層"
        A1[CMoney 熱門話題 API] --> A2[話題分類器]
        A2 --> A3[話題分派器]
        B1[漲停股數據源] --> B2[股票篩選器]
        B2 --> B3[相關股票提取器]
        C1[熱門股數據源] --> C2[熱門股篩選器]
        C2 --> C3[熱門股分析器]
        D1[產業類股數據源] --> D2[產業分析器]
        D2 --> D3[漲跌總評生成器]
        E1[台指期數據源] --> E2[期貨分析器]
        E2 --> E3[盤後分析生成器]
        F1[月營收數據源] --> F2[營收分析器]
        F2 --> F3[公告內容生成器]
        G1[高成交量數據源] --> G2[成交量分析器]
        G2 --> G3[高波動分析器]
        H1[外部新聞API] --> H2[新聞聚合器]
        H2 --> H3[新聞總結生成器]
    end
    
    subgraph "KOL 管理層"
        C1[Google Sheets KOL 資料] --> C2[KOL 配對器]
        C2 --> C3[數據偏好檢查器]
    end
    
    subgraph "數據調度層"
        D1[數據源排除清單] --> D2[智能數據調度器]
        D2 --> D3[數據可解釋性提取器]
        D3 --> D4[數據亮點生成器]
    end
    
    subgraph "內容生成層"
        E1[個人化提示詞生成器] --> E2[OpenAI LLM]
        E2 --> E3[內容品質檢查器]
        E3 --> E4[內容優化器]
    end
    
    subgraph "發布管理層"
        F1[發布策略管理器] --> F2[CMoney 發布器]
        F2 --> F3[狀態更新器]
        F3 --> F4[Google Sheets 記錄器]
    end
    
    A3 --> C2
    B3 --> C2
    C3 --> C2
    D3 --> C2
    E3 --> C2
    F3 --> C2
    G3 --> C2
    H3 --> C2
    C3 --> D1
    D4 --> E1
    E4 --> F1
```

## 觸發器設計理念

### 多維度市場監控

系統設計了多個觸發器來全面監控市場動態，確保能夠捕捉到各種吸引投資者討論的題材：

1. **熱門話題觸發器**：捕捉市場熱點和投資者關注焦點
2. **漲停股觸發器**：識別強勢股票和市場熱點
3. **熱門股觸發器**：監控持續受關注的股票
4. **產業類股漲跌總評觸發器**：提供產業層面的分析視角
5. **台指期盤後分析觸發器**：覆蓋期貨市場分析
6. **月營收公告觸發器**：處理基本面重要數據
7. **高成交量股票觸發器**：捕捉高波動機會
8. **外部新聞連結總結觸發器**：整合外部資訊源

### 題材吸引力策略

每個觸發器都專注於特定類型的市場題材，確保生成的內容能夠：

* **引發討論**：選擇有爭議性或討論價值的題材
* **提供價值**：為投資者提供有用的分析資訊
* **保持時效性**：及時捕捉市場動態
* **多角度分析**：從不同維度提供市場觀點

## 核心流程詳解

### 流程一：熱門話題觸發器

```mermaid
sequenceDiagram
    participant T as 觸發器
    participant C as CMoney API
    participant K as KOL 配對器
    participant D as 數據調度器
    participant G as 內容生成器
    participant S as Google Sheets
    
    T->>C: 獲取熱門話題列表
    C-->>T: 返回話題數據
    T->>T: 話題分類與排序
    T->>K: 傳遞話題資訊
    K->>S: 讀取 KOL 資料
    S-->>K: 返回 KOL 列表
    K->>K: KOL 匹配與分配
    K->>D: 傳遞 KOL 偏好
    D->>D: 根據偏好調度數據
    D->>G: 傳遞數據素材
    G->>G: 生成個人化內容
    G->>S: 記錄生成結果
```

### 流程三：多觸發器協作流程

```mermaid
sequenceDiagram
    participant T1 as 熱門話題觸發器
    participant T2 as 漲停股觸發器
    participant T3 as 熱門股觸發器
    participant T4 as 產業類股觸發器
    participant T5 as 台指期觸發器
    participant T6 as 月營收觸發器
    participant T7 as 高成交量觸發器
    participant T8 as 外部新聞觸發器
    participant C as 話題分類器
    participant K as KOL 配對器
    participant D as 數據調度器
    participant G as 內容生成器
    
    Note over T1,T8: 多觸發器並行運作
    T1->>C: 熱門話題數據
    T2->>C: 漲停股數據
    T3->>C: 熱門股數據
    T4->>C: 產業類股數據
    T5->>C: 台指期數據
    T6->>C: 月營收數據
    T7->>C: 高成交量數據
    T8->>C: 外部新聞數據
    
    C->>C: 話題分類與優先級排序
    C->>K: 傳遞分類後話題
    K->>K: KOL 匹配與分配
    K->>D: 傳遞 KOL 偏好
    D->>D: 智能數據調度
    D->>G: 傳遞數據素材
    G->>G: 生成個人化內容
```

### 流程四：外部新聞連結總結流程

```mermaid
sequenceDiagram
    participant N as 外部新聞API
    participant A as 新聞聚合器
    participant S as 新聞總結生成器
    participant K as KOL 配對器
    participant G as 內容生成器
    
    N->>A: 獲取相關新聞
    A->>A: 新聞去重與排序
    A->>S: 傳遞新聞列表
    S->>S: 生成新聞總結
    S->>K: 傳遞總結內容
    K->>K: KOL 匹配
    K->>G: 傳遞素材
    G->>G: 生成個人化內容
```

## 數據流向

### 數據源整合

```mermaid
graph LR
    subgraph "外部數據源"
        A[CMoney API]
        B[Finlab API]
        C[Serper API]
        D[Google Sheets]
    end
    
    subgraph "數據處理層"
        E[數據驗證器]
        F[數據轉換器]
        G[數據聚合器]
    end
    
    subgraph "數據應用層"
        H[KOL 偏好過濾器]
        I[數據亮點提取器]
        J[數據可解釋性引擎]
    end
    
    A --> E
    B --> E
    C --> E
    D --> E
    E --> F
    F --> G
    G --> H
    G --> I
    G --> J
```

## 系統組件說明

### 1. 觸發器引擎

* **盤後漲停股觸發器 (AFTER_HOURS_LIMIT_UP)**：識別收盤漲停股票，按成交量分為高量/低量兩類
* **盤中急漲股觸發器 (INTRADAY_SURGE_STOCKS)**：識別盤中急漲股票，提供即時分析
* **熱門話題觸發器 (TRENDING_TOPICS)**：從 CMoney API 獲取市場熱門話題
* **漲停股觸發器 (LIMIT_UP_STOCKS)**：識別和分析漲停股票
* **熱門股觸發器 (HOT_STOCKS)**：監控和分析市場熱門股票
* **產業分析觸發器 (INDUSTRY_ANALYSIS)**：分析產業板塊整體表現
* **月營收公告觸發器 (MONTHLY_REVENUE)**：處理上市公司月營收公告
* **高成交量觸發器 (HIGH_VOLUME)**：識別高波動、高成交量股票
* **新聞總結觸發器 (NEWS_SUMMARY)**：聚合外部新聞並生成總結

### 2. KOL 管理引擎

* **KOL 配對器**：根據話題類型匹配適合的 KOL
* **數據偏好檢查器**：讀取 KOL 的數據源排除清單
* **風格學習機制**：記錄和學習 KOL 的內容偏好

### 3. 數據調度引擎

* **智能數據調度器**：根據 KOL 偏好調度數據源
* **數據可解釋性提取器**：將原始數據轉化為可解釋的內容
* **數據亮點生成器**：生成數據亮點素材

### 4. 內容生成引擎

* **統一內容生成引擎**：整合所有內容生成功能的核心引擎
* **KOL人設深度分析器**：深度分析KOL個人特色和表達風格
* **多維度隨機化引擎**：確保內容多樣性和避免模板化
* **個人化提示詞生成器**：結合 KOL 人設和數據素材
* **內容品質控制檢查器**：檢測和修正AI生成痕跡
* **OpenAI LLM 集成**：調用 GPT-4o 生成高品質內容
* **內容後處理優化器**：根據需要優化內容品質

### 5. 發布管理引擎

* **發布策略管理器**：管理發布策略和時機
* **CMoney 發布器**：發布內容到 CMoney 平台
* **狀態更新器**：更新發布狀態
* **Google Sheets 記錄器**：記錄所有操作到 Google Sheets

## 技術特點

### 1. 個人化程度

* 每個 KOL 都有獨特的人設設定
* 數據源排除機制確保風格一致性
* 動態提示詞生成

### 2. 數據多樣性

* 不同 KOL 使用不同數據源組合
* 避免同批次內容重複
* 智能數據調度

### 3. 可擴展性

* 模組化設計
* 統一的數據格式
* 易於添加新的觸發器

### 4. 監控與追蹤

* 完整的 Google Sheets 記錄
* 實時狀態監控
* 互動數據分析

