# ç†±é–€è©±é¡Œè§¸ç™¼å™¨ - æ™ºèƒ½æ–°èæœå°‹æ•´åˆ

## æœ€æ–°æ›´æ–° (2024-12-19)

### ğŸ¯ æ ¸å¿ƒæ”¹é€²

æˆ‘å€‘å·²ç¶“å®Œå…¨é‡æ§‹äº†ç†±é–€è©±é¡Œè§¸ç™¼å™¨ï¼Œå¯¦ç¾äº†**æ¯å€‹è²¼æ–‡ç¨ç«‹çš„æ™ºèƒ½æ–°èæœå°‹**ï¼š

#### 1. æ™ºèƒ½è©±é¡Œåˆ†æå™¨ (IntelligentTopicAnalyzer)
- **åŠŸèƒ½**: ä½¿ç”¨ LLM åˆ†æç†±é–€è©±é¡Œä¸¦æå–é—œéµå­—
- **ç‰¹é»**: æ¯å€‹è²¼æ–‡ç¨ç«‹åˆ†æï¼Œä¸å…±äº«é—œéµå­—
- **è¼¸å‡º**: ä¸»è¦é—œéµå­—ã€æ¬¡è¦é—œéµå­—ã€ç”¢æ¥­é—œéµå­—ã€æƒ…æ„Ÿé—œéµå­—ã€æœå°‹æŸ¥è©¢å»ºè­°

#### 2. å¤šå±¤æ¬¡æœå°‹ç­–ç•¥ (MultiLevelSearchStrategy)
- **åŠŸèƒ½**: æ ¹æ“šè©±é¡Œåˆ†æçµæœåŸ·è¡Œå¤šç¨®æœå°‹ç­–ç•¥
- **å±¤æ¬¡**:
  - å±¤æ¬¡1: LLM ç”Ÿæˆçš„æœå°‹æŸ¥è©¢
  - å±¤æ¬¡2: è‚¡ç¥¨ç›¸é—œæœå°‹ï¼ˆè‚¡ç¥¨ä»£ç¢¼ + é—œéµå­—ï¼‰
  - å±¤æ¬¡3: ç”¢æ¥­ç›¸é—œæœå°‹
  - å±¤æ¬¡4: æƒ…æ„Ÿç›¸é—œæœå°‹
  - å±¤æ¬¡5: ç´”è©±é¡Œæœå°‹ï¼ˆç„¡è‚¡ç¥¨æ¨™ç±¤çš„è©±é¡Œï¼‰

#### 3. æ™ºèƒ½å…§å®¹ç”Ÿæˆå™¨ (SmartContentGenerator)
- **åŠŸèƒ½**: æ ¹æ“šç†±é–€è©±é¡Œå’Œæ–°èæœå°‹çµæœç”Ÿæˆç›¸é—œå…§å®¹
- **ç‰¹é»**: æ¯å€‹è²¼æ–‡ç¨ç«‹ç”Ÿæˆï¼ŒåŸºæ–¼è‡ªå·±çš„æ–°èè³‡æ–™
- **è¼¸å‡º**: æ¨™é¡Œã€å…§å®¹ã€æ‘˜è¦ã€é‡é»ã€ç›¸é—œé€£çµ

#### 4. ç†±é–€è©±é¡Œæ–°èæœå°‹æœå‹™ (TrendingTopicNewsService)
- **åŠŸèƒ½**: çµ±ä¸€çš„æœå‹™æ¥å£ï¼Œæ•´åˆæ‰€æœ‰çµ„ä»¶
- **ç‰¹é»**: æ”¯æŒä¸¦è¡Œè™•ç†å¤šå€‹è²¼æ–‡ï¼Œæ¯å€‹è²¼æ–‡å®Œå…¨ç¨ç«‹

## ğŸ”„ æ›´æ–°å¾Œçš„æµç¨‹

### æµç¨‹åœ–

```mermaid
sequenceDiagram
    participant UFM as çµ±ä¸€æµç¨‹ç®¡ç†å™¨
    participant CM as CMoney API
    participant TTS as TopicStockService
    participant TNS as TrendingTopicNewsService
    participant IA as IntelligentTopicAnalyzer
    participant MLS as MultiLevelSearchStrategy
    participant SCG as SmartContentGenerator
    participant PRS as PostRecordService
    participant PG as PostgreSQL
    
    UFM->>CM: ç²å–ç†±é–€è©±é¡Œ
    CM-->>UFM: è¿”å›è©±é¡Œæ•¸æ“š
    UFM->>TTS: è™•ç†è©±é¡Œï¼ˆåŒ…å«è‚¡ç¥¨æŸ¥è©¢ï¼‰
    TTS-->>UFM: è¿”å›è™•ç†å¾Œçš„è©±é¡Œ
    
    UFM->>UFM: è½‰æ›ç‚ºè²¼æ–‡æ ¼å¼
    Note over UFM: æ¯å€‹è‚¡ç¥¨-è©±é¡Œçµ„åˆ = 1å€‹ç¨ç«‹è²¼æ–‡
    
    UFM->>TNS: è™•ç†ç†±é–€è©±é¡Œè²¼æ–‡
    TNS->>IA: åˆ†æè©±é¡Œé—œéµå­—
    IA-->>TNS: è¿”å›é—œéµå­—åˆ†æ
    
    TNS->>MLS: åŸ·è¡Œå¤šå±¤æ¬¡æœå°‹
    MLS->>MLS: 5å±¤æœå°‹ç­–ç•¥
    MLS-->>TNS: è¿”å›æ–°èçµæœ
    
    TNS->>SCG: ç”Ÿæˆå…§å®¹
    SCG-->>TNS: è¿”å›ç”Ÿæˆå…§å®¹
    
    TNS-->>UFM: è¿”å›è²¼æ–‡çµæœ
    UFM->>PRS: è¨˜éŒ„åˆ° PostgreSQL
    PRS->>PG: ä¿å­˜è²¼æ–‡è¨˜éŒ„
```

### è©³ç´°æ­¥é©Ÿ

#### æ­¥é©Ÿ1: ç²å–ç†±é–€è©±é¡Œ
- å˜—è©¦å¾ CMoney API ç²å–çœŸå¯¦ç†±é–€è©±é¡Œ
- å¦‚æœå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“šä½œç‚º fallback
- æ”¯æŒç´”è©±é¡Œï¼ˆç„¡è‚¡ç¥¨æ¨™ç±¤ï¼‰å’Œæœ‰è‚¡ç¥¨çš„è©±é¡Œ

#### æ­¥é©Ÿ2: è™•ç†è©±é¡Œ
- ä½¿ç”¨ `TopicStockService` è™•ç†è©±é¡Œ
- æå–ç›¸é—œè‚¡ç¥¨æ¨™ç±¤
- åˆ†é¡è©±é¡Œé¡å‹

#### æ­¥é©Ÿ3: è½‰æ›ç‚ºè²¼æ–‡æ ¼å¼
- **è‚¡ç¥¨ x ç†±é–€è©±é¡Œçµ„åˆ**: æ¯å€‹çµ„åˆ = 1å€‹ç¨ç«‹è²¼æ–‡
  - ä¾‹å¦‚ï¼šè©±é¡ŒA + è‚¡ç¥¨2330 = è²¼æ–‡ `topic_A_2330`
- **ç´”ç†±é–€è©±é¡Œ**: æ¯å€‹ç´”è©±é¡Œ = 1å€‹ç¨ç«‹è²¼æ–‡
  - ä¾‹å¦‚ï¼šè©±é¡ŒBï¼ˆç„¡è‚¡ç¥¨ï¼‰= è²¼æ–‡ `topic_B_topic_only`

#### æ­¥é©Ÿ4: æ™ºèƒ½æ–°èæœå°‹
- **æ¯å€‹è²¼æ–‡ç¨ç«‹åˆ†æé—œéµå­—**
- **æ¯å€‹è²¼æ–‡ç¨ç«‹æœå°‹æ–°è**
- **æ¯å€‹è²¼æ–‡ç¨ç«‹ç”Ÿæˆå…§å®¹**

#### æ­¥é©Ÿ5: ä¿å­˜åˆ° PostgreSQL
- ä½¿ç”¨ `PostRecordService` ä¿å­˜è²¼æ–‡è¨˜éŒ„
- è¨˜éŒ„ç”Ÿæˆå…§å®¹ã€æ–°èä¾†æºã€ä¿¡å¿ƒåˆ†æ•¸ç­‰

## ğŸ”’ ç¨ç«‹æ€§ä¿è­‰

### æ¯å€‹è²¼æ–‡éƒ½æœ‰ï¼š
- âœ… **ç¨ç«‹çš„è²¼æ–‡ID** - æ ¼å¼ï¼š`{topic_id}_{stock_id}` æˆ– `{topic_id}_topic_only`
- âœ… **ç¨ç«‹çš„é—œéµå­—åˆ†æ** - æ¯å€‹è²¼æ–‡ä½¿ç”¨ `IntelligentTopicAnalyzer`
- âœ… **ç¨ç«‹çš„æ–°èæœå°‹** - æ¯å€‹è²¼æ–‡æœ‰è‡ªå·±çš„æœå°‹ç­–ç•¥
- âœ… **ç¨ç«‹çš„å…§å®¹ç”Ÿæˆ** - åŸºæ–¼è‡ªå·±çš„æ–°èè³‡æ–™ç”Ÿæˆå…§å®¹
- âœ… **ç¨ç«‹çš„è²¼æ–‡IDè¿½è¹¤** - æ‰€æœ‰æ—¥èªŒå’Œçµæœéƒ½æœ‰è²¼æ–‡æ¨™è­˜

## ğŸ“Š æœå°‹ç­–ç•¥è©³è§£

### è‚¡ç¥¨ x ç†±é–€è©±é¡Œçµ„åˆ
1. **è‚¡ç¥¨ä»£ç¢¼ + ä¸»è¦é—œéµå­—**
2. **è‚¡ç¥¨ä»£ç¢¼ + è©±é¡Œæ¨™é¡Œ**
3. **LLM ç”Ÿæˆçš„å°ˆå±¬æŸ¥è©¢**

### ç´”ç†±é–€è©±é¡Œ
1. **ä¸»è¦é—œéµå­—çµ„åˆ**
2. **è©±é¡Œæ¨™é¡Œæœ¬èº«**
3. **LLM ç”Ÿæˆçš„å°ˆå±¬æŸ¥è©¢**

## ğŸ—„ï¸ è³‡æ–™åº«è¨˜éŒ„

### PostgreSQL è¨˜éŒ„æ ¼å¼
```python
post_data = {
    'post_id': result.post_id,
    'kol_serial': "",  # å¾…åˆ†é…
    'kol_nickname': "",  # å¾…åˆ†é…
    'kol_persona': "",  # å¾…åˆ†é…
    'stock_code': ", ".join(result.stock_ids),
    'stock_name': "",  # å¾…æŸ¥è©¢
    'title': result.generated_content.title,
    'content': result.generated_content.content,
    'content_md': result.generated_content.content,
    'status': 'ready_to_gen',
    'content_type': 'trending_topic',
    'topic_id': result.post_id,
    'topic_title': result.topic_title,
    'topic_keywords': ", ".join(result.stock_ids),
    'generated_at': datetime.now(),
    'news_sources': len(result.news_results),
    'confidence_score': result.generated_content.confidence_score
}
```

## ğŸš€ æŠ€è¡“å¯¦ç¾

### æ ¸å¿ƒæ–‡ä»¶
- `src/agents/intelligent_topic_analyzer.py` - æ™ºèƒ½è©±é¡Œåˆ†æå™¨
- `src/agents/multi_level_search_strategy.py` - å¤šå±¤æ¬¡æœå°‹ç­–ç•¥
- `src/agents/smart_content_generator.py` - æ™ºèƒ½å…§å®¹ç”Ÿæˆå™¨
- `src/services/trending_topic_news_service.py` - ç†±é–€è©±é¡Œæ–°èæœå°‹æœå‹™
- `src/services/flow/unified_flow_manager.py` - çµ±ä¸€æµç¨‹ç®¡ç†å™¨ï¼ˆå·²æ›´æ–°ï¼‰

### é—œéµæ”¹é€²
1. **ç§»é™¤ Google Sheets ä¾è³´** - æ”¹ç‚ºä½¿ç”¨ PostgreSQL
2. **æ¯å€‹è²¼æ–‡ç¨ç«‹è™•ç†** - ç¢ºä¿ä¸å…±äº«æœå°‹çµæœ
3. **æ™ºèƒ½é—œéµå­—æå–** - ä½¿ç”¨ LLM åˆ†æè©±é¡Œ
4. **å¤šå±¤æ¬¡æœå°‹ç­–ç•¥** - 5ç¨®ä¸åŒçš„æœå°‹æ–¹æ³•
5. **ä¸¦è¡Œè™•ç†æ”¯æŒ** - æ”¯æŒå¤šå€‹è²¼æ–‡åŒæ™‚è™•ç†

## ğŸ“ˆ é æœŸæ•ˆæœ

- **æ›´ç²¾æº–çš„æ–°èæœå°‹** - æ¯å€‹è²¼æ–‡éƒ½æœ‰å°ˆå±¬çš„æœå°‹ç­–ç•¥
- **æ›´ç›¸é—œçš„å…§å®¹ç”Ÿæˆ** - åŸºæ–¼å°ˆå±¬æ–°èè³‡æ–™ç”Ÿæˆå…§å®¹
- **æ›´å¥½çš„å…§å®¹å“è³ª** - é¿å…ä¸åŒè²¼æ–‡é–“çš„å¹²æ“¾
- **æ›´å®Œæ•´çš„è¨˜éŒ„è¿½è¹¤** - PostgreSQL æä¾›å®Œæ•´çš„è³‡æ–™åº«æ”¯æŒ
