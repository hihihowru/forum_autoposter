# 手動發文功能說明

## 🎯 功能概述

手動發文功能是一個類似水軍操作軟體的工具，允許管理員手動為多個 KOL 同時發文，支援股票標籤和熱門話題的多選功能。

## 📁 文件結構

```
手動發文功能/
├── manual_posting_service.py      # 後端服務邏輯
├── manual_posting_api.py          # FastAPI 端點
├── manual_posting_page.html       # 前端頁面
├── test_manual_posting.py         # 測試腳本
├── start_manual_posting.sh        # 啟動腳本
└── 手動發文功能說明.md            # 說明文檔
```

## 🚀 快速開始

### 1. 啟動服務

```bash
# 使用啟動腳本（推薦）
./start_manual_posting.sh

# 或手動啟動
python3 manual_posting_api.py
```

### 2. 開啟前端頁面

在瀏覽器中開啟：
```
file:///path/to/manual_posting_page.html
```

### 3. 測試功能

```bash
python3 test_manual_posting.py
```

## 🔧 功能特點

### 1. KOL 管理
- 從資料庫載入所有活躍 KOL
- 顯示 KOL 暱稱、人設、編號
- 支援多 KOL 同時發文

### 2. 股票選擇器
- 載入 2,263 個四位數股票代號
- 支援股號搜尋（如：2330）
- 支援公司名稱搜尋（如：台積電）
- 支援多選功能
- 即時搜尋結果

### 3. 熱門話題選擇器
- 調用 CMoney API 獲取熱門話題
- 支援話題標題搜尋
- 支援多選功能
- 即時搜尋結果

### 4. 發文記錄
- 自動記錄到 `post_records` 表
- 支援多選股票和話題
- 第一個選擇作為主要項目
- 其他選擇存到 JSON 欄位
- 狀態設為 `success`

## 📊 資料庫結構

### post_records 表新增記錄
```sql
INSERT INTO post_records (
  post_id,                    -- manual-{uuid}-{kol_serial}
  kol_serial,                 -- KOL 序號
  kol_nickname,               -- KOL 暱稱
  kol_persona,                -- KOL 人設
  title,                      -- 標題
  content,                    -- 內容
  stock_code,                 -- 主要股票代號
  stock_name,                 -- 主要股票名稱
  topic_id,                   -- 主要話題ID
  topic_title,                -- 主要話題標題
  commodity_tags,             -- JSON: 所有股票資訊
  community_topic,            -- JSON: 所有話題資訊
  status,                     -- 'success'
  created_at                  -- 建立時間
) VALUES (...);
```

### 多選資料格式
```json
{
  "commodity_tags": {
    "primary": {"code": "2330", "name": "台積電"},
    "additional": [
      {"code": "2454", "name": "聯發科"},
      {"code": "2317", "name": "鴻海"}
    ]
  },
  "community_topic": {
    "primary": {"id": "1", "title": "台股開紅盤"},
    "additional": [
      {"id": "2", "title": "科技股大漲"},
      {"id": "3", "title": "半導體強勢"}
    ]
  }
}
```

## 🌐 API 端點

### 基礎 URL
```
http://localhost:8005/api/manual-posting
```

### 端點列表

| 方法 | 路徑 | 說明 |
|------|------|------|
| GET | `/kols` | 獲取 KOL 列表 |
| GET | `/stocks` | 獲取股票列表 |
| GET | `/stocks/search?q={query}` | 搜尋股票 |
| GET | `/trending-topics` | 獲取熱門話題 |
| POST | `/submit` | 提交手動發文 |
| GET | `/recent-posts?limit={n}` | 獲取最近發文 |
| GET | `/health` | 健康檢查 |

### 請求範例

#### 提交手動發文
```json
POST /submit
{
  "kol_serial": 200,
  "title": "測試標題",
  "content": "測試內容",
  "stock_codes": ["2330", "2454"],
  "trending_topics": ["1", "2"]
}
```

#### 回應範例
```json
{
  "success": true,
  "post_id": "manual-uuid-200",
  "message": "發文記錄已保存"
}
```

## 🎨 前端功能

### 1. 頁面布局
- **已發佈貼文列表**：顯示最近 10 筆發文，按時間新到舊排序
- **KOL 發文區域**：每個 KOL 一個發文表單

### 2. 表單功能
- **標題輸入**：單行文字輸入
- **內容輸入**：多行文字輸入
- **股票選擇器**：支援搜尋和多選
- **話題選擇器**：支援搜尋和多選
- **操作按鈕**：送出、清空

### 3. 互動功能
- **即時搜尋**：輸入時即時顯示搜尋結果
- **多選標籤**：選中的項目顯示為標籤，可移除
- **表單驗證**：標題和內容必填
- **成功提示**：發文成功後顯示 Post ID
- **自動清空**：發文成功後自動清空表單

## 🔍 測試功能

### 測試腳本
```bash
python3 test_manual_posting.py
```

### 測試項目
1. **健康檢查**：API 服務狀態
2. **KOL 列表**：獲取和顯示 KOL
3. **股票列表**：獲取和顯示股票
4. **股票搜尋**：搜尋功能測試
5. **熱門話題**：獲取話題列表
6. **手動發文**：提交發文測試
7. **發文記錄**：獲取最近發文

## ⚙️ 配置說明

### 環境變數
```bash
DATABASE_URL=postgresql://postgres:password@localhost:5432/posting_management
```

### 依賴套件
```bash
pip3 install fastapi uvicorn sqlalchemy pydantic psycopg2-binary
```

### 資料庫要求
- PostgreSQL 資料庫
- `post_records` 表
- `kol_profiles` 表
- `stock_mapping.json` 文件

## 🐛 故障排除

### 常見問題

1. **API 服務無法啟動**
   - 檢查端口 8005 是否被佔用
   - 檢查 Python 依賴套件是否安裝
   - 檢查資料庫連接

2. **資料庫連接失敗**
   - 檢查 PostgreSQL 服務是否啟動
   - 檢查資料庫連接字串
   - 檢查資料庫表是否存在

3. **股票資料載入失敗**
   - 檢查 `stock_mapping.json` 文件是否存在
   - 檢查文件格式是否正確
   - 檢查文件權限

4. **前端頁面無法載入**
   - 檢查 API 服務是否啟動
   - 檢查瀏覽器控制台錯誤
   - 檢查 CORS 設定

### 日誌查看
```bash
# 查看 API 服務日誌
tail -f /var/log/manual_posting.log

# 查看資料庫日誌
tail -f /var/log/postgresql.log
```

## 📈 效能優化

### 1. 資料庫優化
- 為 `post_records` 表添加索引
- 定期清理舊的發文記錄
- 使用連接池

### 2. 前端優化
- 股票列表分頁載入
- 搜尋結果限制數量
- 快取熱門話題

### 3. API 優化
- 添加請求快取
- 使用異步處理
- 添加請求限制

## 🔒 安全考量

### 1. 權限控制
- 僅管理員可使用
- 添加身份驗證
- 記錄操作日誌

### 2. 資料驗證
- 輸入資料驗證
- SQL 注入防護
- XSS 防護

### 3. 網路安全
- HTTPS 加密
- CORS 設定
- 請求限制

## 🚀 未來擴展

### 1. 功能擴展
- 批量發文功能
- 發文模板功能
- 排程發文功能
- 發文預覽功能

### 2. 整合擴展
- 與現有發文流程整合
- 通知機制
- 統計功能
- 審核機制

### 3. 技術擴展
- 微服務架構
- 容器化部署
- 監控和告警
- 自動化測試

## 📞 支援聯繫

如有問題或建議，請聯繫開發團隊。

---

**版本**: 1.0.0  
**更新日期**: 2025-01-15  
**維護者**: 開發團隊
