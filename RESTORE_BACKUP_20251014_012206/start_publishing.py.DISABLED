#!/usr/bin/env python3
"""
é–‹å§‹ç™¼æ–‡è…³æœ¬
"""
import asyncio
import sys
import os
from dotenv import load_dotenv

# æ·»åŠ  src åˆ°è·¯å¾‘
sys.path.append('./src')

from services.publish.publish_service import PublishService
from clients.google.sheets_client import GoogleSheetsClient

async def main():
    """ä¸»å‡½æ•¸"""
    print("=== é–‹å§‹ç™¼æ–‡æµç¨‹ ===")
    
    # è¼‰å…¥ç’°å¢ƒè®Šæ•¸
    load_dotenv()
    
    # åˆå§‹åŒ–æœå‹™
    credentials_file = os.getenv('GOOGLE_CREDENTIALS_FILE', 'credentials/google-service-account.json')
    spreadsheet_id = os.getenv('GOOGLE_SHEETS_ID', '148CUhBxqE-BZDPTKaAmOJG6m52CxB4KrxD9p5LikN2s')
    
    sheets_client = GoogleSheetsClient(credentials_file, spreadsheet_id)
    publish_service = PublishService(sheets_client)
    
    try:
        # æ­¥é©Ÿ1: ç™»å…¥æ‰€æœ‰ KOL
        print("æ­¥é©Ÿ1: ç™»å…¥æ‰€æœ‰ KOL...")
        login_success = await publish_service.login_all_kols()
        
        if not login_success:
            print("âŒ KOL ç™»å…¥å¤±æ•—ï¼Œç„¡æ³•ç¹¼çºŒç™¼æ–‡")
            return
        
        print("âœ… æ‰€æœ‰ KOL ç™»å…¥æˆåŠŸ")
        
        # æ­¥é©Ÿ2: ç²å–æº–å‚™ç™¼æ–‡çš„è¨˜éŒ„
        print("æ­¥é©Ÿ2: ç²å–æº–å‚™ç™¼æ–‡çš„è¨˜éŒ„...")
        ready_posts = publish_service.get_ready_to_post_records()
        
        if not ready_posts:
            print("âŒ æ²’æœ‰æ‰¾åˆ°æº–å‚™ç™¼æ–‡çš„è¨˜éŒ„")
            return
        
        print(f"âœ… æ‰¾åˆ° {len(ready_posts)} ç¯‡æº–å‚™ç™¼æ–‡çš„è¨˜éŒ„")
        
        # é¡¯ç¤ºæº–å‚™ç™¼æ–‡çš„è¨˜éŒ„
        for i, post in enumerate(ready_posts, 1):
            print(f"  {i}. {post['kol_nickname']} (Serial: {post['kol_serial']})")
            print(f"     æ¨™é¡Œ: {post['title']}")
            print(f"     å…§å®¹é•·åº¦: {len(post['content'])} å­—")
            print()
        
        # æ­¥é©Ÿ3: ç¢ºèªç™¼æ–‡
        print("æ­¥é©Ÿ3: ç¢ºèªç™¼æ–‡...")
        confirm = input(f"æ˜¯å¦é–‹å§‹ç™¼æ–‡ï¼Ÿå°‡é–“éš” 2 åˆ†é˜ç™¼æ–‡ (y/N): ").strip().lower()
        
        if confirm != 'y':
            print("å–æ¶ˆç™¼æ–‡")
            return
        
        # æ­¥é©Ÿ4: é–‹å§‹é–“éš”ç™¼æ–‡
        print("æ­¥é©Ÿ4: é–‹å§‹é–“éš”ç™¼æ–‡...")
        results = await publish_service.publish_posts_with_interval(ready_posts, interval_minutes=2)
        
        # æ­¥é©Ÿ5: é¡¯ç¤ºçµæœ
        print("æ­¥é©Ÿ5: ç™¼æ–‡çµæœ...")
        success_count = sum(1 for r in results if r['success'])
        print(f"ç™¼æ–‡å®Œæˆ: {success_count}/{len(results)} æˆåŠŸ")
        
        for result in results:
            status = "âœ… æˆåŠŸ" if result['success'] else "âŒ å¤±æ•—"
            print(f"  {result['kol_serial']}: {status}")
            if result['success']:
                print(f"    Article ID: {result['article_id']}")
                print(f"    Article URL: {result['article_url']}")
            else:
                print(f"    éŒ¯èª¤: {result['error_message']}")
        
        print("ğŸ‰ ç™¼æ–‡æµç¨‹å®Œæˆï¼")
        
    except Exception as e:
        print(f"âŒ ç™¼æ–‡æµç¨‹ç•°å¸¸: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(main())
