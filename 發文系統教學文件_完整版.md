# 論壇自動發文系統 - 完整使用教學

## 目錄

1. [系統概述](#系統概述)
2. [架構說明](#架構說明)
3. [發文生成流程 - 九步驟完整教學](#發文生成流程)
   - [步驟一：觸發器選擇](#步驟一觸發器選擇)
   - [步驟二：數據源配置](#步驟二數據源配置)
   - [步驟三：解釋層設定](#步驟三解釋層設定)
   - [步驟四：新聞搜尋配置](#步驟四新聞搜尋配置)
   - [步驟五：KOL 選擇](#步驟五kol-選擇)
   - [步驟六：KOL Prompt 微調](#步驟六kol-prompt-微調)
   - [步驟七：生成設定](#步驟七生成設定)
   - [步驟八：標籤設定](#步驟八標籤設定)
   - [步驟九：批量模式設定](#步驟九批量模式設定)
4. [後端處理流程](#後端處理流程)
5. [發布與審核流程](#發布與審核流程)

---

## 系統概述

### 系統定位
論壇自動發文系統是一個整合 AI 內容生成、市場數據分析、與論壇發布的自動化平台。系統可以：

- **自動監控**市場觸發事件（漲停、熱門話題、新聞事件等）
- **智能生成**符合不同 KOL 風格的股票分析內容
- **批量處理**多檔股票、多個 KOL 的發文需求
- **自動發布**至 CMoney 論壇平台

### 核心特色

1. **九步驟精準設定**：從觸發器到發布，每個環節都可精細控制
2. **KOL 個性化引擎**：每個 KOL 都有獨特的寫作風格、語氣、專業領域
3. **多層數據整合**：股價技術面、基本面、新聞面、熱門話題全方位分析
4. **智能內容生成**：基於 GPT-4 的動態提示詞工程（Prompt Engineering）
5. **品質把關機制**：內容品質檢查、AI 檢測分數、人工審核流程

---

## 架構說明

### 前後端架構

```
┌─────────────────────────────────────────────────────────┐
│                     前端 (Frontend)                      │
│  技術：React + TypeScript + Ant Design                   │
│  位置：/dashboard-frontend/src/                          │
├─────────────────────────────────────────────────────────┤
│  組件：                                                   │
│  • PostingGenerator.tsx (9步驟精靈)                      │
│    ├─ TriggerSelector.tsx (步驟1)                       │
│    ├─ DataSourceSelector.tsx (步驟2)                    │
│    ├─ ExplainabilityConfig.tsx (步驟3)                  │
│    ├─ NewsConfig.tsx (步驟4)                            │
│    ├─ KOLSelector.tsx (步驟5)                           │
│    ├─ KOLPromptTuner.tsx (步驟6)                        │
│    ├─ GenerationSettings.tsx (步驟7)                    │
│    ├─ TagSettings.tsx (步驟8)                           │
│    └─ BatchModeSettings.tsx (步驟9)                     │
│  • PostReviewPage.tsx (審核頁面)                         │
│  • PublishSuccessPage.tsx (發布成功頁面)                 │
└─────────────────────────────────────────────────────────┘
                            ↓ HTTP API 調用
┌─────────────────────────────────────────────────────────┐
│                   後端 API (Backend)                      │
│  技術：FastAPI + Python                                   │
│  位置：/apps/unified-api/main.py                         │
├─────────────────────────────────────────────────────────┤
│  主要端點：                                               │
│  • POST /api/manual-posting (手動發文)                   │
│  • POST /api/simple-mode/generate-batch (批量生成)       │
│  • GET /posts/session/{session_id} (查詢生成結果)        │
│  • POST /posts/{post_id}/approve (審核通過)              │
│  • POST /posts/{post_id}/publish (發布到論壇)            │
├─────────────────────────────────────────────────────────┤
│  核心模組：                                               │
│  • GPTContentGenerator (GPT內容生成器)                   │
│  • PersonalizationModule (個人化處理模組)                │
│  • KOLDatabaseService (KOL資料管理)                      │
│  • SmartDataSourceAssigner (智能數據源分配)              │
│  • TriggerManager (觸發器管理)                           │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   數據層 (Data Layer)                     │
│  • PostgreSQL (貼文記錄、KOL檔案、排程資料)                │
│  • Google Sheets (備份、傳統資料同步)                      │
│  • OpenAI API (GPT-4o-mini 內容生成)                      │
└─────────────────────────────────────────────────────────┘
```

### 資料流向

```
使用者操作 → 9步驟配置 → 前端彙整參數 → API請求 → 後端處理
    ↓
後端邏輯流程：
    1. 解析觸發器，取得股票清單
    2. 分配數據源（OHLC、新聞、基本面等）
    3. 收集股票數據
    4. 分配 KOL
    5. 生成內容（GPT-4）
    6. 個人化處理（風格轉換）
    7. 儲存到資料庫（status: draft）
    8. 回傳前端進行審核
    ↓
審核發布流程：
    1. 使用者在 PostReviewPage 審閱
    2. 點擊「發布」
    3. KOL 登入 CMoney
    4. 發布貼文到論壇
    5. 更新資料庫（status: published）
```

---

## 發文生成流程

### 整體流程概覽

發文生成分為**九個步驟**，每個步驟負責不同的配置面向：

| 步驟 | 名稱 | 功能 | 前端組件 |
|------|------|------|----------|
| **1** | 觸發器選擇 | 決定要生成哪些股票的內容 | TriggerSelector.tsx |
| **2** | 數據源配置 | 選擇使用哪些數據 API | DataSourceSelector.tsx |
| **3** | 解釋層設定 | 配置數據摘要與解釋方式 | ExplainabilityConfig.tsx |
| **4** | 新聞搜尋 | 設定新聞搜尋關鍵字與範圍 | NewsConfig.tsx |
| **5** | KOL 選擇 | 選擇要使用的 KOL 帳號 | KOLSelector.tsx |
| **6** | KOL Prompt 微調 | 調整 KOL 的寫作風格細節 | KOLPromptTuner.tsx |
| **7** | 生成設定 | 配置內容長度、風格、分析深度 | GenerationSettings.tsx |
| **8** | 標籤設定 | 設定貼文標籤（股票、話題） | TagSettings.tsx |
| **9** | 批量模式 | 批量生成的策略與品質控制 | BatchModeSettings.tsx |

---

## 步驟一：觸發器選擇

### 功能說明
觸發器決定了**要為哪些股票生成內容**。這是整個流程的起點，也是最關鍵的配置。

### 可用的觸發器類型

系統共提供 **13 個觸發器**，分為 3 大類：

#### 類別一：熱門話題觸發器 (1 個)

##### 1. 熱門話題 (trending_topics)
- **使用時機**：想要蹭熱度、追蹤市場關注焦點
- **資料來源**：CMoney Trending API
- **API 端點**：`GET /api/trending`
- **運作方式**：
  1. 系統從 Trending API 取得當前熱門話題
  2. 每個話題包含：話題標題、相關股票清單
  3. 使用者可勾選要生成的話題
  4. 系統會為每個話題中的股票生成內容

**前端配置**：
```typescript
generationConfig.triggers = {
  trigger_type: 'trending',
  triggerConfig: {
    triggerKey: 'trending_topics',
    displayName: 'CMoney熱門話題'
  },
  selectedTopics: [
    { topic_id: 123, title: 'AI伺服器概念股爆發', stocks: ['2330', '3231'] }
  ]
}
```

---

#### 類別二：盤後觸發器 (6 個)

##### 2. 盤後漲 (limit_up_after_hours)
- **使用時機**：收盤後第一時間搶發上漲股分析
- **API 端點**：`GET /api/after_hours_limit_up`
- **篩選條件**：收盤上漲股票，依成交量排序

##### 3. 盤後跌 (limit_down_after_hours)
- **使用時機**：收盤後分析下跌股票
- **API 端點**：`GET /api/after_hours_limit_down`
- **篩選條件**：收盤下跌股票，依成交量排序

##### 4. 成交金額高 (volume_amount_high)
- **使用時機**：分析高成交金額股票（資金關注度高）
- **API 端點**：`GET /api/after_hours_volume_amount_high`
- **篩選條件**：成交金額絕對值排序（由大到小）

##### 5. 成交金額低 (volume_amount_low)
- **使用時機**：分析低成交金額股票（冷門股、觀望氛圍）
- **API 端點**：`GET /api/after_hours_volume_amount_low`
- **篩選條件**：成交金額絕對值排序（由小到大）

##### 6. 成交金額變化率高 (volume_change_rate_high)
- **使用時機**：捕捉突然放量的股票（異常活躍）
- **API 端點**：`GET /api/after_hours_volume_change_rate_high`
- **篩選條件**：成交金額變化率排序（由大到小）

##### 7. 成交金額變化率低 (volume_change_rate_low)
- **使用時機**：分析量能萎縮的股票（觀望、縮量）
- **API 端點**：`GET /api/after_hours_volume_change_rate_low`
- **篩選條件**：成交金額變化率排序（由小到大）

---

#### 類別三：盤中觸發器 (6 個)

##### 8. 漲幅排序+成交額 (intraday_gainers_by_amount)
- **使用時機**：盤中即時追蹤高漲幅且有資金關注的股票
- **API 端點**：`GET /api/intraday/gainers-by-amount`
- **篩選條件**：按成交額排序的漲幅股票（前 20 名）

##### 9. 成交量排序 (intraday_volume_leaders)
- **使用時機**：盤中追蹤熱門交易股票
- **API 端點**：`GET /api/intraday/volume-leaders`
- **篩選條件**：按成交量排序（前 20 名）

##### 10. 成交額排序 (intraday_amount_leaders)
- **使用時機**：盤中追蹤大戶關注股票
- **API 端點**：`GET /api/intraday/amount-leaders`
- **篩選條件**：按成交額排序（前 20 名）

##### 11. 跌停篩選 (intraday_limit_down)
- **使用時機**：盤中即時分析跌停股票
- **API 端點**：`GET /api/intraday/limit-down`
- **篩選條件**：篩選跌停股票（前 20 名）

##### 12. 漲停篩選 (intraday_limit_up)
- **使用時機**：盤中即時追蹤漲停強勢股
- **API 端點**：`GET /api/intraday/limit-up`
- **篩選條件**：篩選漲停股票（前 20 名）

##### 13. 跌停篩選+成交額 (intraday_limit_down_by_amount)
- **使用時機**：盤中分析有資金關注的跌停股
- **API 端點**：`GET /api/intraday/limit-down-by-amount`
- **篩選條件**：按成交額排序的跌停股票（前 20 名）

---

**前端配置範例**：
```typescript
// 盤後觸發器範例
generationConfig.triggers = {
  trigger_type: 'individual',
  triggerConfig: {
    triggerKey: 'limit_up_after_hours',
    displayName: '盤後漲'
  }
}

// 盤中觸發器範例
generationConfig.triggers = {
  trigger_type: 'intraday',
  triggerConfig: {
    triggerKey: 'intraday_limit_up',
    displayName: '漲停篩選'
  }
}
```

---

### 觸發器選擇最佳實踐

| 情境 | 推薦觸發器 | 原因 |
|------|------------|------|
| 想要追熱度、高互動 | 熱門話題 (trending_topics) | 話題本身就有流量，容易引起共鳴 |
| 收盤後搶第一時間 | 盤後漲/跌 (limit_up/down_after_hours) | 收盤後立即生成，時效性最強 |
| 盤中即時追蹤 | 盤中漲/跌停篩選 (intraday_limit_up/down) | 捕捉盤中突發強勢股或弱勢股 |
| 分析資金關注度 | 成交額排序系列 (amount_leaders, gainers_by_amount) | 追蹤大戶動向 |
| 捕捉異常放量 | 成交金額變化率高 (volume_change_rate_high) | 發現突發異常交易活動 |
| 分析冷門股觀望 | 成交金額低/變化率低 | 找出量能萎縮、市場觀望的股票 |

**觸發器分類快速選擇**：
- **熱度優先** → 熱門話題 (trending_topics)
- **盤後分析** → 6 個盤後觸發器 (limit_up/down, volume 系列)
- **盤中即時** → 6 個盤中觸發器 (intraday 系列)

---

## 步驟二：數據源配置

### 功能說明
數據源決定了**生成內容時會使用哪些數據**。不同的數據源提供不同類型的資訊，組合使用可以生成更全面的分析內容。

### 可用數據源

#### 1. OHLC API (股價技術數據)
- **提供數據**：
  - 開盤價、最高價、最低價、收盤價
  - 成交量、成交金額
  - 技術指標：MACD, RSI, KD, 布林通道等
- **適用情境**：技術分析、價量關係分析
- **KOL 適配**：技術派 KOL 必用

```typescript
dataSources: {
  ohlc_api: {
    enabled: true,
    indicators: ['MACD', 'RSI', 'KD'],
    timeframe: '日線'  // 日線、週線、月線
  }
}
```

---

#### 2. Summary API (數據摘要分析)
- **提供數據**：
  - AI 生成的數據摘要
  - 關鍵數據解讀
  - 趨勢判斷建議
- **適用情境**：需要快速理解數據含義
- **特色**：已經過 AI 預處理，減少 GPT 生成負擔

```typescript
dataSources: {
  summary_api: {
    enabled: true,
    summary_level: 'detailed'  // brief, medium, detailed
  }
}
```

---

#### 3. Serper API (新聞搜尋)
- **提供數據**：
  - 相關新聞標題、摘要、連結
  - 發布時間、來源媒體
- **搜尋引擎**：Google News
- **適用情境**：新聞面分析、事件驅動內容

```typescript
dataSources: {
  serper_api: {
    enabled: true,
    max_results: 5,
    time_range: 'd2'  // 最近2天
  }
}
```

---

#### 4. Revenue API (營收數據)
- **提供數據**：
  - 每月營收
  - 年增率、月增率
  - 累計營收
- **適用情境**：基本面分析、營收成長追蹤

---

#### 5. Financial API (財務數據)
- **提供數據**：
  - EPS, ROE, 本益比
  - 負債比、股東權益報酬率
- **適用情境**：深度基本面分析

---

#### 6. Fundamental API (基本面分析)
- **提供數據**：
  - 產業地位、競爭優勢
  - 營運模式、獲利來源
- **適用情境**：長期投資價值分析

---

### 數據源組合策略

**後端智能分配邏輯**：
系統會根據 **KOL 的 persona（風格）** 自動調整數據源權重。

```python
# SmartDataSourceAssigner.py
def assign_data_sources(kol_persona, trigger_type):
    if kol_persona == 'technical':
        # 技術派：重視價量、技術指標
        return {
            'OHLC_API': 1.0,      # 最高權重
            'SUMMARY_API': 0.7,
            'SERPER_API': 0.3     # 較低權重
        }
    elif kol_persona == 'fundamental':
        # 基本派：重視財報、營收
        return {
            'FINANCIAL_API': 1.0,
            'REVENUE_API': 1.0,
            'OHLC_API': 0.5
        }
    elif kol_persona == 'news_driven':
        # 新聞派：重視新聞、熱門話題
        return {
            'SERPER_API': 1.0,
            'TRENDING_API': 0.9,
            'OHLC_API': 0.6
        }
```

### 前端配置範例

```typescript
// 範例：為技術派 KOL 配置數據源
dataSources: {
  ohlc_api: { enabled: true, weight: 1.0 },
  summary_api: { enabled: true, weight: 0.7 },
  serper_api: { enabled: false },  // 技術派較少用新聞
  revenue_api: { enabled: false },
  financial_api: { enabled: false }
}
```

---

## 步驟三：解釋層設定

### 功能說明
解釋層控制**如何將原始數據轉換成易懂的文字描述**。這是內容品質的關鍵環節。

### 主要功能

#### 1. 數據摘要器 (Summarizer)
- **功能**：將大量數據壓縮成重點摘要
- **運作方式**：
  1. 接收原始數據（例：100筆K線數據）
  2. 提取關鍵資訊（例：近期高低點、趨勢方向）
  3. 生成簡潔摘要（例：「股價近期呈現上升趨勢，已突破60日均線」）

```typescript
explainability: {
  summarizer_enabled: true,
  summarizer_config: {
    compression_ratio: 0.3,  // 壓縮到原數據的30%
    focus_areas: ['trend', 'volume', 'key_levels']
  }
}
```

---

#### 2. 數據提取器 (Data Extractor)
- **功能**：從數據中提取特定指標
- **範例**：
  - 提取：「收盤價」、「成交量」、「MACD」
  - 忽略：其他不重要的欄位

```typescript
explainability: {
  data_extractor_enabled: true,
  extract_fields: ['close_price', 'volume', 'MACD', 'RSI']
}
```

---

#### 3. Prompt 模板 (Prompt Templates)
- **功能**：預設的數據解讀模板
- **可用模板**：
  - `stock_price_basic`：基礎股價解讀
  - `technical_deep_dive`：深度技術分析
  - `volume_analysis`：量能分析
  - `trend_momentum`：趨勢動能分析

**模板範例**：
```python
# stock_price_basic 模板
template = """
根據以下數據分析 {stock_name}({stock_code}) 的股價表現：
- 收盤價：{close_price}，漲跌幅：{change_percent}%
- 成交量：{volume} 張，相較昨日 {volume_change}%
- MACD：{macd}，RSI：{rsi}

請用簡單易懂的方式說明：
1. 股價當前趨勢（上漲/下跌/盤整）
2. 量能變化的意義
3. 技術指標的訊號
"""
```

---

#### 4. 技術指標選擇
- **可選指標**：
  - `MACD`：趨勢方向與動能
  - `RSI`：超買超賣
  - `KD`：短期買賣訊號
  - `布林通道`：價格波動範圍
  - `均線`：支撐壓力

```typescript
explainability: {
  technical_indicators: ['MACD', 'RSI', 'KD'],
  indicator_config: {
    MACD: { fast: 12, slow: 26, signal: 9 },
    RSI: { period: 14, overbought: 70, oversold: 30 }
  }
}
```

---

#### 5. 可解釋性級別 (Explainability Level)
- **簡易 (simple)**：只說結論，不解釋原因
  - 範例：「股價呈現上漲趨勢」
- **中等 (medium)**：說明結論 + 簡單原因
  - 範例：「股價呈現上漲趨勢，主要因為成交量放大且突破壓力」
- **詳細 (detailed)**：完整邏輯推導
  - 範例：「股價呈現上漲趨勢。從技術面來看，MACD 出現黃金交叉，顯示多頭動能增強；成交量較前一日放大50%，代表市場關注度提升；股價突破60日均線後站穩，顯示多方力量強勁。」

```typescript
explainability: {
  explainability_level: 'detailed'  // simple, medium, detailed
}
```

---

### 後端處理流程

```python
# 解釋層處理流程 (偽代碼)
def process_explainability(stock_data, config):
    # 1. 數據摘要
    if config.summarizer_enabled:
        summary = summarize_data(stock_data, config.compression_ratio)

    # 2. 數據提取
    if config.data_extractor_enabled:
        extracted = extract_fields(stock_data, config.extract_fields)

    # 3. 套用 Prompt 模板
    template = load_template(config.selected_template)
    prompt = template.format(**extracted)

    # 4. 根據可解釋性級別調整
    if config.explainability_level == 'simple':
        prompt += "\n請用一句話總結，不需解釋原因。"
    elif config.explainability_level == 'detailed':
        prompt += "\n請詳細說明每個指標的含義與推導邏輯。"

    return prompt
```

---

## 步驟四：新聞搜尋配置

### 功能說明
新聞搜尋配置決定**如何搜尋與股票相關的新聞**，並將新聞資訊整合到生成的內容中。

### 主要設定項目

#### 1. 最大新聞連結數 (max_links)
- **預設值**：5
- **建議值**：
  - 簡短內容：2-3 則
  - 深度分析：5-8 則

```typescript
news: {
  max_links: 5
}
```

---

#### 2. 搜尋關鍵字 (search_keywords)
- **關鍵字類型**：
  - `stock_name`：股票名稱（例：台積電）
  - `stock_code`：股票代號（例：2330）
  - `trigger_keyword`：觸發器相關關鍵字（例：漲停、爆量）
  - `custom`：自訂關鍵字

**前端操作**：
```typescript
news: {
  search_keywords: [
    { keyword: '{stock_name}', type: 'stock_name' },
    { keyword: '漲停', type: 'trigger_keyword' },
    { keyword: 'AI晶片', type: 'custom' }
  ]
}
```

**自動關鍵字生成**：
系統會根據觸發器類型**自動添加相關關鍵字**。

```typescript
// PostingGenerator.tsx 約 204-266 行
// 觸發器變化時自動更新關鍵字
useEffect(() => {
  switch (triggerConfig.triggerKey) {
    case 'limit_up_after_hours':
      triggerKeywords = ['漲停', '上漲', '突破', '強勢', '利多'];
      break;
    case 'limit_down_after_hours':
      triggerKeywords = ['跌停', '下跌', '重挫', '弱勢', '利空'];
      break;
    case 'intraday_volume_surge':
      triggerKeywords = ['爆量', '成交量', '量價', '異常量', '大量'];
      break;
  }
}, [triggerConfig]);
```

---

#### 3. 時間範圍 (time_range)
- **可選範圍**：
  - `d1`：過去1天
  - `d2`：過去2天
  - `w1`：過去1週
  - `m1`：過去1個月
- **建議**：
  - 突發事件：d1
  - 一般分析：d2
  - 長期追蹤：w1 或 m1

```typescript
news: {
  time_range: 'd2'
}
```

---

#### 4. 即時新聞 API 開關 (use_realtime_news_api)
- **功能**：啟用 Serper API 進行即時新聞搜尋
- **預設**：`true`
- **注意**：關閉後將使用快取的新聞資料

```typescript
news: {
  use_realtime_news_api: true
}
```

---

#### 5. 新聞連結開關 (enable_news_links)
- **功能**：在生成的內容中包含新聞連結
- **預設**：`true`
- **效果**：
  - 開啟：內容中會包含「參考新聞：[連結1][連結2]」
  - 關閉：只使用新聞內容做分析，不顯示連結

```typescript
news: {
  enable_news_links: true
}
```

---

### 後端處理流程

```python
# unified-api/main.py (偽代碼)
async def search_news(stock_code, stock_name, news_config):
    """搜尋新聞"""

    # 1. 建立搜尋查詢
    keywords = []
    for kw in news_config.search_keywords:
        if kw.type == 'stock_name':
            keywords.append(stock_name)
        elif kw.type == 'stock_code':
            keywords.append(stock_code)
        else:
            keywords.append(kw.keyword)

    query = ' '.join(keywords)

    # 2. 呼叫 Serper API
    if news_config.use_realtime_news_api:
        response = await serper_client.search(
            query=query,
            time_range=news_config.time_range,
            max_results=news_config.max_links
        )
    else:
        # 使用快取資料
        response = get_cached_news(stock_code)

    # 3. 解析結果
    news_items = []
    for item in response['news']:
        news_items.append({
            'title': item['title'],
            'snippet': item['snippet'],
            'link': item['link'],
            'date': item['date']
        })

    # 4. 生成新聞摘要
    news_summary = summarize_news(news_items)

    return {
        'news_items': news_items,
        'news_summary': news_summary
    }
```

---

### 新聞搜尋最佳實踐

| 情境 | 關鍵字策略 | 時間範圍 | 連結數 |
|------|-----------|---------|--------|
| 漲停股分析 | 股票名 + 漲停 + 利多 | d1 | 3-5 |
| 跌停股分析 | 股票名 + 跌停 + 利空 | d1 | 3-5 |
| 產業分析 | 產業名 + 趨勢 | w1 | 5-8 |
| 財報分析 | 股票名 + 財報 + EPS | d2 | 5-8 |
| 一般分析 | 股票名 | d2 | 5 |

---

## 步驟五：KOL 選擇

### 功能說明
KOL 選擇決定**由哪個 KOL 帳號來發布內容**。每個 KOL 都有獨特的寫作風格、專業領域、語氣特色。

### KOL 資料結構

每個 KOL 在資料庫中包含以下資訊：

```python
# KOL Profile 資料結構 (kol_database_service.py)
class KOLProfile:
    # 基本資訊
    serial: int                    # KOL 編號 (例: 200, 201, 202...)
    nickname: str                  # 暱稱 (例: "川川哥", "價值投資王")
    email: str                     # 登入帳號
    password: str                  # 登入密碼

    # 風格定位
    persona: str                   # 角色定位: technical, fundamental, news_driven, mixed
    expertise_areas: List[str]     # 專業領域: ['半導體', 'AI概念股']

    # 寫作風格
    tone_style: str                # 語氣風格: "自信直球，有時會狂妄"
    typing_habit: str              # 打字習慣: "不打標點.....全部用省略號串起來"
    common_terms: List[str]        # 常用術語: ['黃金交叉', '均線糾結', 'K棒爆量']
    colloquial_terms: List[str]    # 口語用詞: ['穩了啦', '爆啦', '這根要噴']

    # Prompt 設定
    prompt_persona: str            # 角色描述 (用於 GPT Prompt)
    prompt_style: str              # 風格指引
    prompt_skeleton: str           # 內容結構模板
    prompt_cta: str                # 行動呼籲模板

    # 模型設定
    model_id: str                  # GPT 模型: "gpt-4o-mini"
    model_temp: float              # 溫度: 0.5
    max_tokens: int                # 最大 token: 700
    content_length: str            # 內容長度偏好: short, medium, long
```

---

### KOL 範例：川川哥 (技術分析狂熱者)

```python
{
  "serial": 202,
  "nickname": "川川哥",
  "persona": "technical",
  "expertise_areas": ["技術分析", "短線操作", "籌碼分析"],

  "tone_style": "自信直球，有時會狂妄，對技術分析深信不疑",
  "typing_habit": "不打標點.....全部用省略號串起來.....營造急迫感",
  "common_terms": [
    "黃金交叉", "死亡交叉", "均線糾結", "量價背離",
    "K棒爆量", "突破頸線", "回測支撐"
  ],
  "colloquial_terms": [
    "穩了啦", "爆啦", "這根要噴", "完全不行",
    "我早就說了", "又被我說中了"
  ],

  "prompt_persona": """
  你是川川哥，一個技術分析的狂熱信徒。你相信所有價格都反映在線圖上，
  基本面都是事後諸葛。你說話直接、自信，有時甚至有點狂妄。
  你會用很多省略號，營造出急迫、興奮的語氣。
  """,

  "prompt_skeleton": """
  ## 標題（必須吸睛、帶有強烈態度）

  廢話不多說.....直接看線圖.....

  ## 技術面（重點，佔70%篇幅）
  - K線型態解析
  - 均線排列與糾結
  - MACD/KD/RSI 指標判讀
  - 量能變化

  ## 操作建議（簡短有力）
  我的看法是.....（明確的進場點位）

  ## 風險提醒（簡短帶過）
  當然啦.....市場有風險.....自己要控制.....
  """,

  "prompt_cta": [
    "我的看法是.....{操作建議}.....你們覺得呢.....",
    "這波我是看{方向}啦.....不信的等著看.....",
    "技術線圖都講得很清楚了.....自己判斷....."
  ],

  "model_id": "gpt-4o-mini",
  "model_temp": 0.7,  // 較高溫度，增加個性
  "max_tokens": 500,
  "content_length": "short"  // 簡短有力
}
```

**川川哥生成內容範例**：
```
【2330台積電】這根K棒很明顯了吧.....

廢話不多說.....直接看線圖.....

今天2330收590.....爆量突破.....MACD黃金交叉.....
均線多頭排列完成.....這還不進場要等到什麼時候.....

量能從昨天3萬張直接衝到5萬張.....主力資金明顯進場.....
K棒站上60日均線.....而且收盤站穩.....這根要噴了啦.....

我的看法是.....回測580不破就可以進.....目標先看620.....
停損設在570就好.....風險報酬比很划算.....

當然啦.....市場有風險.....自己要控制倉位.....
但這波我是看多啦.....不信的等著看.....

又被我技術分析說中了.....
```

---

### KOL 範例：價值投資王 (基本面深度分析)

```python
{
  "serial": 203,
  "nickname": "價值投資王",
  "persona": "fundamental",
  "expertise_areas": ["財報分析", "產業研究", "價值投資"],

  "tone_style": "專業、理性、謹慎，重視數據與邏輯推導",
  "typing_habit": "標準標點符號，段落分明，邏輯清晰",
  "common_terms": [
    "本益比", "ROE", "EPS成長率", "自由現金流",
    "護城河", "競爭優勢", "產業地位"
  ],
  "colloquial_terms": [],  // 基本面派較少用口語

  "prompt_persona": """
  你是價值投資王，專注於基本面分析與長期投資。你相信股價終將反映企業價值，
  短期波動不重要，重要的是企業的競爭優勢與獲利能力。你說話謹慎、專業，
  總是用數據與邏輯說話。
  """,

  "prompt_skeleton": """
  ## 標題（理性、專業）

  ## 公司基本面分析
  - 營運模式與競爭優勢
  - 產業地位與市場份額

  ## 財務數據解析
  - EPS、ROE、本益比
  - 營收成長率、毛利率
  - 自由現金流

  ## 估值分析
  - 合理價格區間
  - 與同業比較

  ## 投資建議
  - 適合投資人類型
  - 長期持有價值評估

  ## 風險評估（詳細）
  - 產業風險
  - 公司特定風險
  """,

  "prompt_cta": [
    "以上分析僅供參考，投資前請詳閱公司財報。",
    "建議投資人依自身風險承受能力謹慎評估。",
    "長期投資需持續追蹤公司營運狀況。"
  ],

  "model_id": "gpt-4o-mini",
  "model_temp": 0.3,  // 較低溫度，保持理性
  "max_tokens": 1000,
  "content_length": "long"  // 深度分析
}
```

---

### KOL 分配模式

#### 1. 隨機分配 (random)
- **運作方式**：從可用 KOL 中隨機選擇
- **適用情境**：不在意 KOL 風格，追求多樣性

```typescript
kol: {
  assignment_mode: 'random'
}
```

---

#### 2. 手動選擇 (manual)
- **運作方式**：使用者明確指定要使用的 KOL
- **適用情境**：需要特定風格或專業領域

```typescript
kol: {
  assignment_mode: 'manual',
  selected_kols: [202, 203]  // 川川哥、價值投資王
}
```

---

#### 3. 動態標準 (dynamic_criteria)
- **運作方式**：根據條件自動選擇最適合的 KOL
- **標準**：
  - `style_preference`：風格偏好 (aggressive, balanced, conservative)
  - `expertise_match`：專業匹配度 (high, medium, low)
  - `activity_level`：活躍度 (active, moderate, low)

```typescript
kol: {
  assignment_mode: 'dynamic',
  dynamic_criteria: {
    style_preference: 'aggressive',  // 積極風格
    expertise_match: 'high',         // 高度專業匹配
    activity_level: 'active'         // 活躍用戶
  }
}
```

**後端處理**：
```python
def allocate_kol(stock_code, trigger_type, criteria):
    """根據動態標準分配 KOL"""

    # 1. 根據觸發器類型初步篩選
    if trigger_type == 'limit_up_after_hours':
        # 漲停股 → 偏好技術派 KOL
        candidate_personas = ['technical', 'mixed']
    elif trigger_type == 'earnings_report':
        # 財報 → 偏好基本面派 KOL
        candidate_personas = ['fundamental', 'mixed']

    # 2. 根據風格偏好篩選
    if criteria.style_preference == 'aggressive':
        candidates = filter_by_tone_confidence(candidates, min_confidence=7)

    # 3. 檢查專業匹配度
    if criteria.expertise_match == 'high':
        # 檢查 KOL 的 expertise_areas 是否包含股票所屬產業
        candidates = filter_by_expertise(candidates, stock_code)

    # 4. 根據活躍度排序
    candidates = sort_by_activity_level(candidates)

    # 5. 選擇最適合的 KOL
    selected_kol = candidates[0]
    return selected_kol
```

---

### 後端 KOL 載入流程

```python
# unified-api/main.py 約 1840 行
kol_serial = int(body.get('kol_serial', 200))
kol_persona = body.get('kol_persona', 'technical')

# 從資料庫載入 KOL 設定檔
kol_profile = kol_database_service.get_kol_profile(kol_serial)

# 使用 KOL 的 Prompt 設定生成內容
gpt_result = gpt_generator.generate_stock_analysis(
    stock_id=stock_code,
    stock_name=stock_name,
    kol_profile=kol_profile,  # 傳入完整 KOL 設定
    ...
)
```

---

## 步驟六：KOL Prompt 微調

### 功能說明
在步驟五選擇 KOL 後，步驟六允許**針對這次生成任務微調 KOL 的 Prompt**，而不改變資料庫中的 KOL 設定。

### 可微調項目

#### 1. 角色描述 (Persona Prompt)
- **預設值**：來自 KOL 資料庫的 `prompt_persona`
- **微調範例**：
  - 原始：「你是川川哥，技術分析狂熱者」
  - 微調：「你是川川哥，技術分析狂熱者。**今天心情特別好，語氣更加興奮**」

```typescript
kolPrompts: {
  kol_202: {
    persona_override: "你是川川哥，技術分析狂熱者。今天心情特別好，語氣更加興奮，多用驚嘆號。"
  }
}
```

---

#### 2. 風格指引 (Style Guide)
- **微調方向**：
  - 更正式 / 更口語
  - 更簡短 / 更詳細
  - 更保守 / 更激進

```typescript
kolPrompts: {
  kol_202: {
    style_override: "今天的內容要比平常更簡短，控制在150字以內，只講重點。"
  }
}
```

---

#### 3. 內容骨架 (Content Skeleton)
- **功能**：調整內容結構
- **範例**：
  - 原始結構：技術面 70% + 操作建議 20% + 風險 10%
  - 微調結構：技術面 50% + 籌碼面 30% + 操作建議 20%

```typescript
kolPrompts: {
  kol_202: {
    skeleton_override: `
    ## 技術面 (50%)
    - K線型態
    - 均線

    ## 籌碼面 (30%)
    - 主力動向
    - 外資法人

    ## 操作建議 (20%)
    - 進場點位
    - 停損停利
    `
  }
}
```

---

#### 4. 行動呼籲 (Call-to-Action)
- **功能**：調整文章結尾的互動方式
- **範例**：
  - 原始：「你們覺得呢.....」
  - 微調：「你們覺得呢.....留言討論吧！」

```typescript
kolPrompts: {
  kol_202: {
    cta_override: "這波你們怎麼看？留言分享你的看法！"
  }
}
```

---

#### 5. Hashtag 風格
- **功能**：調整標籤使用方式
- **選項**：
  - `none`：不使用 hashtag
  - `minimal`：只用1-2個核心標籤
  - `moderate`：使用3-5個標籤
  - `abundant`：使用5個以上標籤

```typescript
kolPrompts: {
  kol_202: {
    hashtag_style: 'moderate',
    custom_hashtags: ['#技術分析', '#短線操作', '#漲停股']
  }
}
```

---

### 前端操作介面

```tsx
// KOLPromptTuner.tsx 組件
<Card title="微調 KOL Prompt">
  <Form>
    <Form.Item label="角色描述微調">
      <TextArea
        placeholder={kolProfile.prompt_persona}
        onChange={(e) => updatePromptOverride('persona', e.target.value)}
      />
    </Form.Item>

    <Form.Item label="風格指引微調">
      <TextArea
        placeholder={kolProfile.prompt_style}
        onChange={(e) => updatePromptOverride('style', e.target.value)}
      />
    </Form.Item>

    <Form.Item label="內容骨架微調">
      <TextArea
        rows={10}
        placeholder={kolProfile.prompt_skeleton}
        onChange={(e) => updatePromptOverride('skeleton', e.target.value)}
      />
    </Form.Item>

    <Form.Item label="Hashtag 風格">
      <Select
        value={hashtag_style}
        onChange={(value) => setHashtagStyle(value)}
      >
        <Option value="none">不使用</Option>
        <Option value="minimal">簡約 (1-2個)</Option>
        <Option value="moderate">適中 (3-5個)</Option>
        <Option value="abundant">豐富 (5+)</Option>
      </Select>
    </Form.Item>
  </Form>
</Card>
```

---

### 後端 Prompt 合併邏輯

```python
# GPTContentGenerator.py (偽代碼)
def build_final_prompt(kol_profile, prompt_overrides, stock_data):
    """合併原始 KOL Prompt 與微調設定"""

    # 1. 載入原始 Prompt
    base_persona = kol_profile.prompt_persona
    base_style = kol_profile.prompt_style
    base_skeleton = kol_profile.prompt_skeleton

    # 2. 套用微調 (如果有)
    if prompt_overrides.get('persona_override'):
        final_persona = prompt_overrides['persona_override']
    else:
        final_persona = base_persona

    if prompt_overrides.get('style_override'):
        final_style = base_style + "\n\n" + prompt_overrides['style_override']
    else:
        final_style = base_style

    # 3. 建立最終 Prompt
    final_prompt = f"""
    {final_persona}

    ## 寫作風格
    {final_style}

    ## 內容結構
    {base_skeleton}

    ## 股票數據
    {stock_data}

    請根據以上設定生成內容。
    """

    return final_prompt
```

---

### 微調最佳實踐

| 情境 | 建議微調項目 | 微調方向 |
|------|-------------|---------|
| 突發重大新聞 | 風格指引 | 增加緊迫感、更多驚嘆號 |
| 財報發布 | 內容骨架 | 增加財報數據段落比重 |
| 需要更多互動 | CTA | 強化提問、鼓勵留言 |
| 標題黨模式 | 角色描述 | 要求更聳動的標題 |
| 正式場合 | 風格指引 | 減少口語、增加專業術語 |

---

## 步驟七：生成設定

### 功能說明
生成設定控制**內容的整體風格、長度、分析深度**等核心參數。

### 主要設定項目

#### 1. 發文模式 (post_mode)
- **one_to_one**：1個KOL對應1檔股票
  - 範例：川川哥分析台積電
- **one_to_many**：1個KOL分析多檔股票
  - 範例：川川哥分析「今日漲停三雄：台積電、聯發科、鴻海」
- **many_to_one**：多個KOL分析同一檔股票
  - 範例：川川哥（技術面）+ 價值投資王（基本面）都分析台積電

```typescript
settings: {
  post_mode: 'one_to_one'
}
```

---

#### 2. 內容長度 (content_length)
- **short**：150-300 字
  - 適用：快速看盤、盤中即時
- **medium**：300-600 字
  - 適用：一般分析、收盤後總結
- **long**：600-1000 字
  - 適用：深度研究、財報分析

```typescript
settings: {
  content_length: 'medium',
  max_words: 500  // 更精確的字數控制
}
```

---

#### 3. 內容風格 (content_style)
- **professional**：專業理性
  - 用語：標準財經術語
  - 語氣：客觀中立
- **casual**：輕鬆口語
  - 用語：生活化比喻
  - 語氣：親切友善
- **aggressive**：積極激進
  - 用語：強烈態度詞
  - 語氣：自信果斷
- **conservative**：保守謹慎
  - 用語：保守建議詞
  - 語氣：謹慎小心

```typescript
settings: {
  content_style: 'casual'
}
```

---

#### 4. 分析深度 (include_analysis_depth)
- **brief**：簡要結論
  - 只說「看多/看空」，不解釋原因
- **medium**：適度分析
  - 說明主要原因（1-2個）
- **detailed**：深度剖析
  - 完整邏輯推導、多角度分析

```typescript
settings: {
  include_analysis_depth: 'detailed'
}
```

---

#### 5. 圖表包含 (include_charts)
- **功能**：在內容中嵌入股價圖表連結
- **預設**：`false`
- **效果**：
  - 開啟：文章包含「【圖表】點此查看技術線圖」
  - 關閉：純文字分析

```typescript
settings: {
  include_charts: true
}
```

---

#### 6. 風險警語 (include_risk_warning)
- **功能**：在文章結尾加上風險提醒
- **預設**：`true`（強烈建議保持開啟）
- **範例警語**：
  - 「以上分析僅供參考，投資有風險，請謹慎評估。」
  - 「本文不構成投資建議，投資人應自行判斷。」

```typescript
settings: {
  include_risk_warning: true
}
```

---

#### 7. 發文類型 (posting_type)
- **analysis**：分析型
  - 結構：現況分析 + 數據解讀 + 趨勢判斷
- **question**：提問型
  - 結構：提出問題 + 拋磚引玉 + 引導討論
- **opinion**：觀點型
  - 結構：明確立場 + 論述依據 + 呼籲行動
- **news**：新聞型
  - 結構：新聞摘要 + 影響分析 + 後續觀察

```typescript
settings: {
  posting_type: 'analysis'
}
```

---

#### 8. 互動元素

**包含提問 (include_questions)**
- 功能：在內容中加入提問，引導讀者互動
- 範例：「你認為台積電下週會站上600嗎？」

```typescript
settings: {
  include_questions: true
}
```

**包含 Emoji (include_emoji)**
- 功能：在內容中加入 Emoji 表情符號
- 範例：「台積電今天爆量 📈🔥 真的很強！」

```typescript
settings: {
  include_emoji: true
}
```

**包含 Hashtag (include_hashtag)**
- 功能：在內容結尾加上主題標籤
- 範例：「#台積電 #半導體 #漲停股」

```typescript
settings: {
  include_hashtag: true
}
```

---

### 後端處理邏輯

```python
# GPTContentGenerator.py (偽代碼)
def apply_generation_settings(prompt, settings):
    """根據生成設定調整 Prompt"""

    # 1. 內容長度控制
    if settings.content_length == 'short':
        prompt += f"\n\n請將內容控制在 {settings.max_words} 字以內，只講重點。"
    elif settings.content_length == 'long':
        prompt += f"\n\n請撰寫深度分析，約 {settings.max_words} 字，詳細說明邏輯。"

    # 2. 內容風格調整
    if settings.content_style == 'casual':
        prompt += "\n\n請用輕鬆、生活化的方式說明，多用比喻與口語。"
    elif settings.content_style == 'professional':
        prompt += "\n\n請用專業、客觀的語氣，使用標準財經術語。"

    # 3. 分析深度控制
    if settings.include_analysis_depth == 'brief':
        prompt += "\n\n只需給出結論，不用詳細解釋原因。"
    elif settings.include_analysis_depth == 'detailed':
        prompt += "\n\n請詳細說明推導邏輯，多角度分析。"

    # 4. 發文類型引導
    if settings.posting_type == 'question':
        prompt += "\n\n請以提問的方式開頭，引導讀者思考與討論。"
    elif settings.posting_type == 'opinion':
        prompt += "\n\n請明確表達你的觀點與立場，並說明依據。"

    # 5. 互動元素
    if settings.include_questions:
        prompt += "\n\n請在內容中加入1-2個提問，引導讀者互動。"

    if settings.include_emoji:
        prompt += "\n\n可適度使用 Emoji 表情符號增加生動性。"

    return prompt
```

---

### 生成設定組合建議

#### 情境一：盤中即時快報
```typescript
settings: {
  post_mode: 'one_to_one',
  content_length: 'short',
  max_words: 200,
  content_style: 'casual',
  include_analysis_depth: 'brief',
  posting_type: 'analysis',
  include_emoji: true,
  include_hashtag: true
}
```
**效果**：簡短、口語、快速、吸睛

---

#### 情境二：收盤深度分析
```typescript
settings: {
  post_mode: 'one_to_one',
  content_length: 'long',
  max_words: 800,
  content_style: 'professional',
  include_analysis_depth: 'detailed',
  posting_type: 'analysis',
  include_charts: true,
  include_risk_warning: true
}
```
**效果**：專業、深度、完整

---

#### 情境三：引戰互動文
```typescript
settings: {
  post_mode: 'one_to_one',
  content_length: 'medium',
  max_words: 400,
  content_style: 'aggressive',
  include_analysis_depth: 'medium',
  posting_type: 'opinion',
  include_questions: true,
  include_emoji: true
}
```
**效果**：有態度、引發討論、高互動

---

## 步驟八：標籤設定

### 功能說明
標籤（Tags）是論壇貼文的重要元素，影響**內容曝光度、可搜尋性、分類歸檔**。

### 標籤類型

#### 1. 股票標籤 (stock_tags)
- **功能**：標記文章討論的股票
- **格式**：`#股票代號` 或 `#股票名稱`
- **範例**：`#2330` `#台積電`

**自動生成模式**：
```typescript
tags: {
  tag_mode: 'stock_tags',
  stock_tags: {
    auto_generate: true,           // 自動生成
    include_stock_code: true,      // 包含股票代號
    include_stock_name: true,      // 包含股票名稱
    custom_tags: []                // 自訂額外標籤
  }
}
```

**效果**：
- 自動為「台積電 (2330)」生成標籤：`#2330` `#台積電`

**手動模式**：
```typescript
tags: {
  tag_mode: 'stock_tags',
  stock_tags: {
    auto_generate: false,
    custom_tags: ['2330', '半導體', 'AI概念股']
  }
}
```

---

#### 2. 話題標籤 (topic_tags)
- **功能**：標記文章討論的主題或趨勢
- **來源**：
  - 熱門話題 API
  - 新聞關鍵字
  - 手動輸入

**自動生成模式**（從熱門話題）：
```typescript
tags: {
  tag_mode: 'topic_tags',
  topic_tags: {
    auto_generate: true,
    trending_topics: [
      { id: 123, title: 'AI伺服器概念股爆發' }
    ],
    custom_tags: []
  }
}
```

**效果**：
- 生成標籤：`#AI伺服器概念股` `#伺服器` `#AI`

---

#### 3. 批次共享標籤 (batch_shared_tags)
- **功能**：同一批次生成的所有貼文共用相同標籤
- **使用時機**：
  - 系列文章（例：「今日漲停三雄」）
  - 特定主題（例：「本週財報績優股」）

**啟用方式**：
```typescript
tags: {
  stock_tags: {
    batch_shared_tags: true  // 啟用批次共享
  }
}
```

**效果**：
- 文章A（台積電）：`#2330` `#今日漲停股` `#盤後分析`
- 文章B（聯發科）：`#2454` `#今日漲停股` `#盤後分析`
- **共享**：`#今日漲停股` `#盤後分析`

---

#### 4. 商品標籤 (commodity_tags)
- **功能**：CMoney 平台的結構化標籤
- **格式**：JSON 物件
- **用途**：分類、推薦演算法、數據分析

```typescript
commodity_tags: [
  { type: "Market", key: "TWA00", bullOrBear: 0 },      // 大盤
  { type: "Stock", key: "2330", bullOrBear: 1 },        // 台積電 (看多)
  { type: "Industry", key: "半導體", bullOrBear: 1 }     // 半導體產業 (看多)
]
```

**bullOrBear 說明**：
- `1`：看多 (Bullish)
- `0`：中性 (Neutral)
- `-1`：看空 (Bearish)

---

### 標籤數量限制

```typescript
tags: {
  max_tags_per_post: 5  // 每篇文章最多5個標籤
}
```

**建議**：
- 最少：2-3 個（保證可搜尋性）
- 最多：5-7 個（避免看起來像垃圾訊息）

---

### 後端標籤生成邏輯

```python
# unified-api/main.py 約 1943-1946 行
def generate_commodity_tags(stock_code, trigger_type, bull_or_bear):
    """生成商品標籤"""

    tags = [
        {"type": "Market", "key": "TWA00", "bullOrBear": 0}  # 大盤（預設中性）
    ]

    # 添加股票標籤
    tags.append({
        "type": "Stock",
        "key": stock_code,
        "bullOrBear": bull_or_bear  # 根據觸發器判斷多空
    })

    # 根據觸發器添加產業標籤
    if trigger_type == 'limit_up_after_hours':
        tags.append({
            "type": "Topic",
            "key": "漲停股",
            "bullOrBear": 1  # 漲停股預設看多
        })

    return tags

# 儲存到資料庫
commodity_tags_json = json.dumps(commodity_tags_data, ensure_ascii=False)
```

---

### 標籤策略建議

| 目標 | 標籤策略 | 範例 |
|------|---------|------|
| 最大曝光度 | 股票名 + 熱門話題 + 產業 | `#台積電` `#AI概念股` `#半導體` |
| 精準受眾 | 股票代號 + 技術指標 | `#2330` `#黃金交叉` `#突破` |
| 引發討論 | 話題性標籤 + 提問 | `#漲停股` `#你怎麼看` |
| 系列文章 | 批次共享標籤 | `#本週漲停王` `#盤後分析` |

---

## 步驟九：批量模式設定

### 功能說明
批量模式控制**如何一次生成多篇貼文**，包括生成策略、品質控制、審核流程。

### 主要設定項目

#### 1. 批次類型 (batch_type)
- **test_mode**：測試模式
  - 不發布到正式論壇
  - 資料庫標記為 `status: 'draft'`
  - 用於驗證內容品質
- **production**：正式模式
  - 通過審核後可直接發布
  - 計入發文統計

```typescript
batchMode: {
  batch_type: 'test_mode'
}
```

---

#### 2. 批次上限 (max_posts_per_batch)
- **功能**：限制單次生成的貼文數量
- **預設值**：10
- **建議值**：
  - 測試模式：5-10 篇
  - 正式模式：10-50 篇
  - 大量生成：50-100 篇

```typescript
batchMode: {
  max_posts_per_batch: 10
}
```

---

#### 3. 生成策略 (generation_strategy)

**one_kol_one_stock**：1個KOL對應1檔股票
```typescript
batchMode: {
  generation_strategy: 'one_kol_one_stock'
}
```
**效果**：
- 股票A（台積電）→ KOL 202（川川哥）→ 1篇文章
- 股票B（聯發科）→ KOL 203（價值投資王）→ 1篇文章
- **總共**：2檔股票 = 2篇文章

---

**multi_kol_one_stock**：多個KOL分析同一檔股票
```typescript
batchMode: {
  generation_strategy: 'multi_kol_one_stock',
  kols_per_stock: 3
}
```
**效果**：
- 股票A（台積電）→ KOL 202, 203, 204 → 3篇文章（不同角度）
- **總共**：1檔股票 = 3篇文章

---

**one_kol_multi_stock**：1個KOL分析多檔股票
```typescript
batchMode: {
  generation_strategy: 'one_kol_multi_stock',
  stocks_per_post: 3
}
```
**效果**：
- KOL 202（川川哥）→ 文章標題：「今日漲停三雄：台積電、聯發科、鴻海」
- **總共**：3檔股票 = 1篇文章

---

#### 4. 審核機制 (review_required)
- **true**：生成後需人工審核才能發布
  - 資料庫 `status: 'draft'` → 審核通過 → `status: 'approved'`
- **false**：生成後自動標記為已審核
  - 資料庫 `status: 'approved'`（但仍需手動點擊發布）

```typescript
batchMode: {
  review_required: true
}
```

---

#### 5. 自動通過門檻 (auto_approve_threshold)
- **功能**：品質分數達標自動通過審核
- **範圍**：0.0 - 1.0
- **建議值**：
  - 嚴格：0.9
  - 一般：0.8
  - 寬鬆：0.7

```typescript
batchMode: {
  auto_approve_threshold: 0.8
}
```

**後端邏輯**：
```python
# 計算內容品質分數
quality_score = calculate_quality_score(content)

# 自動審核判斷
if quality_score >= auto_approve_threshold:
    status = 'approved'
else:
    status = 'draft'  # 需人工審核
```

---

#### 6. 發布延遲 (publish_delay_minutes)
- **功能**：每篇貼文之間的發布間隔
- **目的**：避免被平台判定為洗版
- **建議值**：
  - 測試環境：0-1 分鐘
  - 正式環境：5-10 分鐘

```typescript
batchMode: {
  publish_delay_minutes: 5
}
```

---

#### 7. 品質檢查 (quality_check_enabled)
- **功能**：啟用內容品質自動檢查
- **檢查項目**：
  - 內容長度是否符合要求
  - 是否包含禁用詞彙
  - 邏輯是否連貫
  - 數據引用是否正確

```typescript
batchMode: {
  quality_check_enabled: true
}
```

**後端檢查邏輯**：
```python
# ContentQualityChecker.py (偽代碼)
def check_quality(content, settings):
    score = 1.0
    issues = []

    # 1. 長度檢查
    word_count = len(content)
    if word_count < settings.min_words:
        score -= 0.2
        issues.append(f"內容過短：{word_count} 字 (最少 {settings.min_words} 字)")

    # 2. 禁用詞檢查
    banned_words = ['保證獲利', '穩賺不賠', '內線消息']
    for word in banned_words:
        if word in content:
            score -= 0.3
            issues.append(f"包含禁用詞：{word}")

    # 3. 邏輯連貫性檢查
    coherence_score = check_coherence(content)
    score *= coherence_score

    # 4. 數據引用檢查
    if not has_data_citation(content):
        score -= 0.1
        issues.append("缺少數據引用")

    return {
        'quality_score': score,
        'issues': issues,
        'pass': score >= 0.7
    }
```

---

#### 8. AI 檢測 (ai_detection_enabled)
- **功能**：檢測內容是否過於「AI 味」
- **檢測指標**：
  - 用詞重複率
  - 句式單調性
  - 缺乏個性化元素

```typescript
batchMode: {
  ai_detection_enabled: true
}
```

**後端檢測**：
```python
def detect_ai_generated(content):
    """檢測 AI 生成痕跡"""

    ai_score = 0.0

    # 1. 檢查常見 AI 用語
    ai_phrases = [
        '綜合來看', '總的來說', '從數據來看',
        '值得注意的是', '需要指出的是'
    ]
    ai_phrase_count = sum(1 for phrase in ai_phrases if phrase in content)
    ai_score += ai_phrase_count * 0.1

    # 2. 檢查句式重複
    sentences = split_sentences(content)
    similarity_matrix = calculate_sentence_similarity(sentences)
    avg_similarity = similarity_matrix.mean()
    if avg_similarity > 0.7:
        ai_score += 0.3

    # 3. 檢查個性化元素（省略號、驚嘆號、口語等）
    personality_markers = count_personality_markers(content)
    if personality_markers < 3:
        ai_score += 0.2

    return min(ai_score, 1.0)
```

---

#### 9. 生成模式 (generation_mode)
- **high_quality**：高品質模式
  - 溫度：0.3-0.5（較低，更穩定）
  - 重試次數：3次
  - 品質門檻：0.8
- **balanced**：平衡模式
  - 溫度：0.5-0.7
  - 重試次數：2次
  - 品質門檻：0.7
- **fast**：快速模式
  - 溫度：0.7-0.9（較高，更多變）
  - 重試次數：1次
  - 品質門檻：0.6

```typescript
batchMode: {
  generation_mode: 'high_quality'
}
```

---

### 批量生成完整流程

```python
# unified-api/main.py (偽代碼)
async def batch_generate_posts(config):
    """批量生成貼文"""

    session_id = generate_session_id()
    posts = []

    # 1. 根據觸發器取得股票清單
    stock_list = execute_trigger(config.triggers)

    # 2. 限制批次數量
    stock_list = stock_list[:config.batchMode.max_posts_per_batch]

    # 3. 根據生成策略決定 KOL 分配
    if config.batchMode.generation_strategy == 'one_kol_one_stock':
        for stock in stock_list:
            kol = allocate_kol(stock, config.kol)
            post = await generate_single_post(stock, kol, config)

            # 4. 品質檢查
            if config.batchMode.quality_check_enabled:
                quality_result = check_quality(post.content, config)
                post.quality_score = quality_result['quality_score']

            # 5. AI 檢測
            if config.batchMode.ai_detection_enabled:
                post.ai_detection_score = detect_ai_generated(post.content)

            # 6. 自動審核
            if post.quality_score >= config.batchMode.auto_approve_threshold:
                post.status = 'approved'
            else:
                post.status = 'draft'

            # 7. 儲存到資料庫
            save_post_to_db(post, session_id)
            posts.append(post)

            # 8. 發布延遲
            await asyncio.sleep(config.batchMode.publish_delay_minutes * 60)

    return {
        'success': True,
        'session_id': session_id,
        'posts': posts,
        'count': len(posts)
    }
```

---

### 批量模式最佳實踐

#### 情境一：盤後快速發布（10檔漲停股）
```typescript
batchMode: {
  batch_type: 'production',
  max_posts_per_batch: 10,
  generation_strategy: 'one_kol_one_stock',
  review_required: false,              // 不需審核
  auto_approve_threshold: 0.7,         // 較低門檻
  publish_delay_minutes: 3,            // 短延遲
  quality_check_enabled: true,
  ai_detection_enabled: false,         // 關閉（省時間）
  generation_mode: 'fast'
}
```
**特色**：快速、自動、大量

---

#### 情境二：高品質深度分析（3檔精選股）
```typescript
batchMode: {
  batch_type: 'production',
  max_posts_per_batch: 3,
  generation_strategy: 'multi_kol_one_stock',  // 多角度分析
  kols_per_stock: 3,
  review_required: true,               // 需人工審核
  auto_approve_threshold: 0.9,         // 高門檻
  publish_delay_minutes: 10,           // 長延遲
  quality_check_enabled: true,
  ai_detection_enabled: true,
  generation_mode: 'high_quality'
}
```
**特色**：精品、多角度、嚴格品控

---

#### 情境三：測試新 KOL 風格
```typescript
batchMode: {
  batch_type: 'test_mode',             // 測試模式
  max_posts_per_batch: 5,
  generation_strategy: 'one_kol_one_stock',
  review_required: true,
  quality_check_enabled: true,
  ai_detection_enabled: true,
  generation_mode: 'balanced'
}
```
**特色**：安全、可驗證、不影響正式環境

---

## 後端處理流程

### 完整生成流程圖

```
[前端提交請求]
    ↓
[後端接收請求] POST /api/manual-posting
    ↓
[步驟1] 解析請求參數
    ├─ stock_code, stock_name
    ├─ kol_serial, kol_persona
    ├─ trigger_type
    └─ posting_type, max_words
    ↓
[步驟2] 執行觸發器邏輯
    ├─ 根據 trigger_type 取得股票清單
    ├─ 篩選條件（量能、漲幅等）
    └─ 回傳 stock_codes[]
    ↓
[步驟3] 數據收集（並行）
    ├─ OHLC API → 股價技術數據
    ├─ Summary API → 數據摘要
    ├─ Serper API → 新聞搜尋
    ├─ Revenue API → 營收數據
    └─ Financial API → 財務數據
    ↓
[步驟4] 載入 KOL 設定檔
    ├─ 從 PostgreSQL 載入 kol_profile
    ├─ 包含：persona, tone_style, prompt_persona...
    └─ 合併 prompt_overrides（如有微調）
    ↓
[步驟5] 建立動態 Prompt
    ├─ 系統 Prompt (角色定位)
    │   └─ "你是 {kol_nickname}，{persona} 風格的分析師..."
    ├─ 數據 Prompt (股票數據)
    │   └─ "股票代號: {stock_code}, 收盤價: {close_price}..."
    ├─ 風格 Prompt (寫作風格)
    │   └─ "語氣：{tone_style}, 打字習慣：{typing_habit}..."
    └─ 設定 Prompt (生成設定)
        └─ "內容長度：{max_words} 字，風格：{content_style}..."
    ↓
[步驟6] 呼叫 OpenAI API
    ├─ Model: gpt-4o-mini
    ├─ Temperature: {kol_profile.model_temp}
    ├─ Max Tokens: {kol_profile.max_tokens}
    └─ Messages: [system_prompt, user_prompt]
    ↓
[步驟7] 後處理生成內容
    ├─ 提取標題與內容
    ├─ 移除多餘 Hashtag（後續由標籤設定處理）
    ├─ 長度驗證與調整
    └─ 品質檢查
    ↓
[步驟8] 個人化處理（可選）
    ├─ 如果 posting_type == 'personalized'
    ├─ 呼叫 PersonalizationModule
    ├─ 生成 3-5 個替代版本
    └─ 儲存到 alternative_versions
    ↓
[步驟9] 儲存到資料庫
    ├─ 生成 post_id (UUID)
    ├─ 生成 commodity_tags
    ├─ 儲存 generation_params
    └─ INSERT INTO post_records
        ├─ status: 'draft'
        ├─ session_id: {session_id}
        └─ trigger_type: {trigger_type}
    ↓
[步驟10] 回傳前端
    └─ { success: true, post_id, content: {...} }
```

---

### 關鍵程式碼位置

| 功能 | 檔案路徑 | 行數範圍 |
|------|---------|---------|
| 手動發文 API | `/apps/unified-api/main.py` | 1827-2058 |
| GPT 內容生成 | `/apps/posting-service/gpt_content_generator.py` | - |
| 個人化處理 | `/apps/posting-service/personalization_module.py` | - |
| KOL 資料管理 | `/apps/posting-service/kol_database_service.py` | - |
| 資料庫表結構 | `/apps/unified-api/main.py` | 96-176 |

---

## 發布與審核流程

### 審核頁面 (PostReviewPage)

**功能**：
1. 查看生成的貼文
2. 切換替代版本
3. 手動編輯內容
4. 審核通過 / 拒絕
5. 發布到論壇

**API 查詢**：
```typescript
// 查詢指定 session 的所有貼文
GET /posts/session/{session_id}

// 回應範例
{
  "posts": [
    {
      "post_id": "uuid-1234",
      "stock_code": "2330",
      "stock_name": "台積電",
      "title": "台積電爆量突破.....這根要噴了啦.....",
      "content": "...",
      "status": "draft",
      "quality_score": 0.85,
      "alternative_versions": [...]
    }
  ]
}
```

---

### 審核通過

```typescript
// 審核通過 API
POST /posts/{post_id}/approve

// Request Body
{
  "approved_by": "reviewer_123",
  "reviewer_notes": "內容品質良好，可發布"
}

// 後端更新
UPDATE post_records
SET status = 'approved',
    approved_by = 'reviewer_123',
    approved_at = NOW(),
    reviewer_notes = '...'
WHERE post_id = 'uuid-1234';
```

---

### 發布到論壇

**發布流程**：
```
[1] 使用者點擊「發布」
    ↓
[2] 前端呼叫 POST /posts/{post_id}/publish
    ↓
[3] 後端載入 KOL 帳號資訊
    ├─ email, password
    └─ 從 kol_profiles 表
    ↓
[4] 登入 CMoney 平台
    ├─ CMoneyClient.login(email, password)
    └─ 取得 auth_token
    ↓
[5] 發布貼文
    ├─ CMoneyClient.create_post({
    │     title,
    │     content,
    │     commodity_tags
    │   })
    └─ 回傳 cmoney_post_id, cmoney_post_url
    ↓
[6] 更新資料庫
    └─ UPDATE post_records SET
        status = 'published',
        published_at = NOW(),
        cmoney_post_id = '...',
        cmoney_post_url = '...'
    ↓
[7] 同步到 Google Sheets（可選）
    └─ SheetsClient.update_post_record(post)
    ↓
[8] 回傳前端成功訊息
```

---

### 發布失敗處理

```python
try:
    # 嘗試發布
    result = cmoney_client.create_post(post_data)
except Exception as e:
    # 記錄錯誤
    UPDATE post_records
    SET status = 'publish_failed',
        publish_error = str(e)
    WHERE post_id = post_id

    # 回傳錯誤訊息給前端
    return {
        'success': False,
        'error': str(e),
        'message': '發布失敗，請檢查 KOL 帳號狀態'
    }
```

---

## 總結與最佳實踐

### 完整操作流程回顧

1. **步驟一**：選擇觸發器 → 決定要分析哪些股票
2. **步驟二**：配置數據源 → 決定使用哪些數據 API
3. **步驟三**：設定解釋層 → 決定如何解讀數據
4. **步驟四**：配置新聞搜尋 → 決定新聞來源與範圍
5. **步驟五**：選擇 KOL → 決定由誰發文
6. **步驟六**：微調 Prompt → 針對此次任務調整風格
7. **步驟七**：生成設定 → 決定內容長度、風格、深度
8. **步驟八**：標籤設定 → 決定文章標籤
9. **步驟九**：批量模式 → 決定批量策略與品質控制
10. **生成內容** → 後端處理並儲存
11. **審核** → 人工檢查與修改
12. **發布** → 發布到論壇

---

### 常見使用情境範本

#### 【情境一】盤後快速發布漲停股（追求速度）

```typescript
{
  triggers: { trigger_type: 'limit_up_after_hours_high_volume' },
  dataSources: { ohlc_api: true, serper_api: true },
  news: { time_range: 'd1', max_links: 3 },
  kol: { assignment_mode: 'random' },
  settings: {
    content_length: 'short',
    max_words: 200,
    posting_type: 'analysis'
  },
  batchMode: {
    batch_type: 'production',
    max_posts_per_batch: 10,
    generation_strategy: 'one_kol_one_stock',
    review_required: false,
    generation_mode: 'fast'
  }
}
```

---

#### 【情境二】深度財報分析（追求品質）

```typescript
{
  triggers: { trigger_type: 'earnings_report' },
  dataSources: {
    financial_api: true,
    revenue_api: true,
    fundamental_api: true
  },
  kol: {
    assignment_mode: 'manual',
    selected_kols: [203]  // 價值投資王
  },
  settings: {
    content_length: 'long',
    max_words: 800,
    content_style: 'professional',
    include_analysis_depth: 'detailed',
    posting_type: 'analysis'
  },
  batchMode: {
    batch_type: 'production',
    max_posts_per_batch: 3,
    review_required: true,
    generation_mode: 'high_quality'
  }
}
```

---

#### 【情境三】熱門話題蹭流量（追求互動）

```typescript
{
  triggers: {
    trigger_type: 'trending_topics',
    selectedTopics: [...]
  },
  dataSources: { serper_api: true, trending_api: true },
  news: { time_range: 'd1', max_links: 5 },
  kol: { assignment_mode: 'dynamic', style_preference: 'aggressive' },
  settings: {
    content_length: 'medium',
    content_style: 'casual',
    posting_type: 'opinion',
    include_questions: true,
    include_emoji: true
  },
  tags: {
    topic_tags: { auto_generate: true }
  },
  batchMode: {
    batch_type: 'production',
    generation_strategy: 'one_kol_one_stock'
  }
}
```

---

### 系統優勢總結

1. **高度模組化**：九步驟各司其職，清晰明確
2. **深度個性化**：每個 KOL 都有獨特風格
3. **智能數據整合**：多源數據自動組合
4. **靈活品質控制**：多層品質檢查機制
5. **完整審核流程**：草稿 → 審核 → 發布
6. **批量高效處理**：支援大批量自動化生成

---

### 注意事項

1. **API Key 管理**：確保所有 API Key 正確配置在環境變數中
2. **KOL 帳號安全**：定期更新密碼，避免帳號被封
3. **發布頻率控制**：避免短時間內大量發文被判定為洗版
4. **內容合規性**：避免使用「保證獲利」等違規詞彙
5. **數據引用正確性**：確保引用的數據真實有效
6. **風險警語**：所有投資建議都應包含風險提醒

---

### 系統限制與已知問題

1. **GPT API 限流**：單位時間內請求次數有限制
2. **CMoney 平台限制**：部分帳號有發文頻率限制
3. **新聞搜尋時效性**：Serper API 可能有延遲
4. **KOL 風格一致性**：需定期調整 Prompt 維持風格

---

### 未來改進方向

1. **語音內容生成**：支援語音版本的股票分析
2. **圖表自動生成**：自動生成技術線圖並嵌入文章
3. **互動數據追蹤**：追蹤每篇文章的點閱、留言、按讚數
4. **A/B 測試**：同一股票生成多種風格，比較成效
5. **智能排程**：根據流量高峰自動安排發布時間

---

## 附錄

### A. API 端點速查表

| 端點 | 方法 | 功能 | 參數 |
|------|------|------|------|
| `/api/manual-posting` | POST | 手動發文 | stock_code, kol_serial, ... |
| `/api/simple-mode/generate-batch` | POST | 批量生成 | triggers, dataSources, ... |
| `/posts/session/{session_id}` | GET | 查詢 session 貼文 | session_id |
| `/posts/{post_id}/approve` | POST | 審核通過 | approved_by, notes |
| `/posts/{post_id}/publish` | POST | 發布到論壇 | post_id |
| `/api/database/test` | GET | 測試資料庫連接 | - |

---

### B. 資料庫結構

**post_records 表結構**：
```sql
CREATE TABLE post_records (
    post_id VARCHAR PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_id BIGINT,
    kol_serial INTEGER NOT NULL,
    kol_nickname VARCHAR NOT NULL,
    kol_persona VARCHAR,
    stock_code VARCHAR NOT NULL,
    stock_name VARCHAR NOT NULL,
    title VARCHAR NOT NULL,
    content TEXT NOT NULL,
    content_md TEXT,
    status VARCHAR DEFAULT 'draft',  -- draft, approved, published, publish_failed
    reviewer_notes TEXT,
    approved_by VARCHAR,
    approved_at TIMESTAMP,
    scheduled_at TIMESTAMP,
    published_at TIMESTAMP,
    cmoney_post_id VARCHAR,
    cmoney_post_url VARCHAR,
    publish_error TEXT,
    views BIGINT DEFAULT 0,
    likes BIGINT DEFAULT 0,
    comments BIGINT DEFAULT 0,
    shares BIGINT DEFAULT 0,
    topic_id VARCHAR,
    topic_title VARCHAR,
    technical_analysis TEXT,
    serper_data TEXT,
    quality_score FLOAT,
    ai_detection_score FLOAT,
    risk_level VARCHAR,
    generation_params TEXT,
    commodity_tags TEXT,
    alternative_versions TEXT,
    trigger_type VARCHAR
);
```

---

### C. 環境變數清單

```bash
# FinLab API
FINLAB_API_KEY=your_finlab_api_key

# OpenAI
OPENAI_API_KEY=your_openai_api_key

# PostgreSQL
DATABASE_URL=postgresql://user:password@host:5432/dbname

# CMoney KOL 帳號 (範例)
FORUM_200_EMAIL=kol200@example.com
FORUM_200_PASSWORD=password200

# Serper API (新聞搜尋)
SERPER_API_KEY=your_serper_api_key

# Railway 部署
PORT=8000
```

---

**文件版本**：v1.0
**最後更新**：2025-10-20
**作者**：Claude Code
**聯絡方式**：請透過 GitHub Issues 回報問題
